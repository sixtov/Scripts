
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>parse_APM_XML</title><meta name="generator" content="MATLAB 8.2"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2014-08-01"><meta name="DC.source" content="parse_APM_XML.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, tt, code { font-size:12px; }
pre { margin:0px 0px 20px; }
pre.error { color:red; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">XML File Parse</a></li><li><a href="#3">Generate MATLab Script based on XML data</a></li><li><a href="#7">name member</a></li><li><a href="#8">byte member</a></li><li><a href="#9">type member</a></li><li><a href="#11">Generate Java Code based on XML data</a></li><li><a href="#14">initialization</a></li><li><a href="#15">Generate function header</a></li><li><a href="#16">packetSize = sum(cell2mat(Mess(i).fields.matByte));</a></li><li><a href="#17">specialFunction = ~isempty(intersect(ID,specialHandlingIDs));</a></li><li><a href="#18">Do MavLink to java types substitution</a></li><li><a href="#19">Max name and type lengths</a></li><li><a href="#20">Function Header</a></li><li><a href="#21">Declare member variables</a></li><li><a href="#22">Constructor</a></li><li><a href="#23">Copy Constructor</a></li><li><a href="#24">First Parse Function</a></li><li><a href="#25">Second Parse Function</a></li><li><a href="#26">Begin parsing from array</a></li><li><a href="#27">define MavLink member lengths (in bytes)</a></li><li><a href="#28">define java variable lengths (in bytes)</a></li><li><a href="#29">Close function</a></li><li><a href="#30">Now begins the FIRST encode section</a></li><li><a href="#31">Now begins the optional SECOND encode section</a></li><li><a href="#32">Now begins the THIRD encode section</a></li><li><a href="#33">Body of encode function</a></li><li><a href="#34">define MavLink member lengths (in bytes)</a></li><li><a href="#35">define java variable lengths (in bytes)</a></li><li><a href="#36">Loggable</a></li><li><a href="#38">Generate the MavLink Class</a></li><li><a href="#39">Max name and type lengths</a></li><li><a href="#41">Init function</a></li><li><a href="#42">List All Messages, All parameters</a></li><li><a href="#44">Header Object</a></li><li><a href="#45">Generate Message Length Array</a></li><li><a href="#48">Contruct Header from byte[].</a></li><li><a href="#49">Usually implies that a packet is being RECEIVED!</a></li><li><a href="#50">Contruct a Header for a Message with ID "mid"</a></li><li><a href="#51">Usually implies constructing a packet to be SENT!</a></li><li><a href="#52">Identifies a valid RECEIVED header</a></li><li><a href="#54">Returns the header as a byte array</a></li><li><a href="#56">MavLink CheckSum Class</a></li><li><a href="#57">Generate APM Code based on XML data</a></li><li><a href="#60">initialization</a></li><li><a href="#61">Generate function header</a></li><li><a href="#63">Message Length Array</a></li><li><a href="#64">Do MavLink to APM types substitution</a></li><li><a href="#65">Function Header</a></li><li><a href="#66">define structure for message</a></li><li><a href="#67">define Message Length</a></li><li><a href="#68">define CRC Message Length</a></li><li><a href="#69">define Message INFO structure</a></li><li><a href="#70">Function Header - mavlink_msg_xxx_pack</a></li><li><a href="#71">Function Declaration</a></li><li><a href="#72">Function Body</a></li><li><a href="#73">Function Header - mavlink_msg_xxx_pack_chan</a></li><li><a href="#74">Function Declaration</a></li><li><a href="#75">Function Body</a></li><li><a href="#76">Function Header - mavlink_msg_xxx_encode</a></li><li><a href="#77">Function Declaration</a></li><li><a href="#78">Function Body</a></li><li><a href="#79">Function Header - mavlink_msg_xxx_encode_chan</a></li><li><a href="#81">Function Declaration</a></li><li><a href="#82">Function Body</a></li><li><a href="#84">Function Header - mavlink_msg_xxx_send</a></li><li><a href="#85">Function Declaration</a></li><li><a href="#86">Function Body</a></li><li><a href="#87">Function Header - MESSAGE xxx UNPACKING</a></li><li><a href="#88">Function Header - mavlink_msg_xxx_decode</a></li><li><a href="#89">Function End</a></li><li><a href="#92">End Messages</a></li><li><a href="#93">Create supporting files</a></li><li><a href="#94">Include file Array</a></li><li><a href="#95">File to contain list mavlink message include files</a></li><li><a href="#96">Generate GroundStation Code based on XML data</a></li><li><a href="#99">Generate Message Length Array</a></li><li><a href="#102">Message Length Array</a></li><li><a href="#103">Do MavLink to APM types substitution</a></li><li><a href="#104">Function Header</a></li><li><a href="#121">debug statement to show declaration of arrays</a></li></ul></div><h2>XML File Parse<a name="1"></a></h2><pre class="codeinput"><span class="keyword">function</span> parse_APM_XML()
</pre><pre class="codeinput">    <span class="keyword">global</span> SWAP;
    SWAP = 0;       <span class="comment">% SWAP=0; don't swap mavlink message parameters</span>
                    <span class="comment">% SWAP=1; swap mavlink message parameters as</span>
                    <span class="comment">%         recommended by the MavLink protocol.</span>
                    <span class="comment">%         where the fields in a message are sorted</span>
                    <span class="comment">%         in descending order according to the size</span>
                    <span class="comment">%         (in bytes) of their type. e.g. uint32's will</span>
                    <span class="comment">%         be sorted before int16's or int8's. fields of</span>
                    <span class="comment">%         the same size will maintain their order.</span>

    <span class="keyword">global</span> LOCAL;
    LOCAL = 1;      <span class="comment">% LOCAL=1; Java code doesn't include the StratWay import libraries</span>
                    <span class="comment">% LOCAL=0; Java code does include the StratWay import libraries</span>

    <span class="keyword">global</span> VERSION;
    VERSION = 0.9;  <span class="comment">% VERSION=0.9; Use MavLink verion 0.9</span>
                    <span class="comment">% VERSION=1.0; Use MavLink versio 1.0</span>

    Mess = [parseXML(<span class="string">'slvMessage.xml'</span>); parseXML(<span class="string">'common_APM_2.27.xml'</span>); parseXML(<span class="string">'ardupilotmega_APM_2.27.xml'</span>)];
    <span class="keyword">if</span> (~isempty(Mess))
        <span class="comment">% Generates MavLink 0.9 code</span>
        VERSION = 0.9;
        genScript(Mess);
        genJavaCode(Mess);
        genAPMCode(Mess);
        genGSCode(Mess);
        disp(<span class="string">' '</span>);
    <span class="keyword">end</span>

    <span class="comment">%Mess = [parseXML('slvMessage.xml'); parseXML('common_MAVLINK_1.0.xml'); parseXML('ardupilotmega_MAVLINK_1.0.xml')];</span>
    Mess = [parseXML(<span class="string">'MavLink1.0_common.xml'</span>); parseXML(<span class="string">'MavLink1.0_ardupilotmega.xml'</span>)];
    <span class="keyword">if</span> (~isempty(Mess))
        <span class="comment">% Generates MavLink 1.0 code</span>
        VERSION = 1.0;
        genScript(Mess);
        genJavaCode(Mess);
        genAPMCode(Mess);
        genGSCode(Mess);
        disp(<span class="string">' '</span>);
    <span class="keyword">end</span>

<span class="keyword">return</span>
</pre><h2>Generate MATLab Script based on XML data<a name="3"></a></h2><pre class="codeinput"><span class="keyword">function</span> genScript(Mess)
</pre><pre class="codeinput">    <span class="keyword">global</span> SWAP;
    <span class="keyword">global</span> VERSION;
    <span class="keyword">if</span> (SWAP)
        disp(<span class="string">'Offset SWAPPING'</span>)
    <span class="keyword">end</span>
    <span class="keyword">switch</span> (VERSION)
        <span class="keyword">case</span> 0.9
            <span class="comment">%fp = fopen('parseMavLinkPacket_APM_2_23.m','w');</span>
            fp = fopen(<span class="string">'parseMavLink_0_9_Packet.m'</span>,<span class="string">'w'</span>);
            fprintf(fp,<span class="string">'function S = parseMavLink_0_9_Packet(S,p)\n'</span>);
        <span class="keyword">case</span> 1.0
            fp = fopen(<span class="string">'parseMavLink_1_0_Packet.m'</span>,<span class="string">'w'</span>);
            fprintf(fp,<span class="string">'function S = parseMavLink_1_0_Packet(S,p)\n'</span>);
        <span class="keyword">otherwise</span>
            disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
            <span class="keyword">return</span>
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'\tswitch(p.messid)\n'</span>);
    K = length(Mess);
    <span class="keyword">for</span> i=1:K
        fprintf(fp,sprintf(<span class="string">'\t\tcase %s\n'</span>,Mess(i).id));
        fprintf(fp,sprintf(<span class="string">'%s'</span>,Mess(i).cdesc));
        fprintf(fp,sprintf(<span class="string">'\t\t\tS.%s = parse_%s(S.%s,p);\n'</span>,Mess(i).name,Mess(i).name,Mess(i).name));
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'\t\totherwise\n'</span>);
    fprintf(fp,<span class="string">'\t\t\tdisp(sprintf(''Unknown Message: id[%%d]'',p.messid))\n'</span>);
    fprintf(fp,<span class="string">'\tend\n'</span>);
    fprintf(fp,<span class="string">'return\n'</span>);
    <span class="keyword">for</span> i=1:K
</pre><pre class="codeinput">        fprintf(fp,<span class="string">'\n'</span>);
        fprintf(fp,sprintf(<span class="string">'%%%%%%%%  case: %s\n'</span>,Mess(i).id));
        fprintf(fp,sprintf(<span class="string">'%s'</span>,Mess(i).fdesc));
        fprintf(fp,sprintf(<span class="string">'function S = parse_%s(S,p)\n'</span>,Mess(i).name));
        N = size(Mess(i).fields.name,1);
</pre><h2>name member<a name="7"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\tname = [ ...\n'</span>);
        ml = 0;
        <span class="keyword">for</span> j=1:N
            ml = max([ml length(Mess(i).fields.name{j})]);
        <span class="keyword">end</span>
        ml = 4*ceil(ml/4);

        <span class="keyword">for</span> j=1:N
            padL = ceil((ml-length(Mess(i).fields.name{j}))/4);
            pad = char(9*ones(1,padL));
            fprintf(fp,sprintf(<span class="string">'\t\t{''%s''}%s ... '</span>,Mess(i).fields.name{j},pad));
            <span class="keyword">if</span> ~isempty(Mess(i).fields.desc{j})
                fprintf(fp,<span class="string">'%%%% '</span>);
                fprintf(fp,Mess(i).fields.desc{j});
            <span class="keyword">end</span>
            fprintf(fp,<span class="string">'\n'</span>);
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'\t\t];\n'</span>);

<span class="comment">%         %% byte member</span>
<span class="comment">%         fprintf(fp,'\tbyte = [ ...\n');</span>
<span class="comment">%         for j=1:N</span>
<span class="comment">%             fprintf(fp,sprintf('\t\t%d ...\n',Mess(i).fields.matByte{j}));</span>
<span class="comment">%         end</span>
<span class="comment">%         fprintf(fp,'\t\t];\n');</span>
<span class="comment">%</span>
<span class="comment">%         %% type member</span>
<span class="comment">%         fprintf(fp,'\ttype = [ ...\n');</span>
<span class="comment">%         for j=1:N</span>
<span class="comment">%             fprintf(fp,sprintf('\t\t{''%s''} ...\n',Mess(i).fields.matType{j}));</span>
<span class="comment">%         end</span>
<span class="comment">%         fprintf(fp,'\t\t];\n');</span>
</pre><h2>byte member<a name="8"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\tbyte = [ '</span>);
        <span class="keyword">for</span> j=1:N
            fprintf(fp,sprintf(<span class="string">'%d '</span>,Mess(i).fields.matByte{j}));
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'];\n'</span>);
</pre><h2>type member<a name="9"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\ttype = [ '</span>);
        <span class="keyword">for</span> j=1:N
            fprintf(fp,sprintf(<span class="string">'{''%s''} '</span>,Mess(i).fields.matType{j}));
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'];\n'</span>);

        fprintf(fp,<span class="string">'\tif (sum(byte) == p.len)\n'</span>);
        fprintf(fp,<span class="string">'\t\tS = buildStruct(S,byte,name,type,p);\n'</span>);
        fprintf(fp,<span class="string">'\telse\n'</span>);
        fprintf(fp,<span class="string">'\t\tdisp(''bytes in packet did not match structure size'')\n'</span>);
        fprintf(fp,<span class="string">'\tend\n'</span>);

        fprintf(fp,<span class="string">'return\n\n'</span>);
</pre><pre class="codeinput">    <span class="keyword">end</span>
    fclose(fp);

    <span class="keyword">switch</span> (VERSION)
        <span class="keyword">case</span> 0.9
            fp = fopen(<span class="string">'initMavLink_0_9.m'</span>,<span class="string">'w'</span>);
            fprintf(fp,<span class="string">'function MavLink = initMavLink_0_9()\n'</span>);
        <span class="keyword">case</span> 1.0
            fp = fopen(<span class="string">'initMavLink_1_0.m'</span>,<span class="string">'w'</span>);
            fprintf(fp,<span class="string">'function MavLink = initMavLink_1_0()\n'</span>);
        <span class="keyword">otherwise</span>
            disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
            <span class="keyword">return</span>
    <span class="keyword">end</span>
    <span class="keyword">for</span> i=1:K
        <span class="comment">%fprintf(fp,sprintf('\tMavLink.%s = struct();\n',Mess(i).name));</span>
        fprintf(fp,sprintf(<span class="string">'\tMavLink.%s = [];\n'</span>,Mess(i).name));
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'return\n'</span>);

    fclose(fp);
    <span class="keyword">switch</span> (VERSION)
        <span class="keyword">case</span> 0.9
            disp(<span class="string">'Done MatLab script for MavLink 0.9'</span>)
        <span class="keyword">case</span> 1.0
            disp(<span class="string">'Done MatLab script for MavLink 1.0'</span>)
        <span class="keyword">otherwise</span>
            disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
            <span class="keyword">return</span>
    <span class="keyword">end</span>
<span class="keyword">return</span>
</pre><pre class="codeoutput">Done MatLab script for MavLink 0.9
</pre><pre class="codeoutput">Done MatLab script for MavLink 1.0
</pre><h2>Generate Java Code based on XML data<a name="11"></a></h2><pre class="codeinput"><span class="keyword">function</span> genJavaCode(Mess)
</pre><pre class="codeinput">    <span class="keyword">global</span> SWAP;
    <span class="keyword">global</span> VERSION;
    <span class="keyword">global</span> LOCAL;
    <span class="keyword">if</span> (SWAP)
        disp(<span class="string">'Offset SWAPPING'</span>)
    <span class="keyword">end</span>
    <span class="keyword">switch</span> (VERSION)
        <span class="keyword">case</span> 0.9
            dDir = <span class="string">'Java\\Mav09'</span>;
        <span class="keyword">case</span> 1.0
            dDir = <span class="string">'Java\\Mav10'</span>;
        <span class="keyword">otherwise</span>
            disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
            <span class="keyword">return</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> (isempty(dir(dDir)))
        mkdir(dDir);
    <span class="keyword">end</span>
</pre><h2>initialization<a name="14"></a></h2><pre class="codeinput">    <span class="comment">%specialHandlingIDs = [25 32 73 111];</span>
</pre><h2>Generate function header<a name="15"></a></h2><pre class="codeinput">    K = length(Mess);
    msgWithSystem = [];
    msgWithComponent = [];
    <span class="keyword">for</span> i=1:K   <span class="comment">%%% For each MavLink message</span>
        msgWithSystemBool = strcmp(<span class="string">'target_system'</span>,Mess(i).fields.name);
        msgWithSystemIdx = find(msgWithSystemBool);
        <span class="keyword">if</span> (any(msgWithSystemBool))
            msgWithSystem = [msgWithSystem; i];
        <span class="keyword">end</span>
        msgWithComponentBool = strcmp(<span class="string">'target_component'</span>,Mess(i).fields.name);
        msgWithComponentIdx = find(msgWithComponentBool);
        <span class="keyword">if</span> (any(strcmp(<span class="string">'target_component'</span>,Mess(i).fields.name)))
            msgWithComponent = [msgWithComponent; i];
        <span class="keyword">end</span>
        N = size(Mess(i).fields.name,1);
        ID = sscanf(Mess(i).id,<span class="string">'%d'</span>);
</pre><h2>packetSize = sum(cell2mat(Mess(i).fields.matByte));<a name="16"></a></h2><h2>specialFunction = ~isempty(intersect(ID,specialHandlingIDs));<a name="17"></a></h2><h2>Do MavLink to java types substitution<a name="18"></a></h2><pre class="codeinput">        JAVA.name = Mess(i).fields.name;
        JAVA.type = Mess(i).fields.javaType;
        JAVA.byte = Mess(i).fields.javaByte;
        JAVA.array = Mess(i).fields.Array;
</pre><h2>Max name and type lengths<a name="19"></a></h2><pre class="codeinput">        ml = 0;
        tl = 0;
        needBB = 0;
        <span class="keyword">for</span> j=1:N
            ml = max([ml length(JAVA.name{j})]);
            tl = max([tl length(JAVA.type{j})]);
            needBB = needBB || (JAVA.byte{j}&gt;Mess(i).fields.byte{j});
        <span class="keyword">end</span>
        ml = 4*ceil(ml/4);
        tl = 4*ceil(tl/4);
        tpad = JAVA.type;   <span class="comment">%preallocates memory for tpad cell array</span>
        mpad = JAVA.type;   <span class="comment">%same as above</span>
        <span class="keyword">for</span> j=1:N
            tpad{j} = char(9*ones(1,ceil((tl-length(JAVA.type{j}))/4)));
            mpad{j} = char(9*ones(1,ceil((ml-length(Mess(i).fields.name{j}))/4)));
        <span class="keyword">end</span>
</pre><h2>Function Header<a name="20"></a></h2><pre class="codeinput">        newf = sprintf(<span class="string">'%s\\%s_class.java'</span>,dDir,Mess(i).name);
        fp = fopen(newf,<span class="string">'w'</span>);
        <span class="keyword">switch</span> (VERSION)
            <span class="keyword">case</span> 0.9
                fprintf(fp,<span class="string">'//MavLink 0.9\n\n'</span>);
            <span class="keyword">case</span> 1.0
                fprintf(fp,<span class="string">'//MavLink 1.0\n\n'</span>);
            <span class="keyword">otherwise</span>
                disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
                <span class="keyword">return</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> (LOCAL)
            fprintf(fp,<span class="string">'//package gov.nasa.larc.AP;\n'</span>);
            fprintf(fp,<span class="string">'//import gov.nasa.larc.serial.Loggable;\n'</span>);
        <span class="keyword">else</span>
            fprintf(fp,<span class="string">'package gov.nasa.larc.AP;\n'</span>);
            fprintf(fp,<span class="string">'import gov.nasa.larc.serial.Loggable;\n'</span>);
        <span class="keyword">end</span>
<span class="comment">%     if (sum(cell2mat(JAVA.byte)) ~= ...</span>
<span class="comment">%         sum(cell2mat(Mess(i).fields.byte)))</span>
<span class="comment">%         fprintf(fp,'import java.nio.ByteBuffer;\n');</span>
<span class="comment">%         fprintf(fp,'import java.nio.ByteOrder;\n\n');</span>
<span class="comment">%     end</span>
        fprintf(fp,<span class="string">'\n/**\n'</span>);
        fprintf(fp,sprintf(<span class="string">'Message ID: %s(%d)\n'</span>,Mess(i).name,ID));
        fprintf(fp,<span class="string">'--------------------------------------\n'</span>);
        fprintf(fp,sprintf(<span class="string">'%s'</span>,Mess(i).fdesc));
        fprintf(fp,<span class="string">'--------------------------------------\n'</span>);
        fprintf(fp,<span class="string">'*/\n'</span>);

        <span class="comment">%fprintf(fp,'public class %s_class extends MavCheckSum\n{\n',Mess(i).name);</span>
        fprintf(fp,<span class="string">'public class %s_class'</span>,Mess(i).name);
        <span class="keyword">if</span> (LOCAL)
            fprintf(fp,<span class="string">' //implements Loggable'</span>);
        <span class="keyword">else</span>
            fprintf(fp,<span class="string">' implements Loggable'</span>);
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'\n{\n'</span>);
</pre><h2>Declare member variables<a name="21"></a></h2><pre class="codeinput">        <span class="comment">%fprintf(fp,'\tHeader_class head;\n');</span>
        fprintf(fp,<span class="string">'\tpublic static final int msgID = %d;\n'</span>,ID);
        <span class="keyword">for</span> j=1:N
<span class="comment">%             switch(JAVA.type{j})</span>
<span class="comment">%                 case 'byte[]'</span>
<span class="comment">%                     fprintf(fp,'\tpublic %s%s %s = new byte[%d];%s',JAVA.type{j}, tpad{j}, Mess(i).fields.name{j},JAVA.byte{j}, mpad{j});</span>
<span class="comment">%                 otherwise</span>
<span class="comment">%                     fprintf(fp,'\tpublic %s%s %s;%s '              ,JAVA.type{j}, tpad{j}, Mess(i).fields.name{j}, mpad{j});</span>
<span class="comment">%             end</span>
            <span class="keyword">if</span> (JAVA.array{j})
                fprintf(fp,<span class="string">'\tpublic %s[]%s %s = new %s[%d];%s'</span>,JAVA.type{j}, tpad{j}, Mess(i).fields.name{j},JAVA.type{j},JAVA.byte{j}, mpad{j});
            <span class="keyword">else</span>
                fprintf(fp,<span class="string">'\tpublic %s%s %s;%s '</span>              ,JAVA.type{j}, tpad{j}, Mess(i).fields.name{j}, mpad{j});
            <span class="keyword">end</span>
            <span class="keyword">if</span> ~isempty(Mess(i).fields.desc{j})
                fprintf(fp,<span class="string">'\t// '</span>);
                fprintf(fp,Mess(i).fields.desc{j});
            <span class="keyword">end</span>
            fprintf(fp,<span class="string">'\n'</span>);
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'\n'</span>);
        fprintf(fp,<span class="string">'\tprivate packet rcvPacket;\n'</span>);
        fprintf(fp,<span class="string">'\tprivate packet sndPacket;\n\n'</span>);
</pre><h2>Constructor<a name="22"></a></h2><pre class="codeinput">        fprintf(fp,sprintf(<span class="string">'\tpublic %s_class()\n\t{\n'</span>,Mess(i).name));
        fprintf(fp,<span class="string">'\t\trcvPacket = new packet(msgID);\n'</span>);
        fprintf(fp,<span class="string">'\t\tsndPacket = new packet(msgID);\n'</span>);
        <span class="keyword">if</span> (intersect(i,msgWithSystem))
            fprintf(fp,<span class="string">'\t\ttarget_system = 1;\n'</span>);
        <span class="keyword">end</span>
        <span class="keyword">if</span> (intersect(i,msgWithComponent))
            fprintf(fp,<span class="string">'\t\ttarget_component = 1;\n'</span>);
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'\t}\n\n'</span>);
</pre><h2>Copy Constructor<a name="23"></a></h2><pre class="codeinput">        fprintf(fp,sprintf(<span class="string">'\tpublic %s_class(%s_class o)\n\t{\n'</span>,Mess(i).name,Mess(i).name));
        <span class="keyword">for</span> j=1:N
            fprintf(fp,<span class="string">'\t\t%s = o.%s;\n'</span>,Mess(i).fields.name{j},Mess(i).fields.name{j});
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'\t}\n\n'</span>);
</pre><h2>First Parse Function<a name="24"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\tpublic boolean parse(byte[] b)\n\t{\n'</span>);
        fprintf(fp,<span class="string">'\t\treturn parse(b, false);\n'</span>);
        fprintf(fp,<span class="string">'\t}\n\n'</span>);
</pre><h2>Second Parse Function<a name="25"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\tpublic boolean parse(byte[] b, boolean valid)\n\t{\n'</span>);
        fprintf(fp,<span class="string">'\t\trcvPacket.load(b);\n\n'</span>);
</pre><h2>Begin parsing from array<a name="26"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\t\tboolean pstatus = valid || rcvPacket.isPacket();\n'</span>);
        fprintf(fp,<span class="string">'\t\tif (pstatus)\n'</span>);
        fprintf(fp,<span class="string">'\t\t{\n'</span>);

<span class="comment">%         fprintf(fp,'\t\t\t//head.updateRcvSeq();\n\n');</span>
        fprintf(fp,<span class="string">'\t\t\trcvPacket.updateSeqNum();\n\n'</span>);
<span class="comment">%         if(needBB)</span>
<span class="comment">%             fprintf(fp,'\t\t\tbyte[] temp = {0,0,0,0,0,0,0,0};\n');</span>
<span class="comment">%             fprintf(fp,'\t\t\tByteBuffer BB = ByteBuffer.wrap(temp);\n\n');</span>
<span class="comment">%         end</span>
<span class="comment">%         fprintf(fp,'\t\t\tByteBuffer p = ByteBuffer.wrap(packet);\n');</span>
</pre><h2>define MavLink member lengths (in bytes)<a name="27"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\t\t\t// int[] mavLen = {'</span>);
        <span class="keyword">for</span> j=1:N
            <span class="keyword">if</span> (j==N)
                fprintf(fp,<span class="string">'%d'</span>,Mess(i).fields.byte{j});
            <span class="keyword">else</span>
                fprintf(fp,<span class="string">'%d, '</span>,Mess(i).fields.byte{j});
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'};\n'</span>);
</pre><h2>define java variable lengths (in bytes)<a name="28"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\t\t\t// int[] javLen = {'</span>);
        <span class="keyword">for</span> j=1:N
            <span class="keyword">if</span> (j==N)
                fprintf(fp,<span class="string">'%d'</span>,JAVA.byte{j});
            <span class="keyword">else</span>
                fprintf(fp,<span class="string">'%d, '</span>,JAVA.byte{j});
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'};\n\n'</span>);

<span class="comment">%         fprintf(fp,'\t\t\trcvPacket.pBuf.position(packet.DATA_OFFSET);     // Skip the packet header\n');</span>
        <span class="keyword">for</span> j=1:N
            mpad = char(9*ones(1,ceil((ml+1-length(Mess(i).fields.name{j}))/4)));
            vname = Mess(i).fields.name{j};

            <span class="keyword">if</span> (JAVA.array{j})
                <span class="keyword">if</span> ((JAVA.byte{j} == Mess(i).fields.byte{j}) || (JAVA.byte{j} == JAVA.array{j}*Mess(i).fields.byte{j}))
                    fprintf(fp,<span class="string">'\t\t\trcvPacket.getByte(%s, 0, %d);\n'</span>,vname,JAVA.byte{j});
                <span class="keyword">else</span>
                    fprintf(fp,<span class="string">'//\tERROR\tParsing ''%s'' array of ''%s'' from ''%s''\n'</span>,vname,JAVA.type{j},Mess(i).fields.type{j});
                    fprintf(<span class="string">'//\tERROR\tParsing ''%s'' array of ''%s'' from ''%s'' in MESSAGE: ''%s''\n'</span>,vname,JAVA.type{j},Mess(i).fields.type{j},Mess(i).name);
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                <span class="keyword">if</span> (JAVA.byte{j} == Mess(i).fields.byte{j})
                    <span class="keyword">switch</span>(JAVA.type{j})
                        <span class="keyword">case</span> <span class="string">'byte'</span>
                            <span class="comment">%fprintf(fp,'\t\t\t%s%s= rcvPacket.pBuf.get();\n',vname,mpad);</span>
                            fprintf(fp,<span class="string">'\t\t\t%s%s= rcvPacket.getByte();\n'</span>,vname,mpad);
                        <span class="keyword">case</span> <span class="string">'short'</span>
                            <span class="comment">%fprintf(fp,'\t\t\t%s%s= rcvPacket.pBuf.getShort();\n',vname,mpad);</span>
                            fprintf(fp,<span class="string">'\t\t\t%s%s= rcvPacket.getShort();\n'</span>,vname,mpad);
                        <span class="keyword">case</span> <span class="string">'int'</span>
                            <span class="comment">%fprintf(fp,'\t\t\t%s%s= rcvPacket.pBuf.getInt();\n',vname,mpad);</span>
                            fprintf(fp,<span class="string">'\t\t\t%s%s= rcvPacket.getInt();\n'</span>,vname,mpad);
                        <span class="keyword">case</span> <span class="string">'long'</span>
                            <span class="comment">%fprintf(fp,'\t\t\t%s%s= rcvPacket.pBuf.getLong();\n',vname,mpad);</span>
                            fprintf(fp,<span class="string">'\t\t\t%s%s= rcvPacket.getLong();\n'</span>,vname,mpad);
                        <span class="keyword">case</span> <span class="string">'float'</span>
                            <span class="comment">%fprintf(fp,'\t\t\t%s%s= rcvPacket.pBuf.getFloat();\n',vname,mpad);</span>
                            fprintf(fp,<span class="string">'\t\t\t%s%s= rcvPacket.getFloat();\n'</span>,vname,mpad);
                        <span class="keyword">otherwise</span>
                            <span class="comment">%fprintf(fp,'\t\t\trcvPacket.pBuf.get(%s, 0, %d);\n',vname,Mess(i).fields.byte{j});</span>
                            <span class="comment">%fprintf(fp,'\t\t\trcvPacket.getByte(%s, 0, %d);\n',vname,JAVA.byte{j});</span>
                            fprintf(fp,<span class="string">'//\tERROR\tParsing ''%s'' a ''%s'' from a ''%s''\n'</span>,vname,JAVA.type{j},Mess(i).fields.type{j});
                            fprintf(<span class="string">'//\tERROR\tParsing ''%s'' a ''%s'' from a ''%s'' in MESSAGE: ''%s''\n'</span>,vname,JAVA.type{j},Mess(i).fields.type{j},Mess(i).name);
                    <span class="keyword">end</span>
                <span class="keyword">else</span>
                    <span class="keyword">switch</span>(JAVA.type{j})
                        <span class="keyword">case</span> <span class="string">'short'</span>
                            <span class="comment">%fprintf(fp,'\t\t\t%s%s= rcvPacket.BB.putLong(0,0L).put(0,rcvPacket.pBuf.get()).getShort(0);\n',vname,mpad);</span>
                            fprintf(fp,<span class="string">'\t\t\t%s%s= rcvPacket.getShortB();\n'</span>,vname,mpad);
                        <span class="keyword">case</span> <span class="string">'int'</span>
                            <span class="comment">%fprintf(fp,'\t\t\t%s%s= rcvPacket.BB.putLong(0,0L).putShort(0,rcvPacket.pBuf.getShort()).getInt(0);\n',vname,mpad);</span>
                            fprintf(fp,<span class="string">'\t\t\t%s%s= rcvPacket.getIntS();\n'</span>,vname,mpad);
                        <span class="keyword">case</span> <span class="string">'long'</span>
                            <span class="comment">%fprintf(fp,'\t\t\t%s%s= rcvPacket.BB.putLong(0,0L).putInt(0,rcvPacket.pBuf.getInt()).getLong(0);\n',vname,mpad);</span>
                            fprintf(fp,<span class="string">'\t\t\t%s%s= rcvPacket.getLongI();\n'</span>,vname,mpad);
                        <span class="keyword">otherwise</span>
                            <span class="comment">%%fprintf(fp,'\t// Don''t know how to handle this case\n\t// %s = buf.get????();\n',vname);</span>
                            fprintf(fp,<span class="string">'//\tERROR\tParsing ''%s'' a ''%s'' from a ''%s''\n'</span>,vname,JAVA.type{j},Mess(i).fields.type{j});
                            fprintf(<span class="string">'//\tERROR\tParsing ''%s'' a ''%s'' from a ''%s'' in MESSAGE: ''%s''\n'</span>,vname,JAVA.type{j},Mess(i).fields.type{j},Mess(i).name);
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
</pre><h2>Close function<a name="29"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\t\t}\n'</span>);
        fprintf(fp,<span class="string">'\t\treturn(pstatus);\n'</span>);
        fprintf(fp,<span class="string">'\t}\n\n'</span>);
</pre><h2>Now begins the FIRST encode section<a name="30"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\tpublic byte[] encode()\n\t{\n'</span>);
        fprintf(fp,<span class="string">'\t\treturn encode(\n'</span>);
        <span class="keyword">for</span> j=1:N
            <span class="keyword">if</span> (j==1)
                <span class="keyword">if</span> (j==msgWithSystemIdx)
                    fprintf(fp,<span class="string">'\t\t\t\t\t  (%s)1\n'</span>,JAVA.type{j});
                <span class="keyword">elseif</span> (j==msgWithComponentIdx)
                    fprintf(fp,<span class="string">'\t\t\t\t\t  (%s)1\n'</span>,JAVA.type{j});
                <span class="keyword">else</span>
                    fprintf(fp,<span class="string">'\t\t\t\t\t  %s\n'</span>,Mess(i).fields.name{j});
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                <span class="keyword">if</span> (j==msgWithSystemIdx)
                    fprintf(fp,<span class="string">'\t\t\t\t\t ,(%s)1\n'</span>,JAVA.type{j});
                <span class="keyword">elseif</span> (j==msgWithComponentIdx)
                    fprintf(fp,<span class="string">'\t\t\t\t\t ,(%s)1\n'</span>,JAVA.type{j});
                <span class="keyword">else</span>
                    fprintf(fp,<span class="string">'\t\t\t\t\t ,%s\n'</span>,Mess(i).fields.name{j});
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        fprintf(fp,sprintf( <span class="string">'\t\t\t\t\t );\n'</span>));
        fprintf(fp,<span class="string">'\t}\n\n'</span>);
</pre><h2>Now begins the optional SECOND encode section<a name="31"></a></h2><pre class="codeinput">        <span class="keyword">if</span> (~isempty([msgWithSystemIdx msgWithComponentIdx]) &amp;&amp; (N&gt;length([msgWithSystemIdx msgWithComponentIdx])))
            fprintf(fp,<span class="string">'\tpublic byte[] encode(\n'</span>);
            first = 1;
            <span class="keyword">for</span> j=1:N
                <span class="keyword">if</span> (first)
                    <span class="keyword">if</span> (~any(intersect(j,[msgWithSystemIdx msgWithComponentIdx])))
                        <span class="keyword">if</span> (JAVA.array{j})
                            fprintf(fp,<span class="string">'\t\t\t\t\t\t %s[] v_%s\n'</span>,JAVA.type{j},Mess(i).fields.name{j});
                        <span class="keyword">else</span>
                            fprintf(fp,<span class="string">'\t\t\t\t\t\t %s v_%s\n'</span>,JAVA.type{j},Mess(i).fields.name{j});
                        <span class="keyword">end</span>
                        first = 0;
                    <span class="keyword">end</span>
                <span class="keyword">else</span>
                    <span class="keyword">if</span> (~any(intersect(j,[msgWithSystemIdx msgWithComponentIdx])))
                        <span class="keyword">if</span> (JAVA.array{j})
                            fprintf(fp,<span class="string">'\t\t\t\t\t\t,%s[] v_%s\n'</span>,JAVA.type{j},Mess(i).fields.name{j});
                        <span class="keyword">else</span>
                            fprintf(fp,<span class="string">'\t\t\t\t\t\t,%s v_%s\n'</span>,JAVA.type{j},Mess(i).fields.name{j});
                        <span class="keyword">end</span>
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            fprintf(fp,sprintf( <span class="string">'\t\t\t\t\t\t)\n\t{\n'</span>));

            fprintf(fp,<span class="string">'\t\treturn encode(\n'</span>);
            <span class="keyword">for</span> j=1:N
                <span class="keyword">if</span> (j==1)
                    <span class="keyword">if</span> (j==msgWithSystemIdx)
                        fprintf(fp,<span class="string">'\t\t\t\t\t    (%s)1\n'</span>,JAVA.type{j});
                    <span class="keyword">elseif</span> (j==msgWithComponentIdx)
                        fprintf(fp,<span class="string">'\t\t\t\t\t    (%s)1\n'</span>,JAVA.type{j});
                    <span class="keyword">else</span>
                        fprintf(fp,<span class="string">'\t\t\t\t\t  v_%s\n'</span>,Mess(i).fields.name{j});
                    <span class="keyword">end</span>
                <span class="keyword">else</span>
                    <span class="keyword">if</span> (j==msgWithSystemIdx)
                        fprintf(fp,<span class="string">'\t\t\t\t\t ,  (%s)1\n'</span>,JAVA.type{j});
                    <span class="keyword">elseif</span> (j==msgWithComponentIdx)
                        fprintf(fp,<span class="string">'\t\t\t\t\t ,  (%s)1\n'</span>,JAVA.type{j});
                    <span class="keyword">else</span>
                        fprintf(fp,<span class="string">'\t\t\t\t\t ,v_%s\n'</span>,Mess(i).fields.name{j});
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            fprintf(fp,sprintf( <span class="string">'\t\t\t\t\t );\n'</span>));
            fprintf(fp,<span class="string">'\t}\n\n'</span>);
        <span class="keyword">end</span>
</pre><h2>Now begins the THIRD encode section<a name="32"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\tpublic byte[] encode(\n'</span>);
        <span class="keyword">for</span> j=1:N
            <span class="keyword">if</span> (j==1)
                <span class="keyword">if</span> (JAVA.array{j})
                    ftext = sprintf(<span class="string">'\t\t\t\t\t\t %s[] v_%s\n'</span>,JAVA.type{j},Mess(i).fields.name{j});
                <span class="keyword">else</span>
                    ftext = sprintf(<span class="string">'\t\t\t\t\t\t %s v_%s\n'</span>,JAVA.type{j},Mess(i).fields.name{j});
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                <span class="keyword">if</span> (JAVA.array{j})
                    ftext = sprintf(<span class="string">'\t\t\t\t\t\t,%s[] v_%s\n'</span>,JAVA.type{j},Mess(i).fields.name{j});
                <span class="keyword">else</span>
                    ftext = sprintf(<span class="string">'\t\t\t\t\t\t,%s v_%s\n'</span>,JAVA.type{j},Mess(i).fields.name{j});
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            fprintf(fp,<span class="string">'%s'</span>,ftext);
        <span class="keyword">end</span>
        fprintf(fp,sprintf( <span class="string">'\t\t\t\t\t\t)\n\t{\n'</span>));
</pre><h2>Body of encode function<a name="33"></a></h2><pre class="codeinput">        <span class="comment">%fprintf(fp,'\t\tpacket pkt = new packet(msgID);\n');</span>
<span class="comment">%         if(needBB)</span>
<span class="comment">%             fprintf(fp,'\t\tbyte[] temp = {0,0,0,0,0,0,0,0};\n');</span>
<span class="comment">%             fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.wrap(temp);\n\n');</span>
<span class="comment">%         end</span>
<span class="comment">%         fprintf(fp,'\t\tbyte[] msg = new byte[%d];\t// includes header and checksum\n',packetSize+8);</span>
<span class="comment">%         fprintf(fp,'\t\tByteBuffer p = ByteBuffer.wrap(msg);\n\n');</span>
</pre><h2>define MavLink member lengths (in bytes)<a name="34"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\t\t// int[] mavLen = {'</span>);
        <span class="keyword">for</span> j=1:N
            <span class="keyword">if</span> (j==N)
                fprintf(fp,<span class="string">'%d'</span>,Mess(i).fields.byte{j});
            <span class="keyword">else</span>
                fprintf(fp,<span class="string">'%d, '</span>,Mess(i).fields.byte{j});
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'};\n'</span>);
</pre><h2>define java variable lengths (in bytes)<a name="35"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'\t\t// int[] javLen = {'</span>);
        <span class="keyword">for</span> j=1:N
            <span class="keyword">if</span> (j==N)
                fprintf(fp,<span class="string">'%d'</span>,JAVA.byte{j});
            <span class="keyword">else</span>
                fprintf(fp,<span class="string">'%d, '</span>,JAVA.byte{j});
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'};\n\n'</span>);
<span class="comment">%         fprintf(fp,'\t\t// encode the header for Message ID: %d\n',ID);</span>
<span class="comment">%         fprintf(fp,'\t\tMavHeader head = new MavHeader((byte)%d);\n',ID);</span>
<span class="comment">%         fprintf(fp,'\t\tp.put(head.getHeader(),0,MavHeader.HEADER_SIZE);\n\n');</span>

<span class="comment">%         fprintf(fp,'\t\tsndPacket.pBuf.position(packet.DATA_OFFSET);\n');</span>
        fprintf(fp,<span class="string">'\t\tsndPacket.setSndSeq();\n\n'</span>);
        fprintf(fp,<span class="string">'\t\tsndPacket.resetDataIdx();\n'</span>);
        <span class="keyword">for</span> j=1:N
            vname = Mess(i).fields.name{j};
            <span class="keyword">if</span> (JAVA.array{j})
                <span class="keyword">if</span> ((JAVA.byte{j} == Mess(i).fields.byte{j}) || (JAVA.byte{j} == JAVA.array{j}*Mess(i).fields.byte{j}))
                    fprintf(fp,<span class="string">'\t\tsndPacket.putByte(v_%s,0,%d);'</span>,JAVA.name{j},JAVA.byte{j});
                <span class="keyword">else</span>
                    fprintf(fp,<span class="string">'//\tERROR\tEncoding ''%s'' array of ''%s'' from ''%s''\n'</span>,vname,JAVA.type{j},Mess(i).fields.type{j});
                    fprintf(<span class="string">'//\tERROR\tEncoding ''%s'' array of ''%s'' from ''%s'' in MESSAGE: ''%s''\n'</span>,vname,JAVA.type{j},Mess(i).fields.type{j},Mess(i).name);
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                <span class="keyword">if</span> (JAVA.byte{j} == Mess(i).fields.byte{j})
                    <span class="keyword">switch</span>(JAVA.type{j})
                        <span class="keyword">case</span> <span class="string">'byte'</span>
                            <span class="comment">%fprintf(fp,'\t\tsndPacket.pBuf.put(v_%s);',Mess(i).fields.name{j});</span>
                            fprintf(fp,<span class="string">'\t\tsndPacket.putByte(v_%s);'</span>,Mess(i).fields.name{j});
                        <span class="keyword">case</span> <span class="string">'short'</span>
                            <span class="comment">%fprintf(fp,'\t\tsndPacket.pBuf.putShort(v_%s);',Mess(i).fields.name{j});</span>
                            fprintf(fp,<span class="string">'\t\tsndPacket.putShort(v_%s);'</span>,Mess(i).fields.name{j});
                        <span class="keyword">case</span> <span class="string">'int'</span>
                            <span class="comment">%fprintf(fp,'\t\tsndPacket.pBuf.putInt(v_%s);',Mess(i).fields.name{j});</span>
                            fprintf(fp,<span class="string">'\t\tsndPacket.putInt(v_%s);'</span>,Mess(i).fields.name{j});
                        <span class="keyword">case</span> <span class="string">'long'</span>
                            <span class="comment">%fprintf(fp,'\t\tsndPacket.pBuf.putLong(v_%s);',Mess(i).fields.name{j});</span>
                            fprintf(fp,<span class="string">'\t\tsndPacket.putLong(v_%s);'</span>,Mess(i).fields.name{j});
                        <span class="keyword">case</span> <span class="string">'float'</span>
                            <span class="comment">%fprintf(fp,'\t\tsndPacket.pBuf.putFloat(v_%s);',Mess(i).fields.name{j});</span>
                            fprintf(fp,<span class="string">'\t\tsndPacket.putFloat(v_%s);'</span>,Mess(i).fields.name{j});
                        <span class="keyword">otherwise</span>
                            <span class="comment">%fprintf(fp,'\t\tsndPacket.pBuf.put(v_%s,0,%d);',Mess(i).fields.name{j},Mess(i).fields.byte{j});</span>
                            <span class="comment">%fprintf(fp,'\t\tsndPacket.putByte(v_%s,0,%d);',Mess(i).fields.name{j},Mess(i).fields.byte{j});</span>
                            fprintf(fp,<span class="string">'//\tERROR\tEncoding ''%s'' a ''%s'' from a ''%s''\n'</span>,vname,JAVA.type{j},Mess(i).fields.type{j});
                            fprintf(<span class="string">'//\tERROR\tEncoding ''%s'' a ''%s'' from a ''%s'' in MESSAGE: ''%s''\n'</span>,vname,JAVA.type{j},Mess(i).fields.type{j},Mess(i).name);
                    <span class="keyword">end</span>
                <span class="keyword">else</span>
                    <span class="keyword">switch</span>(JAVA.type{j})
                        <span class="keyword">case</span> <span class="string">'short'</span>
                            <span class="comment">%fprintf(fp,'\t\tsndPacket.pBuf.put(sndPacket.BB.putShort(0,v_%s).get(0));',Mess(i).fields.name{j});</span>
                            fprintf(fp,<span class="string">'\t\tsndPacket.putByteS(v_%s);'</span>,Mess(i).fields.name{j});
                        <span class="keyword">case</span> <span class="string">'int'</span>
                            <span class="comment">%fprintf(fp,'\t\tsndPacket.pBuf.putShort(sndPacket.BB.putInt(0,v_%s).getShort(0));',Mess(i).fields.name{j});</span>
                            fprintf(fp,<span class="string">'\t\tsndPacket.putShortI(v_%s);'</span>,Mess(i).fields.name{j});
                        <span class="keyword">case</span> <span class="string">'long'</span>
                            <span class="comment">%fprintf(fp,'\t\tsndPacket.pBuf.putInt(sndPacket.BB.putLong(0,v_%s).getInt(0));',Mess(i).fields.name{j});</span>
                            fprintf(fp,<span class="string">'\t\tsndPacket.putIntL(v_%s);'</span>,Mess(i).fields.name{j});
                        <span class="keyword">otherwise</span>
                            <span class="comment">%%fprintf(fp,'\t// Don''t know how to handle this case\n\t// %s = buf.get????();\n',vname);</span>
                            fprintf(fp,<span class="string">'//\tERROR\tEncoding ''%s'' a ''%s'' from a ''%s''\n'</span>,vname,Mess(i).fields.type{j},JAVA.type{j});
                            fprintf(<span class="string">'//\tERROR\tEncoding ''%s'' a ''%s'' from a ''%s'' in MESSAGE: ''%s''\n'</span>,vname,Mess(i).fields.type{j},JAVA.type{j},Mess(i).name);
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            fprintf(fp,<span class="string">'\t// Add "%s" parameter\n'</span>,Mess(i).fields.name{j});
        <span class="keyword">end</span>

        fprintf(fp,<span class="string">'\n\t\t// encode the checksum\n'</span>);
        fprintf(fp,<span class="string">'\n\t\tsndPacket.putChkSum();\n'</span>);
<span class="comment">%         fprintf(fp,'\t\tp.order(java.nio.ByteOrder.LITTLE_ENDIAN);\n');</span>
<span class="comment">%         fprintf(fp,'\t\tp.putShort(MavCheckSum.getChecksum(msg));\n');</span>

        fprintf(fp,<span class="string">'\n\t\treturn sndPacket.getPacket();\n'</span>);
<span class="comment">%         fprintf(fp,'\n\t\treturn sndPacket.sndPacket;\n');</span>
<span class="comment">%         fprintf(fp,'\n\t\treturn msg;\n');</span>
        fprintf(fp,<span class="string">'\t}\n\n'</span>);
</pre><h2>Loggable<a name="36"></a></h2><pre class="codeinput">    fprintf(fp,<span class="string">'\tpublic String getLogHeader()\n'</span>);
    fprintf(fp,<span class="string">'	{\n'</span>);
    fprintf(fp,<span class="string">'		String param = (\n'</span>);
    fprintf(fp,<span class="string">'				  "  time"\n'</span>);
<span class="comment">% 				+ ", insert var name"</span>
    <span class="keyword">for</span> j=1:N
        fprintf(fp,<span class="string">' 				+ ", %s_%s"\n'</span>,Mess(i).name,Mess(i).fields.name{j});
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'				);\n'</span>);
    fprintf(fp,<span class="string">'		return param;\n'</span>);
    fprintf(fp,<span class="string">'	}\n\n'</span>);

    fprintf(fp,<span class="string">'    public String getLogData()\n'</span>);
    fprintf(fp,<span class="string">'	{\n'</span>);
    fprintf(fp,<span class="string">'		String param = (\n'</span>);
    fprintf(fp,<span class="string">'				System.currentTimeMillis()\n'</span>);
<span class="comment">% 				+ ", " + var ...</span>
    <span class="keyword">for</span> j=1:N
        fprintf(fp,<span class="string">' 				+ ", " + %s\n'</span>,Mess(i).fields.name{j});
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'				);\n'</span>);
    fprintf(fp,<span class="string">'		return param;\n'</span>);
    fprintf(fp,<span class="string">'	}\n'</span>);
</pre><pre class="codeinput">        fprintf(fp,<span class="string">'}\n'</span>); <span class="comment">%% End of MavLink Class</span>
        fclose(fp); fp = [];
    <span class="keyword">end</span>   <span class="comment">% For each MavLink message</span>
</pre><h2>Generate the MavLink Class<a name="38"></a></h2><pre class="codeinput">    fp = fopen(sprintf(<span class="string">'%s\\APData.java'</span>,dDir),<span class="string">'w'</span>);
    <span class="keyword">if</span> (~LOCAL)
        fprintf(fp,<span class="string">'package gov.nasa.larc.AP;\n\n'</span>);
    <span class="keyword">end</span>
    <span class="comment">%fprintf(fp,'import java.nio.ByteBuffer;\n\n');</span>
    fprintf(fp,<span class="string">'/**\n * @author svazquez\n *\n */\n'</span>);
    fprintf(fp,<span class="string">'public class APData\n{\n'</span>);
</pre><h2>Max name and type lengths<a name="39"></a></h2><pre class="codeinput">    ml = 0;
    <span class="keyword">for</span> i=1:K
        ml = max([ml length(Mess(i).name)]);
    <span class="keyword">end</span>
    ml = 4*ceil((ml+17)/4);

    <span class="keyword">for</span> i=1:K   <span class="comment">% For each MavLink message</span>
        <span class="comment">%mpad = char(20*ones(1,ml+1-length(Mess(i).name)));</span>
        ntabs = ceil((ml-(length(Mess(i).name)+24))/4);
        mpad = char(9*ones(1,ntabs));
        <span class="comment">%%disp(sprintf('%s %d',Mess(i).name,length(mpad)));</span>
        fprintf(fp,<span class="string">'\tpublic static %s_class%s\t%s%s\t= new %s_class();%s\t// (%s)\n'</span>,Mess(i).name,mpad,Mess(i).name,mpad,Mess(i).name,mpad,Mess(i).id);
    <span class="keyword">end</span>
</pre><pre class="codeinput">    fprintf(fp,<span class="string">'\n\tpublic static boolean processPacket(byte[] pkt, boolean valid)\n'</span>);
    fprintf(fp,<span class="string">'\t{\n'</span>);
    fprintf(fp,<span class="string">'\t\tswitch(pkt[5])\n'</span>);
    fprintf(fp,<span class="string">'\t\t{\n'</span>);
    <span class="keyword">for</span> i=1:K
        fprintf(fp,<span class="string">'\t\t\tcase (byte)%s:'</span>,Mess(i).id);
        <span class="comment">%fprintf(fp,'\t\t\t\t%s = new %s_class();\n',Mess(i).name,Mess(i).name);</span>
        fprintf(fp,<span class="string">'\treturn(%s.parse(pkt, valid));\n'</span>,Mess(i).name);
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'\t\t\tdefault:\n\t\t\t\treturn(false);\n'</span>);
    fprintf(fp,<span class="string">'\t\t}\n'</span>);
    fprintf(fp,<span class="string">'\t}\n'</span>);
</pre><h2>Init function<a name="41"></a></h2><pre class="codeinput">    fprintf(fp,<span class="string">'\n\tpublic static void initMessages()\n'</span>);
    fprintf(fp,<span class="string">'\t{\n'</span>);
    <span class="keyword">for</span> i=1:K
        <span class="keyword">if</span> (intersect(i,msgWithSystem))
            fprintf(fp,<span class="string">'\t\t%s.target_system = 1;\n'</span>,Mess(i).name);
        <span class="keyword">end</span>
        <span class="keyword">if</span> (intersect(i,msgWithComponent))
            fprintf(fp,<span class="string">'\t\t%s.target_component = 1;\n'</span>,Mess(i).name);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'\t}\n'</span>);
</pre><h2>List All Messages, All parameters<a name="42"></a></h2><pre>   fprintf(fp,'/*\n');
   for i=1:K
       N = size(Mess(i).fields.name,1);
       ml = 0;
       for j=1:N
           ml = max(ml,8+length(Mess(i).fields.name{j}));
       end
       ml = 4*(ceil(ml/4));
       fprintf(fp,'\t%s\t%s\n',Mess(i).name,Mess(i).fdesc);
       N = size(Mess(i).fields.name,1);
       for j=1:N
           padL = ceil((ml-length(Mess(i).fields.name{j}))/4);
           pad = char(9*ones(1,padL));
           fprintf(fp,'\t\t%s%s%s\n',Mess(i).fields.name{j},pad,Mess(i).fields.desc{j});
       end
   end
   fprintf(fp,'*/\n');</pre><pre class="codeinput">    fprintf(fp,<span class="string">'}\n'</span>);
    fclose(fp);
</pre><h2>Header Object<a name="44"></a></h2><pre class="codeinput">    fp = fopen(sprintf(<span class="string">'%s\\MavHeader.java'</span>,dDir),<span class="string">'w'</span>);
    <span class="keyword">if</span> (~LOCAL)
        fprintf(fp,<span class="string">'package gov.nasa.larc.AP;\n\n'</span>);
    <span class="keyword">end</span>
    <span class="comment">%fprintf(fp,'import java.nio.ByteBuffer;\n\n');</span>
    fprintf(fp,<span class="string">'public class MavHeader\n'</span>);
    fprintf(fp,<span class="string">'{\n'</span>);
</pre><h2>Generate Message Length Array<a name="45"></a></h2><pre class="codeinput">    jSize = zeros(1,256);
    K = length(Mess);
    <span class="keyword">for</span> i=1:K   <span class="comment">% For each MavLink message</span>
        idx = 1+sscanf(Mess(i).id,<span class="string">'%d'</span>);
        jSize(idx) = sum(cell2mat(Mess(i).fields.byte));
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'\t//                                          {'</span>);
    <span class="keyword">for</span> i=1:256
        <span class="keyword">if</span> (mod(i-1,10)==0)
            fprintf(fp,<span class="string">'%3d,'</span>,i-1);
        <span class="keyword">else</span>
            <span class="keyword">if</span> (i==256)
                fprintf(fp,<span class="string">'   '</span>);
            <span class="keyword">else</span>
                fprintf(fp,<span class="string">'   ,'</span>);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'};\n'</span>);
    fprintf(fp,<span class="string">'\tpublic static final byte[] MsgLengthArray = {'</span>);
    <span class="keyword">for</span> i=1:256
        <span class="keyword">if</span> (i==256)
            fprintf(fp,<span class="string">'%3d'</span>,jSize(i));
        <span class="keyword">else</span>
            fprintf(fp,<span class="string">'%3d,'</span>,jSize(i));
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'};\n\n'</span>);
</pre><pre>   fprintf(fp,'\tstatic final short HEADER_SIZE = 6;\n');
   fprintf(fp,'\tstatic final short CHKSUM_SIZE = 2;\n');
   fprintf(fp,'\tstatic final byte  MAV_MARKER  = (byte) 85;\n');
   fprintf(fp,'\tstatic final byte  BEAGLE_ID   = (byte)103;\n');
   fprintf(fp,'\tstatic final byte  AP_ID       = (byte)  1;\n');
   fprintf(fp,'\tstatic final byte  XBEE_ID     = (byte)255;\n');
   fprintf(fp,'\tstatic final byte  COMP_ID     = (byte)  1;\n');</pre><pre>   fprintf(fp,'\n\tboolean vHeader;\n');
   fprintf(fp,'\tbyte msgHead;\n');
   fprintf(fp,'\tbyte msgLen;\n');
   fprintf(fp,'\tbyte msgSeq;\n');
   fprintf(fp,'\tbyte msgSid;\n');
   fprintf(fp,'\tbyte msgCid;\n');
   fprintf(fp,'\tbyte msgGid;\n\n');
   fprintf(fp,'\tstatic byte RcvSeq;\n');
   fprintf(fp,'\tstatic byte PreRcvSeq;\n');
   fprintf(fp,'\tstatic byte SndSeq = 0;\n\n');</pre><h2>Contruct Header from byte[].<a name="48"></a></h2><h2>Usually implies that a packet is being RECEIVED!<a name="49"></a></h2><pre>   fprintf(fp,'\tpublic MavHeader(byte[] hdr)\n\t{\n');
   fprintf(fp,'\t\tvHeader = isValid(hdr);\n');
   fprintf(fp,'\t\tif (!vHeader)\treturn;\n\n');
   fprintf(fp,'\t\tmsgHead = hdr[0];\n');
   fprintf(fp,'\t\tmsgLen  = hdr[1];\n');
   fprintf(fp,'\t\tmsgSeq  = hdr[2];\n');
   fprintf(fp,'\t\tmsgSid  = hdr[3];\n');
   fprintf(fp,'\t\tmsgCid  = hdr[4];\n');
   fprintf(fp,'\t\tmsgGid  = hdr[5];\n');
   fprintf(fp,'\t\tPreRcvSeq = RcvSeq;\n');
   fprintf(fp,'\t\tRcvSeq    = msgSeq;\n');
   fprintf(fp,'\t}\n\n');</pre><h2>Contruct a Header for a Message with ID "mid"<a name="50"></a></h2><h2>Usually implies constructing a packet to be SENT!<a name="51"></a></h2><pre>   fprintf(fp,'\tpublic MavHeader(byte mid)\n\t{\n');
   fprintf(fp,'\t\tvHeader = true;\n');
   fprintf(fp,'\t\tmsgHead = MAV_MARKER;\n');
   fprintf(fp,'\t\tmsgLen  = MsgLengthArray[getMsgID(mid)];\n');
   fprintf(fp,'\t\tmsgSeq  = SndSeq++;\n');
   fprintf(fp,'\t\tmsgSid  = BEAGLE_ID;\n');
   fprintf(fp,'\t\tmsgCid  = COMP_ID;\n');
   fprintf(fp,'\t\tmsgGid  = mid;\n');
   fprintf(fp,'\t}\n\n');</pre><h2>Identifies a valid RECEIVED header<a name="52"></a></h2><pre>   fprintf(fp,'\tpublic boolean isValid(byte[] hdr)\n\t{\n');
   fprintf(fp,'\t\tif (hdr.length&lt;HEADER_SIZE)\treturn(false);\n');
   fprintf(fp,'\t\treturn ((hdr[0]==MAV_MARKER)\n');
   fprintf(fp,'\t\t      &amp;&amp;(hdr[1]==MsgLengthArray[getMsgID(hdr)])\n');
   fprintf(fp,'\t\t      &amp;&amp;(hdr[3]==AP_ID)||(hdr[3]==XBEE_ID)||(hdr[3]==BEAGLE_ID)\n');
   fprintf(fp,'\t\t      &amp;&amp;(hdr[4]==COMP_ID));\n');
   fprintf(fp,'\t}\n\n');</pre><pre>   fprintf(fp,'\tpublic boolean isValid()\n\t{\n');
   fprintf(fp,'\t\treturn(vHeader);\n');
   fprintf(fp,'\t}\n\n');</pre><h2>Returns the header as a byte array<a name="54"></a></h2><pre>   fprintf(fp,'\tpublic byte[] getHeader()\n\t{\n');
   fprintf(fp,'\t\tbyte[] hdr = {msgHead,msgLen,msgSeq,msgSid,msgCid,msgGid};\n');
   fprintf(fp,'\t\treturn(hdr);\n');
   fprintf(fp,'\t}\n\n');</pre><pre>   fprintf(fp,'\tpublic short getMsgHead(byte[] hdr)\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr[0]).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgHead()\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,msgHead).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgLength(byte[] hdr)\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr[1]).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgLength()\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,msgLen).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgLength(short idx)\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,MsgLengthArray[idx]).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getFullLength()\n\t{\n');
   fprintf(fp,'\t\treturn (short)(getMsgLength()+HEADER_SIZE+CHKSUM_SIZE);\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getFullLength(short idx)\n\t{\n');
   fprintf(fp,'\t\treturn (short)(getMsgLength(idx)+HEADER_SIZE+CHKSUM_SIZE);\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgSeq(byte[] hdr)\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr[2]).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgSeq()\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,msgSeq).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgSysID(byte[] hdr)\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr[3]).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgSysID()\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,msgSid).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgCompID(byte[] hdr)\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr[4]).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgCompID()\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,msgCid).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgID(byte[] hdr)\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr[5]).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgID()\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,msgGid).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getMsgID(byte hdr)\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr).getShort(0));\n');
   fprintf(fp,'\t}\n\n');</pre><pre>   fprintf(fp,'\tpublic short getRcvSeq()\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,RcvSeq).getShort(0));\n');
   fprintf(fp,'\t}\n\n');
   fprintf(fp,'\tpublic short getPreRcvSeq()\n\t{\n');
   fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
   fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,PreRcvSeq).getShort(0));\n');
   fprintf(fp,'\t}\n\n');</pre><pre class="codeinput">    fprintf(fp,<span class="string">'}\n'</span>);
    fclose(fp); fp = [];
</pre><h2>MavLink CheckSum Class<a name="56"></a></h2><pre>   fp = fopen(sprintf('%s\\src\\MavCheckSum.java',dDir),'w');
   if (~LOCAL)
       fprintf(fp,'package gov.nasa.larc.MavLink_0_9;\n\n');
   end
   fprintf(fp,'import java.nio.ByteBuffer;\n\n');
   fprintf(fp,'public class MavCheckSum\n');
   fprintf(fp,'{\n');
%     fprintf(fp,'\tprotected byte[] temp = {0,0,0,0,0,0,0,0};\n');
%     fprintf(fp,'\tprotected ByteBuffer t = ByteBuffer.wrap(temp);\n\n');</pre><pre>   %%
   fprintf(fp,'\tpublic static boolean isValid(byte[] pkt)\n');
   fprintf(fp,'\t{\n');
   fprintf(fp,'\t\tshort crc;\n');
   fprintf(fp,'\t\tshort pktCRC;\n');
   fprintf(fp,'\t\tByteBuffer pktb = ByteBuffer.wrap(pkt);\n\n');
   fprintf(fp,'\t\tbyte N = (byte)pkt.length;\n');
   fprintf(fp,'\t\tpktCRC = pktb.getShort(N-2);\n');
   fprintf(fp,'\t\tcrc = getChecksum(pkt);\n');
   fprintf(fp,'\t\treturn (boolean)(pktCRC==crc);\n');
   fprintf(fp,'\t}\n\n');</pre><pre>   %%  Generate getChecksum function
   fprintf(fp,'\t//=====================================================================================//\n');
   fprintf(fp,'\t/**\n');
   fprintf(fp,'\t * compute the checksum for a given message.  Use the indicated number of bytes starting\n');
   fprintf(fp,'\t * at the second byte.\n');
   fprintf(fp,'\t * @param msg\n');
   fprintf(fp,'\t * @return checksum: 2 byte checksum\n');
   fprintf(fp,'\t */\n');
   fprintf(fp,'\t//=====================================================================================//\n');
   fprintf(fp,'\tpublic static short getChecksum(byte[] data) \n');
   fprintf(fp,'\t{\n');
   fprintf(fp,'\t    int N   = data.length;\n');
   fprintf(fp,'\t    byte b  = 0x00;\n');
   fprintf(fp,'\t    byte ch = 0x00;\n');
   fprintf(fp,'\t    short crc  = (short) 0xffff;\n');
%     fprintf(fp,'\t    short ooff = (short) 0x00ff;    //255;\n');
   fprintf(fp,'\t    short tempcrc = 0x0000;\n');
   fprintf(fp,'\t    for (int i=1; i&lt;N-2; i++)\n');
   fprintf(fp,'\t    {\n');
   fprintf(fp,'\t        b = data[i];\n');
   fprintf(fp,'\t        ch = (byte) (b  ^  ((byte)(crc &amp; 0x00ff) ))  ;\n');
   fprintf(fp,'\t        ch = (byte) ((ch ^ (ch &lt;&lt; 4) ));\n');
   fprintf(fp,'\t        tempcrc = (short) (crc &gt;&gt; 8);\n');
   fprintf(fp,'\t        tempcrc = (short) (tempcrc &amp; 0x00ff);\n');
   fprintf(fp,'\t        short a1 = (short) ((short)ch &lt;&lt; 8);\n');
   fprintf(fp,'\t        short a2 = (short) (tempcrc ^ a1);\n');
   fprintf(fp,'\t        short a3 = (short) ((short)ch &lt;&lt; 3);\n');
   fprintf(fp,'\t        short a3a = (short) (a3 &amp; 0x07ff);\n');
   fprintf(fp,'\t        short a4 = (short) (a2 ^ a3a);\n');
   fprintf(fp,'\t        short a5 = (short) ((short)ch &gt;&gt; 4);\n');
   fprintf(fp,'\t        short a6 = (short) ((short) a5 &amp; 0x000f);\n');
   fprintf(fp,'\t        crc = (short) (a4 ^ a6);\n');
   fprintf(fp,'\t    }\n\n');
%     fprintf(fp,'\t    t.putShort(0,crc);\n');
%     fprintf(fp,'\t    data[N++] = t.get(1);\n');
%     fprintf(fp,'\t    data[N++] = t.get(0);\n');
%     fprintf(fp,'\t    t.putLong(0,zero); // sets ByteBuffer t back to zero\n\n');
   fprintf(fp,'\t    return crc;\n');
   fprintf(fp,'\t}\n');
   fprintf(fp,'}\n\n');
   fclose(fp); fp = [];</pre><p>% function crc = checksum_v0_9(data) %     MAVLINK_MESSAGE_LENGTHS = uint8([3, 4, 8, 14, 8, 28, 3, 32, 0, 2, 3, 2, 2, 0, 0, 0, 0, 0, 0, 0, 19, 2, 23, 21, 0, 37, 26, 101, 26, 16, 32, 32, 37, 32, 11, 17, 17, 16, 18, 36, 4, 4, 2, 2, 4, 2, 2, 3, 14, 12, 18, 16, 8, 27, 25, 18, 18, 24, 24, 0, 0, 0, 26, 16, 36, 5, 6, 56, 26, 21, 18, 0, 0, 18, 20, 20, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 36, 0, 0, 0, 0, 0, 0, 0, 0, 0, 42, 8, 4, 12, 15, 13, 6, 15, 14, 0, 12, 3, 8, 28, 36, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 30, 14, 14, 51, 5]'); %     MAVLINK_MESSAGE_CRCS = uint8([72, 39, 190, 92, 191, 217, 104, 119, 0, 219, 60, 186, 10, 0, 0, 0, 0, 0, 0, 0, 89, 159, 162, 121, 0, 149, 222, 110, 179, 136, 66, 126, 185, 147, 112, 252, 162, 215, 229, 128, 9, 106, 101, 213, 4, 229, 21, 214, 215, 14, 206, 50, 157, 126, 108, 213, 95, 5, 127, 0, 0, 0, 57, 126, 130, 119, 193, 191, 236, 158, 143, 0, 0, 104, 123, 131, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 174, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 155, 0, 0, 0, 0, 0, 0, 0, 0, 0, 143, 29, 208, 188, 118, 242, 19, 97, 233, 0, 18, 68, 136, 205, 42, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 178, 224, 60, 106, 7]'); %     N = length(data); %     b = uint8(0); %     ch = uint8(0); %     crc = uint16(65535); %     ooff = uint16(255); %     for i=1:N %         b = data(i); %         ch = bitxor(b,uint8(bitand(crc,ooff))); %         ch = uint8(bitxor(ch,bitshift(ch,4))); %         crc = uint16(bitxor(bitxor(bitxor(bitshift(crc,-8),bitshift(uint16(ch),8)),bitshift(uint16(ch),3)),bitshift(uint16(ch),-4))); %     end % return</p><pre class="codeinput">    <span class="keyword">switch</span> (VERSION)
        <span class="keyword">case</span> 0.9
            disp(<span class="string">'Done JAVA code for MavLink 0.9'</span>)
        <span class="keyword">case</span> 1.0
            disp(<span class="string">'Done JAVA code for MavLink 1.0'</span>)
        <span class="keyword">otherwise</span>
            disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
            <span class="keyword">return</span>
    <span class="keyword">end</span>
<span class="keyword">return</span>
</pre><pre class="codeoutput">Done JAVA code for MavLink 0.9
</pre><pre class="codeoutput">//	ERROR	Parsing 'satellite_prn' array of 'short' from 'uint8_t[20]' in MESSAGE: 'GPS_STATUS'
//	ERROR	Parsing 'satellite_used' array of 'short' from 'uint8_t[20]' in MESSAGE: 'GPS_STATUS'
//	ERROR	Parsing 'satellite_elevation' array of 'short' from 'uint8_t[20]' in MESSAGE: 'GPS_STATUS'
//	ERROR	Parsing 'satellite_azimuth' array of 'short' from 'uint8_t[20]' in MESSAGE: 'GPS_STATUS'
//	ERROR	Parsing 'satellite_snr' array of 'short' from 'uint8_t[20]' in MESSAGE: 'GPS_STATUS'
//	ERROR	Encoding 'satellite_prn' array of 'short' from 'uint8_t[20]' in MESSAGE: 'GPS_STATUS'
//	ERROR	Encoding 'satellite_used' array of 'short' from 'uint8_t[20]' in MESSAGE: 'GPS_STATUS'
//	ERROR	Encoding 'satellite_elevation' array of 'short' from 'uint8_t[20]' in MESSAGE: 'GPS_STATUS'
//	ERROR	Encoding 'satellite_azimuth' array of 'short' from 'uint8_t[20]' in MESSAGE: 'GPS_STATUS'
//	ERROR	Encoding 'satellite_snr' array of 'short' from 'uint8_t[20]' in MESSAGE: 'GPS_STATUS'
//	ERROR	Parsing 'thrust' array of 'int' from 'uint16_t[4]' in MESSAGE: 'SET_QUAD_SWARM_ROLL_PITCH_YAW_THRUST'
//	ERROR	Encoding 'thrust' array of 'int' from 'uint16_t[4]' in MESSAGE: 'SET_QUAD_SWARM_ROLL_PITCH_YAW_THRUST'
//	ERROR	Parsing 'led_red' array of 'short' from 'uint8_t[4]' in MESSAGE: 'SET_QUAD_SWARM_LED_ROLL_PITCH_YAW_THRUST'
//	ERROR	Parsing 'led_blue' array of 'short' from 'uint8_t[4]' in MESSAGE: 'SET_QUAD_SWARM_LED_ROLL_PITCH_YAW_THRUST'
//	ERROR	Parsing 'led_green' array of 'short' from 'uint8_t[4]' in MESSAGE: 'SET_QUAD_SWARM_LED_ROLL_PITCH_YAW_THRUST'
//	ERROR	Parsing 'thrust' array of 'int' from 'uint16_t[4]' in MESSAGE: 'SET_QUAD_SWARM_LED_ROLL_PITCH_YAW_THRUST'
//	ERROR	Encoding 'led_red' array of 'short' from 'uint8_t[4]' in MESSAGE: 'SET_QUAD_SWARM_LED_ROLL_PITCH_YAW_THRUST'
//	ERROR	Encoding 'led_blue' array of 'short' from 'uint8_t[4]' in MESSAGE: 'SET_QUAD_SWARM_LED_ROLL_PITCH_YAW_THRUST'
//	ERROR	Encoding 'led_green' array of 'short' from 'uint8_t[4]' in MESSAGE: 'SET_QUAD_SWARM_LED_ROLL_PITCH_YAW_THRUST'
//	ERROR	Encoding 'thrust' array of 'int' from 'uint16_t[4]' in MESSAGE: 'SET_QUAD_SWARM_LED_ROLL_PITCH_YAW_THRUST'
//	ERROR	Parsing 'data' array of 'short' from 'uint8_t[90]' in MESSAGE: 'LOG_DATA'
//	ERROR	Encoding 'data' array of 'short' from 'uint8_t[90]' in MESSAGE: 'LOG_DATA'
//	ERROR	Parsing 'data' array of 'short' from 'uint8_t[16]' in MESSAGE: 'DATA16'
//	ERROR	Encoding 'data' array of 'short' from 'uint8_t[16]' in MESSAGE: 'DATA16'
//	ERROR	Parsing 'data' array of 'short' from 'uint8_t[32]' in MESSAGE: 'DATA32'
//	ERROR	Encoding 'data' array of 'short' from 'uint8_t[32]' in MESSAGE: 'DATA32'
//	ERROR	Parsing 'data' array of 'short' from 'uint8_t[64]' in MESSAGE: 'DATA64'
//	ERROR	Encoding 'data' array of 'short' from 'uint8_t[64]' in MESSAGE: 'DATA64'
//	ERROR	Parsing 'data' array of 'short' from 'uint8_t[96]' in MESSAGE: 'DATA96'
//	ERROR	Encoding 'data' array of 'short' from 'uint8_t[96]' in MESSAGE: 'DATA96'
Done JAVA code for MavLink 1.0
</pre><h2>Generate APM Code based on XML data<a name="57"></a></h2><pre class="codeinput"><span class="keyword">function</span> genAPMCode(Mess)
</pre><pre class="codeinput">    <span class="keyword">global</span> SWAP;
    <span class="keyword">global</span> VERSION;
    <span class="keyword">if</span> (SWAP)
        disp(<span class="string">'Offset SWAPPING'</span>)
    <span class="keyword">end</span>
    <span class="keyword">switch</span> (VERSION)
        <span class="keyword">case</span> 0.9
            <span class="comment">%dDir = 'G:\\ArduRepo\\libraries\\GCS_MAVLink\\include\\common';</span>
            dDir = <span class="string">'AP\\include\\common'</span>;
        <span class="keyword">case</span> 1.0
            <span class="comment">%dDir = 'G:\\ArduRepo\\libraries\\GCS_MAVLink\\include_v1.0\\common';</span>
            dDir = <span class="string">'AP\\include_v1.0\\common'</span>;
        <span class="keyword">otherwise</span>
            disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
            <span class="keyword">return</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> (isempty(dir(dDir)))
        mkdir(dDir);
    <span class="keyword">end</span>
    <span class="comment">%dDir = 'APM\\ap';</span>
    <span class="keyword">if</span> (isempty(dir(dDir)))
        mkdir(dDir);
    <span class="keyword">end</span>
</pre><h2>initialization<a name="60"></a></h2><h2>Generate function header<a name="61"></a></h2><pre class="codeinput">    K = length(Mess);
    MAVLINK_MESSAGE_LENGTHS = zeros(1,256);
    MAVLINK_MESSAGE_INFO = cell(1,256);
    <span class="keyword">for</span> i=1:256
        MAVLINK_MESSAGE_INFO{i} = <span class="string">'{NULL}'</span>;
    <span class="keyword">end</span>

    <span class="keyword">for</span> i=1:K   <span class="comment">% For each MavLink message</span>
</pre><pre class="codeinput">        N = size(Mess(i).fields.name,1);
        ID = sscanf(Mess(i).id,<span class="string">'%d'</span>);
        IDX=Mess(i).fields.idx;

        packetSize = sum(cell2mat(Mess(i).fields.apmByte));
</pre><h2>Message Length Array<a name="63"></a></h2><pre class="codeinput">        MAVLINK_MESSAGE_LENGTHS(ID+1) = packetSize;
        MAVLINK_MESSAGE_INFO{ID+1} = sprintf(<span class="string">'MAVLINK_MESSAGE_INFO_%s'</span>,Mess(i).name);
</pre><h2>Do MavLink to APM types substitution<a name="64"></a></h2><pre class="codeinput">        APM.name = Mess(i).fields.name;
        APM.type = Mess(i).fields.apmType;
        APM.byte = Mess(i).fields.apmByte;
        APM.desc = Mess(i).fields.desc;
        APM.array = Mess(i).fields.Array;
        APM.uoffset = Mess(i).fields.uoffset;
        APM.soffset = Mess(i).fields.soffset;

<span class="comment">%         %% Include file Array</span>
<span class="comment">%         fprintf(mif,sprintf('#include "./mavlink_msg_%s.h"\n',lower(Mess(i).name)));</span>
<span class="comment">%</span>
</pre><h2>Function Header<a name="65"></a></h2><pre class="codeinput">        newf = sprintf(<span class="string">'%s\\mavlink_msg_%s.h'</span>,dDir,lower(Mess(i).name));
        fp = fopen(newf,<span class="string">'w'</span>);
        fprintf(fp,sprintf(<span class="string">'// MESSAGE %s PACKING\n'</span>,Mess(i).name));
        fprintf(fp,<span class="string">'// Generated from parse_APM_XML.m on 24-Feb-2014 13:50:53\n\n'</span>);
        <span class="comment">%fprintf(fp,sprintf('// Generated from parse_APM_XML.m on %s\n\n',datestr(clock)));</span>

        fprintf(fp,sprintf(<span class="string">'#define MAVLINK_MSG_ID_%s %d \n\n'</span>,Mess(i).name,ID));
</pre><h2>define structure for message<a name="66"></a></h2><pre class="codeinput">        fprintf(fp,sprintf(<span class="string">'typedef struct __mavlink_%s_t \n'</span>,lower(Mess(i).name)));
        fprintf(fp,<span class="string">'{ \n'</span>);
        <span class="keyword">for</span> j=1:N
            <span class="keyword">if</span> (APM.array{j})
                <span class="keyword">if</span> (SWAP)
                    fprintf(fp,<span class="string">'  %s %s[%d];  ///&lt; %s\n'</span>,APM.type{IDX(j)}, APM.name{IDX(j)}, APM.array{IDX(j)}, APM.desc{IDX(j)});
                <span class="keyword">else</span>
                    fprintf(fp,<span class="string">'  %s %s[%d];  ///&lt; %s\n'</span>,APM.type{j}     , APM.name{j}     , APM.array{j}     , APM.desc{j});
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                <span class="keyword">if</span> (SWAP)
                    fprintf(fp,<span class="string">'  %s %s;  ///&lt; %s\n'</span>,APM.type{IDX(j)}, APM.name{IDX(j)}, APM.desc{IDX(j)});
                <span class="keyword">else</span>
                    fprintf(fp,<span class="string">'  %s %s;  ///&lt; %s\n'</span>,APM.type{j}     , APM.name{j}     , APM.desc{j});
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        fprintf(fp,sprintf(<span class="string">'} mavlink_%s_t;\n\n'</span>,lower(Mess(i).name)));
</pre><h2>define Message Length<a name="67"></a></h2><pre class="codeinput">        fprintf(fp,sprintf(<span class="string">'#define MAVLINK_MSG_ID_%s_LEN %d\n'</span>,Mess(i).name,packetSize));
        fprintf(fp,sprintf(<span class="string">'#define MAVLINK_MSG_ID_%d_LEN %d\n\n'</span>,ID,packetSize));
</pre><h2>define CRC Message Length<a name="68"></a></h2><pre class="codeinput">        <span class="keyword">if</span> (VERSION == 1.0)
            crcSize = 0;    <span class="comment">%% dummy CRC size, needs to be determined</span>
            fprintf(fp,sprintf(<span class="string">'#define MAVLINK_MSG_ID_%s_CRC %d\n'</span>,Mess(i).name,crcSize));
            fprintf(fp,sprintf(<span class="string">'#define MAVLINK_MSG_ID_%d_CRC %d\n\n'</span>,ID,crcSize));
        <span class="keyword">end</span>
</pre><h2>define Message INFO structure<a name="69"></a></h2><pre class="codeinput">        fprintf(fp,sprintf(<span class="string">'#define MAVLINK_MESSAGE_INFO_%s \\\\\n{ \\\\\n'</span>,Mess(i).name));
        fprintf(fp,sprintf(<span class="string">'  "%s", \\\\\n'</span>,Mess(i).name));
        fprintf(fp,sprintf(<span class="string">'  %d, \\\\\n'</span>,N));
        fprintf(fp,sprintf(<span class="string">'  { \\\\\n'</span>));
<span class="comment">%         voff = 0;</span>
        <span class="keyword">for</span> j=1:N
            <span class="keyword">if</span> (SWAP)
                fprintf(fp,sprintf(<span class="string">'    { "%s", NULL, MAVLINK_TYPE_%s, %d, %d, offsetof(mavlink_%s_t, %s) }, \\\\\n'</span>, APM.name{IDX(j)}, upper(APM.type{IDX(j)}), APM.array{IDX(j)}, APM.soffset(IDX(j)), lower(Mess(i).name), APM.name{IDX(j)}));
            <span class="keyword">else</span>
                fprintf(fp,sprintf(<span class="string">'    { "%s", NULL, MAVLINK_TYPE_%s, %d, %d, offsetof(mavlink_%s_t, %s) }, \\\\\n'</span>, APM.name{j}     , upper(APM.type{j})     , APM.array{j}     , APM.uoffset(j)     , lower(Mess(i).name), APM.name{j}));
            <span class="keyword">end</span>
<span class="comment">%             if (SWAP)</span>
<span class="comment">%                 voff = voff + APM.byte{IDX(j)};</span>
<span class="comment">%             else</span>
<span class="comment">%                 voff = voff + APM.byte{j};</span>
<span class="comment">%             end</span>
        <span class="keyword">end</span>
        fprintf(fp,sprintf(<span class="string">'  } \\\\\n'</span>));
        fprintf(fp,sprintf(<span class="string">'}\n\n'</span>));
</pre><h2>Function Header - mavlink_msg_xxx_pack<a name="70"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'/**\n'</span>);
        fprintf(fp,sprintf(<span class="string">' * @brief Pack a %s message\n'</span>,lower(Mess(i).name)));
        fprintf(fp,<span class="string">' * @param system_id ID of this system\n'</span>);
        fprintf(fp,<span class="string">' * @param component_id ID of this component (e.g. 200 for IMU)\n'</span>);
        fprintf(fp,<span class="string">' * @param msg The MAVLink message to compress the data into\n'</span>);
        fprintf(fp,<span class="string">' *\n'</span>);
        <span class="keyword">for</span> j=1:N
            fprintf(fp,sprintf(<span class="string">' * @param %s %s\n'</span>, APM.name{j}, APM.desc{j}));
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">' * @return length of the message in bytes (excluding serial stream start sign)\n'</span>);
        fprintf(fp,<span class="string">' */\n'</span>);
</pre><h2>Function Declaration<a name="71"></a></h2><pre class="codeinput">        fprintf(fp,sprintf(<span class="string">'static inline uint16_t mavlink_msg_%s_pack(\n'</span>,lower(Mess(i).name)));
        fprintf(fp,<span class="string">'\t uint8_t system_id\n\t,uint8_t component_id\n\t,mavlink_message_t* msg\n'</span>);
        <span class="keyword">for</span> j=1:N
            <span class="comment">%if ((ID~=0) || ((ID==0)&amp;&amp;(j&lt;N))) %% Heartbeat Message special processing</span>
                <span class="keyword">if</span> (APM.array{j} &gt; 0)
                    fprintf(fp,sprintf(<span class="string">'\t,const %s* %s\n'</span>, APM.type{j}, APM.name{j}));
                <span class="keyword">else</span>
                    fprintf(fp,sprintf(<span class="string">'\t,%s %s\n'</span>, APM.type{j}, APM.name{j}));
                <span class="keyword">end</span>
            <span class="comment">%end</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'\t)\n{\n'</span>);
</pre><h2>Function Body<a name="72"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'#if MAVLINK_NEED_BYTE_SWAP || !MAVLINK_ALIGNED_FIELDS\n'</span>);
        fprintf(fp,sprintf(<span class="string">'\tchar buf[MAVLINK_MSG_ID_%s_LEN];\n'</span>,Mess(i).name));
<span class="comment">%         voff = 0;</span>
        <span class="keyword">for</span> j=1:N
            <span class="comment">%if ((ID==0) &amp;&amp; (j==N)) %% Heartbeat Message special processing</span>
            <span class="comment">%    fprintf(fp,sprintf('\t_mav_put_%s(buf, %d, 2);\n',APM.type{j},voff));</span>
            <span class="comment">%else</span>
            <span class="keyword">if</span> (APM.array{j} &gt; 0)
                <span class="keyword">if</span> (SWAP)
                    fprintf(fp,sprintf(<span class="string">'\t_mav_put_%s_array(buf, %d, %s, %d);\n'</span>,APM.type{IDX(j)},APM.soffset(IDX(j)),APM.name{IDX(j)},APM.array{IDX(j)}));
                <span class="keyword">else</span>
                    fprintf(fp,sprintf(<span class="string">'\t_mav_put_%s_array(buf, %d, %s, %d);\n'</span>,APM.type{j}     ,APM.uoffset(j)     ,APM.name{j}     ,APM.array{j}));
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                <span class="keyword">if</span> (SWAP)
                    fprintf(fp,sprintf(<span class="string">'\t_mav_put_%s(buf, %d, %s);\n'</span>,APM.type{IDX(j)},APM.soffset(IDX(j)),APM.name{IDX(j)}));
                <span class="keyword">else</span>
                    fprintf(fp,sprintf(<span class="string">'\t_mav_put_%s(buf, %d, %s);\n'</span>,APM.type{j}     ,APM.uoffset(j)     ,APM.name{j}));
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="comment">%end</span>
<span class="comment">%             if (SWAP)</span>
<span class="comment">%                 voff = voff + APM.byte{IDX(j)};</span>
<span class="comment">%             else</span>
<span class="comment">%                 voff = voff + APM.byte{j};</span>
<span class="comment">%             end</span>
        <span class="keyword">end</span>

        <span class="keyword">switch</span> (VERSION)
            <span class="keyword">case</span> 0.9
                fprintf(fp,sprintf(<span class="string">'\n\tmemcpy(_MAV_PAYLOAD(msg), buf, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name));
            <span class="keyword">case</span> 1.0
                fprintf(fp,sprintf(<span class="string">'\n\tmemcpy(_MAV_PAYLOAD_NON_CONST(msg), buf, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name));
            <span class="keyword">otherwise</span>
                disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
                <span class="keyword">return</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'#else\n'</span>);
        fprintf(fp,sprintf(<span class="string">'\tmavlink_%s_t packet;\n'</span>,lower(Mess(i).name)));
        <span class="keyword">for</span> j=1:N
            <span class="comment">%if ((ID==0) &amp;&amp; (j==N)) %% Heartbeat Message special processing</span>
            <span class="comment">%    fprintf(fp,sprintf('\tpacket.%s = 2;\n',APM.name{j}));</span>
            <span class="comment">%else</span>
            <span class="keyword">if</span> (APM.array{j} &gt; 0)
                <span class="keyword">if</span> (SWAP)
                    fprintf(fp,sprintf(<span class="string">'\tmav_array_memcpy(packet.%s, %s, sizeof(%s)*%d);\n'</span>,APM.name{IDX(j)},APM.name{IDX(j)},APM.type{IDX(j)},APM.array{IDX(j)}));
                <span class="keyword">else</span>
                    fprintf(fp,sprintf(<span class="string">'\tmav_array_memcpy(packet.%s, %s, sizeof(%s)*%d);\n'</span>,APM.name{j},APM.name{j},APM.type{j},APM.array{j}));
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                <span class="keyword">if</span> (SWAP)
                    fprintf(fp,sprintf(<span class="string">'\tpacket.%s = %s;\n'</span>,APM.name{IDX(j)},APM.name{IDX(j)}));
                <span class="keyword">else</span>
                    fprintf(fp,sprintf(<span class="string">'\tpacket.%s = %s;\n'</span>,APM.name{j},APM.name{j}));
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="comment">%end</span>
        <span class="keyword">end</span>

        <span class="keyword">switch</span> (VERSION)
            <span class="keyword">case</span> 0.9
                fprintf(fp,sprintf(<span class="string">'\n\tmemcpy(_MAV_PAYLOAD(msg), &amp;packet, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name));
            <span class="keyword">case</span> 1.0
                fprintf(fp,sprintf(<span class="string">'\n\tmemcpy(_MAV_PAYLOAD_NON_CONST(msg), &amp;packet, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name));
            <span class="keyword">otherwise</span>
                disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
                <span class="keyword">return</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'#endif\n'</span>);

        fprintf(fp,sprintf(<span class="string">'\n\tmsg-&gt;msgid = MAVLINK_MSG_ID_%s;\n'</span>,Mess(i).name));
        <span class="keyword">switch</span> (VERSION)
            <span class="keyword">case</span> 0.9
                fprintf(fp,sprintf(<span class="string">'\treturn mavlink_finalize_message(msg, system_id, component_id, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name));
            <span class="keyword">case</span> 1.0
                fprintf(fp,<span class="string">'#if MAVLINK_CRC_EXTRA\n'</span>);
                fprintf(fp,sprintf(<span class="string">'\treturn mavlink_finalize_message(msg, system_id, component_id, MAVLINK_MSG_ID_%s_LEN, MAVLINK_MSG_ID_%s_CRC);\n'</span>,Mess(i).name,Mess(i).name));
                fprintf(fp,<span class="string">'#else\n'</span>);
                fprintf(fp,sprintf(<span class="string">'\treturn mavlink_finalize_message(msg, system_id, component_id, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name));
                fprintf(fp,<span class="string">'#endif\n'</span>);
            <span class="keyword">otherwise</span>
                disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
                <span class="keyword">return</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'}\n\n'</span>);
</pre><h2>Function Header - mavlink_msg_xxx_pack_chan<a name="73"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'/**\n'</span>);
        fprintf(fp,sprintf(<span class="string">' * @brief Pack a %s message on a channel\n'</span>,lower(Mess(i).name)));
        fprintf(fp,<span class="string">' * @param system_id ID of this system\n'</span>);
        fprintf(fp,<span class="string">' * @param component_id ID of this component (e.g. 200 for IMU)\n'</span>);
        fprintf(fp,<span class="string">' * @param chan The MAVLink channel this message was sent over\n'</span>);
        fprintf(fp,<span class="string">' * @param msg The MAVLink message to compress the data into\n'</span>);
        fprintf(fp,<span class="string">' *\n'</span>);
        <span class="keyword">for</span> j=1:N
            fprintf(fp,sprintf(<span class="string">' * @param %s %s\n'</span>, APM.name{j}, APM.desc{j}));
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">' * @return length of the message in bytes (excluding serial stream start sign)\n'</span>);
        fprintf(fp,<span class="string">' */\n'</span>);
</pre><h2>Function Declaration<a name="74"></a></h2><pre class="codeinput">        fprintf(fp,sprintf(<span class="string">'static inline uint16_t mavlink_msg_%s_pack_chan(\n'</span>,lower(Mess(i).name)));
        fprintf(fp,<span class="string">'\t uint8_t system_id\n\t,uint8_t component_id\n\t,uint8_t chan\n\t,mavlink_message_t* msg\n'</span>);
        <span class="keyword">for</span> j=1:N
            <span class="comment">%if ((ID~=0) || ((ID==0)&amp;&amp;(j&lt;N))) %% Heartbeat Message special processing</span>
                <span class="keyword">if</span> (APM.array{j} &gt; 0)
                    fprintf(fp,sprintf(<span class="string">'\t,const %s* %s\n'</span>, APM.type{j}, APM.name{j}));
                <span class="keyword">else</span>
                    fprintf(fp,sprintf(<span class="string">'\t,%s %s\n'</span>, APM.type{j}, APM.name{j}));
                <span class="keyword">end</span>
            <span class="comment">%end</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'\t)\n{\n'</span>);
</pre><h2>Function Body<a name="75"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'#if MAVLINK_NEED_BYTE_SWAP || !MAVLINK_ALIGNED_FIELDS\n'</span>);
        fprintf(fp,sprintf(<span class="string">'\tchar buf[MAVLINK_MSG_ID_%s_LEN];\n'</span>,Mess(i).name));
<span class="comment">%         voff = 0;</span>
        <span class="keyword">for</span> j=1:N
            <span class="comment">%if ((ID==0) &amp;&amp; (j==N)) %% Heartbeat Message special processing</span>
            <span class="comment">%    fprintf(fp,sprintf('\t_mav_put_%s(buf, %d, 2);\n',APM.type{j},voff));</span>
            <span class="comment">%else</span>
                <span class="keyword">if</span> (APM.array{j} &gt; 0)
                    <span class="keyword">if</span> (SWAP)
                        fprintf(fp,sprintf(<span class="string">'\t_mav_put_%s_array(buf, %d, %s, %d);\n'</span>,APM.type{IDX(j)},APM.soffset(IDX(j)),APM.name{IDX(j)},APM.array{IDX(j)}));
                    <span class="keyword">else</span>
                        fprintf(fp,sprintf(<span class="string">'\t_mav_put_%s_array(buf, %d, %s, %d);\n'</span>,APM.type{j}     ,APM.uoffset(j)     ,APM.name{j}     ,APM.array{j}));
                    <span class="keyword">end</span>
                <span class="keyword">else</span>
                    <span class="keyword">if</span> (SWAP)
                        fprintf(fp,sprintf(<span class="string">'\t_mav_put_%s(buf, %d, %s);\n'</span>,APM.type{IDX(j)},APM.soffset(IDX(j)),APM.name{IDX(j)}));
                    <span class="keyword">else</span>
                        fprintf(fp,sprintf(<span class="string">'\t_mav_put_%s(buf, %d, %s);\n'</span>,APM.type{j}     ,APM.uoffset(j)     ,APM.name{j}));
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="comment">%end</span>
<span class="comment">%             if (SWAP)</span>
<span class="comment">%                 voff = voff + APM.byte{IDX(j)};</span>
<span class="comment">%             else</span>
<span class="comment">%                 voff = voff + APM.byte{j};</span>
<span class="comment">%             end</span>
        <span class="keyword">end</span>

        <span class="keyword">switch</span> (VERSION)
            <span class="keyword">case</span> 0.9
                fprintf(fp,sprintf(<span class="string">'\n\tmemcpy(_MAV_PAYLOAD(msg), buf, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name));
            <span class="keyword">case</span> 1.0
                fprintf(fp,sprintf(<span class="string">'\n\tmemcpy(_MAV_PAYLOAD_NON_CONST(msg), buf, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name));
            <span class="keyword">otherwise</span>
                disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
                <span class="keyword">return</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'#else\n'</span>);
        fprintf(fp,sprintf(<span class="string">'\tmavlink_%s_t packet;\n'</span>,lower(Mess(i).name)));
        <span class="keyword">for</span> j=1:N
            <span class="comment">%if ((ID==0) &amp;&amp; (j==N)) %% Heartbeat Message special processing</span>
            <span class="comment">%    fprintf(fp,sprintf('\tpacket.%s = 2;\n',APM.name{j}));</span>
            <span class="comment">%else</span>
                <span class="keyword">if</span> (APM.array{j} &gt; 0)
                    fprintf(fp,sprintf(<span class="string">'\tmav_array_memcpy(packet.%s, %s, sizeof(%s)*%d);\n'</span>,APM.name{j},APM.name{j},APM.type{j},APM.array{j}));
                <span class="keyword">else</span>
                    fprintf(fp,sprintf(<span class="string">'\tpacket.%s = %s;\n'</span>,APM.name{j},APM.name{j}));
                <span class="keyword">end</span>
            <span class="comment">%end</span>
        <span class="keyword">end</span>

        <span class="keyword">switch</span> (VERSION)
            <span class="keyword">case</span> 0.9
                fprintf(fp,sprintf(<span class="string">'\n\tmemcpy(_MAV_PAYLOAD(msg), &amp;packet, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name));
            <span class="keyword">case</span> 1.0
                fprintf(fp,sprintf(<span class="string">'\n\tmemcpy(_MAV_PAYLOAD_NON_CONST(msg), &amp;packet, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name));
            <span class="keyword">otherwise</span>
                disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
                <span class="keyword">return</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'#endif\n'</span>);

        fprintf(fp,sprintf(<span class="string">'\n\tmsg-&gt;msgid = MAVLINK_MSG_ID_%s;\n'</span>,Mess(i).name));
        <span class="keyword">switch</span> (VERSION)
            <span class="keyword">case</span> 0.9
                fprintf(fp,sprintf(<span class="string">'\treturn mavlink_finalize_message_chan(msg, system_id, component_id, chan, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name));
            <span class="keyword">case</span> 1.0
                fprintf(fp,<span class="string">'#if MAVLINK_CRC_EXTRA\n'</span>);
                fprintf(fp,sprintf(<span class="string">'\treturn mavlink_finalize_message_chan(msg, system_id, component_id, chan, MAVLINK_MSG_ID_%s_LEN, MAVLINK_MSG_ID_%s_CRC);\n'</span>,Mess(i).name,Mess(i).name));
                fprintf(fp,<span class="string">'#else\n'</span>);
                fprintf(fp,sprintf(<span class="string">'\treturn mavlink_finalize_message_chan(msg, system_id, component_id, chan, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name));
                fprintf(fp,<span class="string">'#endif\n'</span>);
            <span class="keyword">otherwise</span>
                disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
                <span class="keyword">return</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'}\n\n'</span>);
</pre><h2>Function Header - mavlink_msg_xxx_encode<a name="76"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'/**\n'</span>);
        fprintf(fp,sprintf(<span class="string">' * @brief Encode a %s struct into a message\n'</span>,lower(Mess(i).name)));
        fprintf(fp,<span class="string">' *\n'</span>);
        fprintf(fp,<span class="string">' * @param system_id ID of this system\n'</span>);
        fprintf(fp,<span class="string">' * @param component_id ID of this component (e.g. 200 for IMU)\n'</span>);
        fprintf(fp,<span class="string">' * @param msg The MAVLink message to compress the data into\n'</span>);
        fprintf(fp,<span class="string">' * @param %s C-struct to read the message contents from\n'</span>,lower(Mess(i).name));
        fprintf(fp,<span class="string">' */\n'</span>);
</pre><h2>Function Declaration<a name="77"></a></h2><pre class="codeinput">        fprintf(fp,sprintf(<span class="string">'static inline uint16_t mavlink_msg_%s_encode(\n'</span>,lower(Mess(i).name)));
        fprintf(fp,<span class="string">'\t uint8_t system_id\n\t,uint8_t component_id\n\t,mavlink_message_t* msg\n'</span>);
        fprintf(fp,sprintf(<span class="string">'\t,const mavlink_%s_t* %s\n'</span>,lower(Mess(i).name),lower(Mess(i).name)));
        fprintf(fp,<span class="string">'\t)\n{\n'</span>);
</pre><h2>Function Body<a name="78"></a></h2><pre class="codeinput">        fprintf(fp,sprintf(<span class="string">'\treturn mavlink_msg_%s_pack(\n'</span>,lower(Mess(i).name)));
        fprintf(fp,<span class="string">'\t system_id\n\t,component_id\n\t,msg\n'</span>);
        <span class="keyword">for</span> j=1:N
            <span class="comment">%if ((ID~=0) || ((ID==0)&amp;&amp;(j&lt;N))) %% Heartbeat Message special processing</span>
                fprintf(fp,sprintf(<span class="string">'\t,%s-&gt;%s\n'</span>,lower(Mess(i).name),APM.name{j}));
            <span class="comment">%end</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'\t);\n}\n\n'</span>);
</pre><h2>Function Header - mavlink_msg_xxx_encode_chan<a name="79"></a></h2><pre class="codeinput">        <span class="keyword">if</span> (VERSION == 1.0)
</pre><pre class="codeinput">            fprintf(fp,<span class="string">'/**\n'</span>);
            fprintf(fp,sprintf(<span class="string">' * @brief Encode a %s struct on a channel\n'</span>,lower(Mess(i).name)));
            fprintf(fp,<span class="string">' *\n'</span>);
            fprintf(fp,<span class="string">' * @param system_id ID of this system\n'</span>);
            fprintf(fp,<span class="string">' * @param component_id ID of this component (e.g. 200 for IMU)\n'</span>);
            fprintf(fp,<span class="string">' * @param chan The MAVLink channel this message will be sent over\n'</span>);
            fprintf(fp,<span class="string">' * @param msg The MAVLink message to compress the data into\n'</span>);
            fprintf(fp,<span class="string">' * @param %s C-struct to read the message contents from\n'</span>,lower(Mess(i).name));
            fprintf(fp,<span class="string">' */\n'</span>);
</pre><h2>Function Declaration<a name="81"></a></h2><pre class="codeinput">            fprintf(fp,sprintf(<span class="string">'static inline uint16_t mavlink_msg_%s_encode_chan(\n'</span>,lower(Mess(i).name)));
            fprintf(fp,<span class="string">'\t uint8_t system_id\n\t,uint8_t component_id\n\t,uint8_t chan\n\t,mavlink_message_t* msg\n'</span>);
            fprintf(fp,sprintf(<span class="string">'\t,const mavlink_%s_t* %s\n'</span>,lower(Mess(i).name),lower(Mess(i).name)));
            fprintf(fp,<span class="string">'\t)\n{\n'</span>);
</pre><h2>Function Body<a name="82"></a></h2><pre class="codeinput">            fprintf(fp,sprintf(<span class="string">'\treturn mavlink_msg_%s_pack_chan(\n'</span>,lower(Mess(i).name)));
            fprintf(fp,<span class="string">'\t system_id\n\t,component_id\n\t,chan\n\t,msg\n'</span>);
            <span class="keyword">for</span> j=1:N
                <span class="comment">%if ((ID~=0) || ((ID==0)&amp;&amp;(j&lt;N))) %% Heartbeat Message special processing</span>
                    fprintf(fp,sprintf(<span class="string">'\t,%s-&gt;%s\n'</span>,lower(Mess(i).name),APM.name{j}));
                <span class="comment">%end</span>
            <span class="keyword">end</span>
            fprintf(fp,<span class="string">'\t);\n}\n\n'</span>);
</pre><pre class="codeinput">        <span class="keyword">end</span>
</pre><h2>Function Header - mavlink_msg_xxx_send<a name="84"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'/**\n'</span>);
        fprintf(fp,sprintf(<span class="string">' * @brief Send a %s message\n'</span>,lower(Mess(i).name)));
        fprintf(fp,<span class="string">' * @param chan The MAVLink channel to send this message\n'</span>);
        fprintf(fp,<span class="string">' *\n'</span>);
        <span class="keyword">for</span> j=1:N
            fprintf(fp,sprintf(<span class="string">' * @param %s %s\n'</span>, APM.name{j}, APM.desc{j}));
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">' */\n'</span>);
</pre><h2>Function Declaration<a name="85"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'#ifdef MAVLINK_USE_CONVENIENCE_FUNCTIONS\n\n'</span>);
        fprintf(fp,sprintf(<span class="string">'static inline void mavlink_msg_%s_send(\n'</span>,lower(Mess(i).name)));
        fprintf(fp,<span class="string">'\t mavlink_channel_t chan\n'</span>);
        <span class="keyword">for</span> j=1:N
            <span class="comment">%if ((ID~=0) || ((ID==0)&amp;&amp;(j&lt;N))) %% Heartbeat Message special processing</span>
                <span class="keyword">if</span> (APM.array{j} &gt; 0)
                    fprintf(fp,sprintf(<span class="string">'\t,const %s* %s\n'</span>, APM.type{j}, APM.name{j}));
                <span class="keyword">else</span>
                    fprintf(fp,sprintf(<span class="string">'\t,%s %s\n'</span>, APM.type{j}, APM.name{j}));
                <span class="keyword">end</span>
            <span class="comment">%end</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'\t)\n{\n'</span>);
</pre><h2>Function Body<a name="86"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'#if MAVLINK_NEED_BYTE_SWAP || !MAVLINK_ALIGNED_FIELDS\n'</span>);
        fprintf(fp,sprintf(<span class="string">'\tchar buf[MAVLINK_MSG_ID_%s_LEN];\n'</span>,Mess(i).name));
<span class="comment">%         voff = 0;</span>
        <span class="keyword">for</span> j=1:N
            <span class="comment">%if ((ID==0) &amp;&amp; (j==N)) %% Heartbeat Message special processing</span>
            <span class="comment">%    fprintf(fp,sprintf('\t_mav_put_%s(buf, %d, 2);\n',APM.type{j},voff));</span>
            <span class="comment">%else</span>
                <span class="keyword">if</span> (APM.array{j} &gt; 0)
                    <span class="keyword">if</span> (SWAP)
                        fprintf(fp,sprintf(<span class="string">'\t_mav_put_%s_array(buf, %d, %s, %d);\n'</span>,APM.type{IDX(j)},APM.soffset(IDX(j)),APM.name{IDX(j)},APM.array{IDX(j)}));
                    <span class="keyword">else</span>
                        fprintf(fp,sprintf(<span class="string">'\t_mav_put_%s_array(buf, %d, %s, %d);\n'</span>,APM.type{j}     ,APM.uoffset(j)     ,APM.name{j}     ,APM.array{j}));
                    <span class="keyword">end</span>
                <span class="keyword">else</span>
                    <span class="keyword">if</span> (SWAP)
                        fprintf(fp,sprintf(<span class="string">'\t_mav_put_%s(buf, %d, %s);\n'</span>,APM.type{IDX(j)},APM.soffset(IDX(j)),APM.name{IDX(j)}));
                    <span class="keyword">else</span>
                        fprintf(fp,sprintf(<span class="string">'\t_mav_put_%s(buf, %d, %s);\n'</span>,APM.type{j}     ,APM.uoffset(j)     ,APM.name{j}));
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="comment">%end</span>
<span class="comment">%             if (SWAP)</span>
<span class="comment">%                 voff = voff + APM.byte{IDX(j)};</span>
<span class="comment">%             else</span>
<span class="comment">%                 voff = voff + APM.byte{j};</span>
<span class="comment">%             end</span>
        <span class="keyword">end</span>

        <span class="keyword">switch</span> (VERSION)
            <span class="keyword">case</span> 0.9
                fprintf(fp,sprintf(<span class="string">'\n\t_mav_finalize_message_chan_send(chan, MAVLINK_MSG_ID_%s, buf, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name,Mess(i).name));
            <span class="keyword">case</span> 1.0
                fprintf(fp,<span class="string">'#if MAVLINK_CRC_EXTRA\n'</span>);
                fprintf(fp,sprintf(<span class="string">'\n\t_mav_finalize_message_chan_send(chan, MAVLINK_MSG_ID_%s, buf, MAVLINK_MSG_ID_%s_LEN, MAVLINK_MSG_ID_%s_CRC);\n'</span>,Mess(i).name,Mess(i).name,Mess(i).name));
                fprintf(fp,<span class="string">'#else\n'</span>);
                fprintf(fp,sprintf(<span class="string">'\n\t_mav_finalize_message_chan_send(chan, MAVLINK_MSG_ID_%s, buf, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name,Mess(i).name));
                fprintf(fp,<span class="string">'#endif\n'</span>);
            <span class="keyword">otherwise</span>
                disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
                <span class="keyword">return</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'#else\n'</span>);
        fprintf(fp,sprintf(<span class="string">'\tmavlink_%s_t packet;\n'</span>,lower(Mess(i).name)));
        <span class="keyword">for</span> j=1:N
            <span class="comment">%if ((ID==0) &amp;&amp; (j==N)) %% Heartbeat Message special processing</span>
            <span class="comment">%    fprintf(fp,sprintf('\tpacket.%s = 2;\n',APM.name{j}));</span>
            <span class="comment">%else</span>
                <span class="keyword">if</span> (APM.array{j} &gt; 0)
                    fprintf(fp,sprintf(<span class="string">'\tmav_array_memcpy(packet.%s, %s, sizeof(%s)*%d);\n'</span>,APM.name{j},APM.name{j},APM.type{j},APM.array{j}));
                <span class="keyword">else</span>
                    fprintf(fp,sprintf(<span class="string">'\tpacket.%s = %s;\n'</span>,APM.name{j},APM.name{j}));
                <span class="keyword">end</span>
            <span class="comment">%end</span>
        <span class="keyword">end</span>

        <span class="keyword">switch</span> (VERSION)
            <span class="keyword">case</span> 0.9
                fprintf(fp,sprintf(<span class="string">'\n\t_mav_finalize_message_chan_send(chan, MAVLINK_MSG_ID_%s, (const char*)&amp;packet, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name,Mess(i).name));
            <span class="keyword">case</span> 1.0
                fprintf(fp,<span class="string">'#if MAVLINK_CRC_EXTRA\n'</span>);
                fprintf(fp,sprintf(<span class="string">'\n\t_mav_finalize_message_chan_send(chan, MAVLINK_MSG_ID_%s, (const char*)&amp;packet, MAVLINK_MSG_ID_%s_LEN, MAVLINK_MSG_ID_%s_CRC);\n'</span>,Mess(i).name,Mess(i).name,Mess(i).name));
                fprintf(fp,<span class="string">'#else\n'</span>);
                fprintf(fp,sprintf(<span class="string">'\n\t_mav_finalize_message_chan_send(chan, MAVLINK_MSG_ID_%s, (const char*)&amp;packet, MAVLINK_MSG_ID_%s_LEN);\n'</span>,Mess(i).name,Mess(i).name));
                fprintf(fp,<span class="string">'#endif\n'</span>);
            <span class="keyword">otherwise</span>
                disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
                <span class="keyword">return</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'#endif\n'</span>);
        fprintf(fp,<span class="string">'}\n\n'</span>);
        fprintf(fp,<span class="string">'#endif // MAVLINK_USE_CONVENIENCE_FUNCTIONS\n\n'</span>);
</pre><h2>Function Header - MESSAGE xxx UNPACKING<a name="87"></a></h2><pre class="codeinput">        fprintf(fp,sprintf(<span class="string">'// MESSAGE %s UNPACKING\n\n'</span>,Mess(i).name));
<span class="comment">%         voff = 0;</span>
        <span class="keyword">for</span> j=1:N
            fprintf(fp,<span class="string">'/**\n'</span>);
            fprintf(fp,sprintf(<span class="string">' * @brief Get field %s from %s message\n'</span>,APM.name{j},lower(Mess(i).name)));
            fprintf(fp,<span class="string">' *\n'</span>);
            fprintf(fp,sprintf(<span class="string">' * @return %s\n'</span>,APM.desc{j}));
            fprintf(fp,<span class="string">' */\n'</span>);
            <span class="keyword">if</span> (APM.array{j} &gt; 0)
                fprintf(fp,sprintf(<span class="string">'static inline %s mavlink_msg_%s_get_%s(const mavlink_message_t* msg, %s* %s)\n'</span>,APM.type{j},lower(Mess(i).name),APM.name{j},APM.type{j},APM.name{j}));
                fprintf(fp,<span class="string">'{\n'</span>);
                fprintf(fp,sprintf(<span class="string">'	return _MAV_RETURN_%s_array(msg,%s,%d,%d);\n'</span>,APM.type{j},APM.name{j},APM.array{j},APM.uoffset(j)));
                fprintf(fp,<span class="string">'}\n\n'</span>);
            <span class="keyword">else</span>
                fprintf(fp,sprintf(<span class="string">'static inline %s mavlink_msg_%s_get_%s(const mavlink_message_t* msg)\n'</span>,APM.type{j},lower(Mess(i).name),APM.name{j}));
                fprintf(fp,<span class="string">'{\n'</span>);
                fprintf(fp,sprintf(<span class="string">'	return _MAV_RETURN_%s(msg,%d);\n'</span>,APM.type{j},APM.uoffset(j)));
                fprintf(fp,<span class="string">'}\n\n'</span>);
            <span class="keyword">end</span>
<span class="comment">%             if (SWAP)</span>
<span class="comment">%                 voff = voff + APM.byte{IDX(j)};</span>
<span class="comment">%             else</span>
<span class="comment">%                 voff = voff + APM.byte{j};</span>
<span class="comment">%             end</span>
        <span class="keyword">end</span>
</pre><h2>Function Header - mavlink_msg_xxx_decode<a name="88"></a></h2><pre class="codeinput">        fprintf(fp,<span class="string">'/**\n'</span>);
        fprintf(fp,sprintf(<span class="string">' * @brief Decode a %s message into a struct\n'</span>,lower(Mess(i).name)));
        fprintf(fp,<span class="string">' *\n'</span>);
        fprintf(fp,<span class="string">' * @param msg The message to decode\n'</span>);
        fprintf(fp,sprintf(<span class="string">' * @param %s C-struct to decode the message contents into\n'</span>,lower(Mess(i).name)));
        fprintf(fp,<span class="string">' */\n'</span>);
        fprintf(fp,sprintf(<span class="string">'static inline void mavlink_msg_%s_decode(const mavlink_message_t* msg, mavlink_%s_t* %s)\n'</span>,lower(Mess(i).name),lower(Mess(i).name),lower(Mess(i).name)));
        fprintf(fp,<span class="string">'{\n'</span>);
        fprintf(fp,<span class="string">'#if MAVLINK_NEED_BYTE_SWAP\n'</span>);
        <span class="keyword">for</span> j=1:N
            <span class="keyword">if</span> (APM.array{j} &gt; 0)
                fprintf(fp,sprintf(<span class="string">'	mavlink_msg_%s_get_%s(msg, %s-&gt;%s);\n'</span>,lower(Mess(i).name),APM.name{j},lower(Mess(i).name),APM.name{j}));
            <span class="keyword">else</span>
                fprintf(fp,sprintf(<span class="string">'	%s-&gt;%s = mavlink_msg_%s_get_%s(msg);\n'</span>,lower(Mess(i).name),APM.name{j},lower(Mess(i).name),APM.name{j}));
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        fprintf(fp,<span class="string">'#else\n'</span>);
        fprintf(fp,sprintf(<span class="string">'	memcpy(%s, _MAV_PAYLOAD(msg), MAVLINK_MSG_ID_%s_LEN);\n'</span>,lower(Mess(i).name),Mess(i).name));
        fprintf(fp,<span class="string">'#endif\n'</span>);
        fprintf(fp,<span class="string">'}\n'</span>);
</pre><h2>Function End<a name="89"></a></h2><pre class="codeinput">        fclose(fp); fp = [];
</pre><pre class="codeinput">    <span class="keyword">end</span>   <span class="comment">% For each MavLink message</span>
</pre><h2>End Messages<a name="92"></a></h2><h2>Create supporting files<a name="93"></a></h2><pre class="codeinput">    newf = sprintf(<span class="string">'%s\\common_MsgLength.h'</span>,dDir);
    mif = fopen(newf,<span class="string">'w'</span>);
    fprintf(mif,<span class="string">'/*\n'</span>);
    fprintf(mif,<span class="string">'                                {'</span>);
    <span class="keyword">for</span> i=1:256
        <span class="keyword">if</span> (i==1)
            fprintf(mif,sprintf(<span class="string">'%3d'</span>,i-1));
        <span class="keyword">else</span>
            fprintf(mif,sprintf(<span class="string">',%3d'</span>,i-1));
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    fprintf(mif,<span class="string">'}\n'</span>);
	fprintf(mif,<span class="string">'#define MAVLINK_MESSAGE_LENGTHS {  3,  4,  8, 14,  8, 28,  3, 32,  0,  2,  3,  2,  2,  0,  0,  0,  0,  0,  0,  0, 19,  2, 23, 21,  0, 37, 26,101, 26, 16, 32, 32, 37, 32, 11, 17, 17, 16, 18, 36,  4,  4,  2,  2,  4,  2,  2,  3, 14, 12, 18, 16,  8, 27, 25, 18, 18, 24, 24,  0,  0,  0, 26, 16, 36,  5,  6, 56, 26, 21, 18,  0,  0, 18, 20, 20,  8,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 18,  0,  0,  0,  0,  0,  0,  0,  0,  0, 40, 72,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 36,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 30, 14, 14, 51,  5}\n'</span>);
	fprintf(mif,<span class="string">'*/\n'</span>);
    fprintf(mif,<span class="string">'#define MAVLINK_MESSAGE_LENGTHS {'</span>);
    <span class="keyword">for</span> i=1:256
        <span class="keyword">if</span> (i==1)
            fprintf(mif,sprintf(<span class="string">'%3d'</span>,MAVLINK_MESSAGE_LENGTHS(i)));
        <span class="keyword">else</span>
            fprintf(mif,sprintf(<span class="string">',%3d'</span>,MAVLINK_MESSAGE_LENGTHS(i)));
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    fprintf(mif,<span class="string">'}\n'</span>);

    fprintf(mif,<span class="string">'#define MAVLINK_MESSAGE_INFO {'</span>);
    <span class="keyword">for</span> i=1:256
        <span class="keyword">if</span> (i==1)
            fprintf(mif,sprintf(<span class="string">'%s'</span>,MAVLINK_MESSAGE_INFO{i}));
        <span class="keyword">else</span>
            fprintf(mif,sprintf(<span class="string">',%s'</span>,MAVLINK_MESSAGE_INFO{i}));
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    fprintf(mif,<span class="string">'}\n'</span>);
    fclose(mif); mif = [];
</pre><h2>Include file Array<a name="94"></a></h2><h2>File to contain list mavlink message include files<a name="95"></a></h2><pre>   Mess = [parseXML('slvMessage.xml'); parseXML('common_APM_2.27.xml')];</pre><pre class="codeinput">    N = length(Mess);
    newf = sprintf(<span class="string">'%s\\common_include.h'</span>,dDir);
    mif = fopen(newf,<span class="string">'w'</span>);
    <span class="keyword">for</span> i=1:N
        fprintf(mif,sprintf(<span class="string">'#include "./mavlink_msg_%s.h"\n'</span>,lower(Mess(i).name)));
    <span class="keyword">end</span>
    fclose(mif); mif = [];

    <span class="keyword">switch</span> (VERSION)
        <span class="keyword">case</span> 0.9
            disp(<span class="string">'Done AP code for MavLink 0.9'</span>)
        <span class="keyword">case</span> 1.0
            disp(<span class="string">'Done AP code for MavLink 1.0'</span>)
        <span class="keyword">otherwise</span>
            disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
            <span class="keyword">return</span>
    <span class="keyword">end</span>
<span class="keyword">return</span>
</pre><pre class="codeoutput">Done AP code for MavLink 0.9
</pre><pre class="codeoutput">Done AP code for MavLink 1.0
</pre><h2>Generate GroundStation Code based on XML data<a name="96"></a></h2><pre class="codeinput"><span class="keyword">function</span> genGSCode(Mess)
</pre><pre class="codeinput">    <span class="keyword">global</span> SWAP;
    <span class="keyword">global</span> VERSION;
    <span class="keyword">if</span> (SWAP)
        disp(<span class="string">'Offset SWAPPING'</span>)
    <span class="keyword">end</span>
    <span class="comment">%dDir = 'G:\\ArduRepo\\ArdupilotMegaPlanner';</span>
    dDir = <span class="string">'ArdupilotMegaPlanner'</span>;
    <span class="keyword">if</span> (isempty(dir(dDir)))
        mkdir(dDir);
    <span class="keyword">end</span>
    <span class="keyword">switch</span> (VERSION)
        <span class="keyword">case</span> 0.9
            newf = sprintf(<span class="string">'%s\\MAVLinkTypes0.9_patch.cs'</span>,dDir);
        <span class="keyword">case</span> 1.0
            newf = sprintf(<span class="string">'%s\\MAVLinkTypes1.0_patch.cs'</span>,dDir);
        <span class="keyword">otherwise</span>
            disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
            <span class="keyword">return</span>
    <span class="keyword">end</span>
    fp = fopen(newf,<span class="string">'w'</span>);
</pre><h2>Generate Message Length Array<a name="99"></a></h2><pre class="codeinput">    K = length(Mess);
    MAVLINK_MESSAGE_LENGTHS = zeros(1,256);
    MAVLINK_MESSAGE_CRC = zeros(1,256);
    MAVLINK_MESSAGE_INFO = cell(1,256);
    <span class="keyword">for</span> i=1:256
        MAVLINK_MESSAGE_INFO{i} = sprintf(<span class="string">'\t\t\tnull,\t\t\t //message %d\n'</span>,i-1);
    <span class="keyword">end</span>

    <span class="keyword">for</span> i=1:K
        ID = sscanf(Mess(i).id,<span class="string">'%d'</span>);
        packetSize = sum(cell2mat(Mess(i).fields.byte));
        MAVLINK_MESSAGE_LENGTHS(ID+1) = packetSize;
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'    //                                                 {'</span>);
    <span class="keyword">for</span> i=1:256
        <span class="keyword">if</span> (i==1)
            fprintf(fp,sprintf(<span class="string">'%3d'</span>,i-1));
        <span class="keyword">else</span>
            fprintf(fp,sprintf(<span class="string">',%3d'</span>,i-1));
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'}\n'</span>);
    <span class="keyword">switch</span> (VERSION)
        <span class="keyword">case</span> 0.9
            fprintf(fp,<span class="string">'    public byte[] MAVLINK_MESSAGE_LENGTHS = new byte[] {'</span>);
        <span class="keyword">case</span> 1.0
            fprintf(fp,<span class="string">'    public static readonly byte[] MAVLINK_MESSAGE_LENGTHS = new byte[] {'</span>);
        <span class="keyword">otherwise</span>
            disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
            <span class="keyword">return</span>
    <span class="keyword">end</span>
    <span class="keyword">for</span> i=1:256
        <span class="keyword">if</span> (i==1)
            fprintf(fp,sprintf(<span class="string">'%3d'</span>,MAVLINK_MESSAGE_LENGTHS(i)));
        <span class="keyword">else</span>
            fprintf(fp,sprintf(<span class="string">',%3d'</span>,MAVLINK_MESSAGE_LENGTHS(i)));
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'};\n'</span>);
</pre><pre class="codeinput">    <span class="keyword">for</span> i=1:K   <span class="comment">% For each MavLink message</span>
</pre><pre class="codeinput">        N = size(Mess(i).fields.name,1);
        ID = sscanf(Mess(i).id,<span class="string">'%d'</span>);
        packetSize = sum(cell2mat(Mess(i).fields.byte));
</pre><h2>Message Length Array<a name="102"></a></h2><pre class="codeinput">        MAVLINK_MESSAGE_LENGTHS(ID+1) = packetSize;
        <span class="keyword">switch</span> (VERSION)
            <span class="keyword">case</span> 0.9
                MAVLINK_MESSAGE_INFO{ID+1} = sprintf(<span class="string">'\t\t\ttypeof( __mavlink_%s_t),\t\t\t// message %d\n'</span>,lower(Mess(i).name),ID);
            <span class="keyword">case</span> 1.0
                MAVLINK_MESSAGE_INFO{ID+1} = sprintf(<span class="string">'\t\t\ttypeof( mavlink_%s_t),\t\t\t// message %d\n'</span>,lower(Mess(i).name),ID);
            <span class="keyword">otherwise</span>
                disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
                <span class="keyword">return</span>
        <span class="keyword">end</span>
</pre><h2>Do MavLink to APM types substitution<a name="103"></a></h2><pre class="codeinput">        GCS.name = Mess(i).fields.name;
        GCS.type = Mess(i).fields.gcsType;
        GCS.byte = Mess(i).fields.gcsByte;
        GCS.desc = Mess(i).fields.desc;
        GCS.array = Mess(i).fields.Array;
</pre><h2>Function Header<a name="104"></a></h2><pre class="codeinput">        <span class="keyword">switch</span> (VERSION)
            <span class="keyword">case</span> 0.9
                fprintf(fp,sprintf(<span class="string">'\tpublic const byte MAVLINK_MSG_ID_%s = %d;\n'</span>,Mess(i).name,ID));
                fprintf(fp,sprintf(<span class="string">'\tpublic const byte MAVLINK_MSG_ID_%s_LEN = %d;\n'</span>,Mess(i).name,packetSize));
                fprintf(fp,sprintf(<span class="string">'\t[StructLayout(LayoutKind.Sequential,Pack=1)]\n'</span>));
                fprintf(fp,sprintf(<span class="string">'\tpublic struct __mavlink_%s_t\n'</span>,lower(Mess(i).name)));
                fprintf(fp,sprintf(<span class="string">'\t{\n'</span>));
                <span class="keyword">for</span> j=1:N
                    <span class="keyword">if</span> (GCS.array{j} &gt; 0)
                        fprintf(fp,<span class="string">'\t\t[MarshalAs(\n\t\t\tUnmanagedType.ByValArray,\n\t\t\tSizeConst=%d)]\n'</span>,GCS.array{j});
                        fprintf(fp,<span class="string">'\t\tpublic %s[] %s; /// %s\n'</span>,GCS.type{j}, GCS.name{j}, GCS.desc{j});
                    <span class="keyword">else</span>
                        fprintf(fp,<span class="string">'\t\tpublic %s %s; /// %s\n'</span>,GCS.type{j}, GCS.name{j}, GCS.desc{j});
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
                fprintf(fp,sprintf(<span class="string">'\t};\n\n'</span>));
            <span class="keyword">case</span> 1.0
                fprintf(fp,sprintf(<span class="string">'\t[StructLayout(LayoutKind.Sequential,Pack=1, Size=%d)]\n'</span>,packetSize));
                fprintf(fp,sprintf(<span class="string">'\tpublic struct mavlink_%s_t\n'</span>,lower(Mess(i).name)));
                fprintf(fp,sprintf(<span class="string">'\t{\n'</span>));
                <span class="keyword">for</span> j=1:N
                    <span class="keyword">if</span> (GCS.array{j})
                        fprintf(fp,<span class="string">'\t\t[MarshalAs(\n\t\t\tUnmanagedType.ByValArray,\n\t\t\tSizeConst=%d)]\n'</span>,GCS.array{j});
                        fprintf(fp,<span class="string">'\t\tpublic %s[] %s; /// %s\n'</span>,GCS.type{j}, GCS.name{j}, GCS.desc{j});
                    <span class="keyword">else</span>
                        fprintf(fp,<span class="string">'\t\tpublic %s %s; /// %s\n'</span>,GCS.type{j}, GCS.name{j}, GCS.desc{j});
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
                fprintf(fp,sprintf(<span class="string">'\t};\n\n'</span>));
            <span class="keyword">otherwise</span>
                disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
                <span class="keyword">return</span>
        <span class="keyword">end</span>
</pre><pre class="codeinput">    <span class="keyword">end</span>

    <span class="keyword">switch</span> (VERSION)
        <span class="keyword">case</span> 0.9
            fprintf(fp,<span class="string">'\tType[] mavstructs = new Type[] {\n'</span>);
        <span class="keyword">case</span> 1.0
            fprintf(fp,<span class="string">'\tpublic static readonly Type[] MAVLINK_MESSAGE_INFO = new Type[] {\n'</span>);
        <span class="keyword">otherwise</span>
            disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
            <span class="keyword">return</span>
    <span class="keyword">end</span>
    <span class="keyword">for</span> i=1:256
        fprintf(fp,MAVLINK_MESSAGE_INFO{i});
    <span class="keyword">end</span>
    fprintf(fp,<span class="string">'\t};\n'</span>);

    fclose(fp); fp = [];

    <span class="keyword">switch</span> (VERSION)
        <span class="keyword">case</span> 0.9
            disp(<span class="string">'Done GCS code for MavLink 0.9'</span>)
        <span class="keyword">case</span> 1.0
            disp(<span class="string">'Done GCS code for MavLink 1.0'</span>)
        <span class="keyword">otherwise</span>
            disp(<span class="string">'Invalid MavLink version: valid cases are 0.9 and 1.0'</span>);
            <span class="keyword">return</span>
    <span class="keyword">end</span>
<span class="keyword">return</span>
</pre><pre class="codeoutput">Done GCS code for MavLink 0.9
 
</pre><pre class="codeoutput">Done GCS code for MavLink 1.0
 
</pre><pre class="codeinput"><span class="keyword">function</span> Mess = parseXML(file)
</pre><pre class="codeinput">    xDoc = xmlread(file);
    allEnums = xDoc.getElementsByTagName(<span class="string">'enum'</span>);
    allMessages = xDoc.getElementsByTagName(<span class="string">'message'</span>);
    K = allMessages.getLength;
    <span class="keyword">for</span> k = 0:K-1       <span class="comment">% Note that the item list index is zero-based.</span>
        dMess = allMessages.item(k);
        dAtt = dMess.getAttributes;
        attrib = dAtt.item(1);
        Mess(k+1).name = char(attrib.getValue);
        attrib = dAtt.item(0);
        Mess(k+1).id   = char(attrib.getValue);
        dList = dMess.getElementsByTagName(<span class="string">'description'</span>);
        <span class="keyword">if</span> (dList.getLength &gt; 0)
            Mess(k+1).fdesc = cleanupDesc(char(dList.item(0).getFirstChild.getData),0);
            Mess(k+1).cdesc = cleanupDesc(char(dList.item(0).getFirstChild.getData),1);
        <span class="keyword">else</span>
            Mess(k+1).fdesc = <span class="string">'% No Description provided\n'</span>;
            Mess(k+1).cdesc = <span class="string">'% No Description provided\n'</span>;
        <span class="keyword">end</span>

        fList = allMessages.item(k).getElementsByTagName(<span class="string">'field'</span>);
        N = fList.getLength;
        allocCell = cell(N, 1);
        Mess(k+1).fields.name = allocCell;
        Mess(k+1).fields.type = allocCell;
        Mess(k+1).fields.desc = allocCell;
        Mess(k+1).fields.byte = allocCell;

        <span class="keyword">for</span> n=0:N-1
            dField = fList.item(n);
            dAtt = dField.getAttributes;
            s = 0;
            <span class="keyword">while</span> (~isempty(dAtt.item(s)))
                attrib = dAtt.item(s);
                Mess(k+1).fields.(char(attrib.getName)){n+1} = char(attrib.getValue);
                s = s+1;
            <span class="keyword">end</span>
            Mess(k+1).fields.desc{n+1} = cleanupField(char(dField.getFirstChild.getData));
            Mess(k+1).fields = parseType(Mess(k+1).fields,n+1);
        <span class="keyword">end</span>
        Mess(k+1).fields = MavLinkSort(Mess(k+1).fields);
        <span class="keyword">if</span> (Mess(k+1).fields.needSwap)
            fprintf(<span class="string">'%s message needs swap\n'</span>,Mess(k+1).name);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    Mess = Mess(:);
<span class="keyword">return</span>
</pre><pre class="codeinput"><span class="keyword">function</span> Mess = MavLinkSort(Mess)
</pre><pre class="codeinput">    <span class="comment">%[~, Mess.idx] = sort(cell2mat(Mess.byte),'descend');</span>
    [junk, Mess.idx] = sort(cell2mat(Mess.byte),<span class="string">'descend'</span>);
    N = length(Mess.idx);
<span class="comment">%     Mess.soffset = [0; cumsum(cell2mat(Mess.byte(Mess.idx(1:N-1))))];</span>
<span class="comment">%     Mess.offset  = [0; cumsum(cell2mat(Mess.byte(1:N-1)))];</span>
<span class="comment">%     Mess.poffset(Mess.idx) = Mess.soffset;</span>
<span class="comment">%     Mess.poffset = Mess.poffset(:);</span>
<span class="comment">%     disp([Mess.soffset Mess.offset Mess.poffset])</span>
    Mess.soffset = [0; cumsum(cell2mat(Mess.byte(Mess.idx(1:N-1))))];
    Mess.soffset(Mess.idx) = Mess.soffset;
    Mess.uoffset  = [0; cumsum(cell2mat(Mess.byte(1:N-1)))];
    Mess.needSwap = ~all(Mess.soffset==Mess.uoffset);
<span class="comment">%     disp([Mess.soffset Mess.uoffset])</span>
<span class="keyword">return</span>
</pre><pre class="codeoutput">ANALOG_RAW message needs swap
</pre><pre class="codeoutput">ANALOG_EU message needs swap
</pre><pre class="codeoutput">CDNR_CONTROLLER message needs swap
</pre><pre class="codeoutput">TRAFFIC_DATA message needs swap
</pre><pre class="codeoutput">STATE_DATA message needs swap
</pre><pre class="codeoutput">STATE_DATA_AUG message needs swap
</pre><pre class="codeoutput">PING message needs swap
</pre><pre class="codeoutput">PARAM_REQUEST_READ message needs swap
</pre><pre class="codeoutput">PARAM_SET message needs swap
</pre><pre class="codeoutput">GPS_RAW_INT message needs swap
</pre><pre class="codeoutput">GPS_STATUS message needs swap
</pre><pre class="codeoutput">GPS_RAW message needs swap
</pre><pre class="codeoutput">SYS_STATUS message needs swap
</pre><pre class="codeoutput">WAYPOINT message needs swap
</pre><pre class="codeoutput">WAYPOINT_REQUEST message needs swap
</pre><pre class="codeoutput">WAYPOINT_SET_CURRENT message needs swap
</pre><pre class="codeoutput">WAYPOINT_COUNT message needs swap
</pre><pre class="codeoutput">GPS_SET_GLOBAL_ORIGIN message needs swap
</pre><pre class="codeoutput">LOCAL_POSITION_SETPOINT_SET message needs swap
</pre><pre class="codeoutput">SAFETY_SET_ALLOWED_AREA message needs swap
</pre><pre class="codeoutput">SAFETY_ALLOWED_AREA message needs swap
</pre><pre class="codeoutput">SET_ROLL_PITCH_YAW_THRUST message needs swap
</pre><pre class="codeoutput">SET_ROLL_PITCH_YAW_SPEED_THRUST message needs swap
</pre><pre class="codeoutput">NAV_CONTROLLER_OUTPUT message needs swap
</pre><pre class="codeoutput">SET_ALTITUDE message needs swap
REQUEST_DATA_STREAM message needs swap
</pre><pre class="codeoutput">MANUAL_CONTROL message needs swap
</pre><pre class="codeoutput">RC_CHANNELS_OVERRIDE message needs swap
</pre><pre class="codeoutput">VFR_HUD message needs swap
</pre><pre class="codeoutput">COMMAND message needs swap
</pre><pre class="codeoutput">OPTICAL_FLOW message needs swap
</pre><pre class="codeoutput">OBJECT_DETECTION_EVENT message needs swap
DEBUG_VECT message needs swap
</pre><pre class="codeoutput">NAMED_VALUE_FLOAT message needs swap
</pre><pre class="codeoutput">NAMED_VALUE_INT message needs swap
</pre><pre class="codeoutput">DEBUG message needs swap
</pre><pre class="codeoutput">SENSOR_OFFSETS message needs swap
</pre><pre class="codeoutput">SET_MAG_OFFSETS message needs swap
</pre><pre class="codeoutput">DIGICAM_CONFIGURE message needs swap
</pre><pre class="codeoutput">DIGICAM_CONTROL message needs swap
</pre><pre class="codeoutput">MOUNT_CONTROL message needs swap
</pre><pre class="codeoutput">MOUNT_STATUS message needs swap
</pre><pre class="codeoutput">FENCE_POINT message needs swap
</pre><pre class="codeoutput">FENCE_STATUS message needs swap
</pre><pre class="codeoutput">HEARTBEAT message needs swap
</pre><pre class="codeoutput">SYS_STATUS message needs swap
</pre><pre class="codeoutput">SET_MODE message needs swap
</pre><pre class="codeoutput">PARAM_REQUEST_READ message needs swap
</pre><pre class="codeoutput">PARAM_VALUE message needs swap
</pre><pre class="codeoutput">PARAM_SET message needs swap
</pre><pre class="codeoutput">GPS_RAW_INT message needs swap
</pre><pre class="codeoutput">RC_CHANNELS_SCALED message needs swap
</pre><pre class="codeoutput">RC_CHANNELS_RAW message needs swap
</pre><pre class="codeoutput">SERVO_OUTPUT_RAW message needs swap
</pre><pre class="codeoutput">MISSION_REQUEST_PARTIAL_LIST message needs swap
</pre><pre class="codeoutput">MISSION_WRITE_PARTIAL_LIST message needs swap
</pre><pre class="codeoutput">MISSION_ITEM message needs swap
</pre><pre class="codeoutput">MISSION_REQUEST message needs swap
</pre><pre class="codeoutput">MISSION_SET_CURRENT message needs swap
</pre><pre class="codeoutput">MISSION_COUNT message needs swap
</pre><pre class="codeoutput">SET_GPS_GLOBAL_ORIGIN message needs swap
</pre><pre class="codeoutput">SET_LOCAL_POSITION_SETPOINT message needs swap
</pre><pre class="codeoutput">LOCAL_POSITION_SETPOINT message needs swap
</pre><pre class="codeoutput">GLOBAL_POSITION_SETPOINT_INT message needs swap
</pre><pre class="codeoutput">SET_GLOBAL_POSITION_SETPOINT_INT message needs swap
</pre><pre class="codeoutput">SAFETY_SET_ALLOWED_AREA message needs swap
</pre><pre class="codeoutput">SAFETY_ALLOWED_AREA message needs swap
</pre><pre class="codeoutput">SET_ROLL_PITCH_YAW_THRUST message needs swap
</pre><pre class="codeoutput">SET_ROLL_PITCH_YAW_SPEED_THRUST message needs swap
</pre><pre class="codeoutput">SET_QUAD_MOTORS_SETPOINT message needs swap
</pre><pre class="codeoutput">SET_QUAD_SWARM_ROLL_PITCH_YAW_THRUST message needs swap
</pre><pre class="codeoutput">NAV_CONTROLLER_OUTPUT message needs swap
</pre><pre class="codeoutput">SET_QUAD_SWARM_LED_ROLL_PITCH_YAW_THRUST message needs swap
</pre><pre class="codeoutput">REQUEST_DATA_STREAM message needs swap
DATA_STREAM message needs swap
</pre><pre class="codeoutput">MANUAL_CONTROL message needs swap
</pre><pre class="codeoutput">RC_CHANNELS_OVERRIDE message needs swap
</pre><pre class="codeoutput">VFR_HUD message needs swap
</pre><pre class="codeoutput">COMMAND_LONG message needs swap
</pre><pre class="codeoutput">OPTICAL_FLOW message needs swap
</pre><pre class="codeoutput">OMNIDIRECTIONAL_FLOW message needs swap
</pre><pre class="codeoutput">RADIO_STATUS message needs swap
</pre><pre class="codeoutput">FILE_TRANSFER_START message needs swap
</pre><pre class="codeoutput">HIL_GPS message needs swap
</pre><pre class="codeoutput">HIL_OPTICAL_FLOW message needs swap
</pre><pre class="codeoutput">LOG_REQUEST_LIST message needs swap
</pre><pre class="codeoutput">LOG_ENTRY message needs swap
</pre><pre class="codeoutput">LOG_REQUEST_DATA message needs swap
</pre><pre class="codeoutput">LOG_DATA message needs swap
</pre><pre class="codeoutput">BATTERY_STATUS message needs swap
</pre><pre class="codeoutput">SETPOINT_8DOF message needs swap
</pre><pre class="codeoutput">SETPOINT_6DOF message needs swap
</pre><pre class="codeoutput">NAMED_VALUE_FLOAT message needs swap
</pre><pre class="codeoutput">NAMED_VALUE_INT message needs swap
</pre><pre class="codeoutput">DEBUG message needs swap
</pre><pre class="codeoutput">SENSOR_OFFSETS message needs swap
</pre><pre class="codeoutput">SET_MAG_OFFSETS message needs swap
</pre><pre class="codeoutput">DIGICAM_CONFIGURE message needs swap
</pre><pre class="codeoutput">DIGICAM_CONTROL message needs swap
</pre><pre class="codeoutput">MOUNT_CONTROL message needs swap
</pre><pre class="codeoutput">MOUNT_STATUS message needs swap
</pre><pre class="codeoutput">FENCE_POINT message needs swap
</pre><pre class="codeoutput">FENCE_STATUS message needs swap
</pre><pre class="codeoutput">RADIO message needs swap
</pre><pre class="codeoutput">LIMITS_STATUS message needs swap
</pre><pre class="codeoutput">RALLY_POINT message needs swap
</pre><pre class="codeinput"><span class="keyword">function</span> str = cleanupDesc(dstr,indentFlag)
</pre><pre class="codeinput">    <span class="keyword">if</span> (indentFlag), indent = <span class="string">'\t\t\t'</span>; c=<span class="string">' '</span>; <span class="keyword">else</span> indent = <span class="string">''</span>; c=<span class="string">'~ '</span>; <span class="keyword">end</span>

    tf = isstrprop(dstr, <span class="string">'cntrl'</span>);
    dstr(tf) = <span class="string">' '</span>;
    idx = strfind(dstr,<span class="string">'%'</span>);
    <span class="keyword">if</span> ~isempty(idx)
        N = length(idx);
        nstr = dstr;
        <span class="keyword">for</span> i=1:N
            nstr = [nstr(1:idx(i)) <span class="string">'%'</span> nstr(idx(i)+1:end)];
            idx = idx+1;
        <span class="keyword">end</span>
        dstr = nstr;
    <span class="keyword">end</span>
    idx = find(isstrprop(dstr, <span class="string">'wspace'</span>));
    ldx = find(diff(mod(idx,80))&lt;0)+1;
    list = reshape(sort([1 idx(ldx) idx(ldx)+1 length(dstr)]),2,[])';
    N = size(list,1);
    nstr = [<span class="string">'%%'</span> c dstr(list(1,1):list(1,2)) <span class="string">'\n'</span>];
    <span class="keyword">for</span> i=2:N
        nstr = [nstr indent <span class="string">'%%%%'</span> c dstr(list(i,1):list(i,2)) <span class="string">'\n'</span>];
    <span class="keyword">end</span>
    str = [indent <span class="string">'%%'</span> nstr];
<span class="keyword">return</span>
</pre><pre class="codeinput"><span class="keyword">function</span> str = cleanupField(dstr)
</pre><pre class="codeinput">    tf = isstrprop(dstr, <span class="string">'cntrl'</span>);
    dstr(tf) = <span class="string">' '</span>;
    idx = strfind(dstr,<span class="string">'%'</span>);
    <span class="keyword">if</span> ~isempty(idx)
        N = length(idx);
        nstr = dstr;
        <span class="keyword">for</span> i=1:N
            nstr = [nstr(1:idx(i)) <span class="string">'%'</span> nstr(idx(i)+1:end)];
            idx = idx+1;
        <span class="keyword">end</span>
        dstr = nstr;
    <span class="keyword">end</span>
    str = dstr;
<span class="keyword">return</span>
</pre><pre class="codeinput"><span class="keyword">function</span> fields = parseType(fields,n)
    <span class="keyword">if</span> (isempty(fields.type{n}))
        fields.type{n} = <span class="string">'NONE'</span>;
        fields.byte{n} = 0;
        <span class="keyword">return</span>
    <span class="keyword">end</span>

    mult = 1;
    udx = strfind(fields.type{n},<span class="string">'_'</span>);
    odx = strfind(fields.type{n},<span class="string">'['</span>);
    cdx = strfind(fields.type{n},<span class="string">']'</span>);
    <span class="keyword">if</span> ~isempty(udx)
        ttype = fields.type{n}(1:udx(1)-1);
    <span class="keyword">else</span>
        <span class="keyword">if</span> ~isempty(odx)
            ttype = fields.type{n}(1:odx-1);
        <span class="keyword">else</span>
            ttype = fields.type{n};
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> (~isempty(odx) &amp;&amp; ~isempty(cdx))
</pre><pre class="codeinput">        mult = sscanf(fields.type{n}(odx+1:cdx-1),<span class="string">'%d'</span>);
        fields.Array{n} = mult;
</pre><h2>debug statement to show declaration of arrays<a name="121"></a></h2><pre class="codeinput">        <span class="comment">%disp([fields.name{n} ' is of type: ' fields.type{n}])</span>
</pre><pre class="codeinput">    <span class="keyword">else</span>
        fields.Array{n} = 0;
    <span class="keyword">end</span>

<span class="comment">%     if (isempty(ttype))</span>
<span class="comment">%         fields.type{n} = fields.type{n};</span>
<span class="comment">%     end</span>

    <span class="keyword">switch</span>(ttype)
		<span class="keyword">case</span> <span class="string">'int8'</span>
			fields.byte{n}     = 1; <span class="comment">%mult;</span>
			fields.matType{n}  = <span class="string">'int8'</span>;
			fields.matByte{n}  = mult;
			fields.javaType{n} = <span class="string">'byte'</span>;
			fields.javaByte{n} = mult;
			fields.apmType{n}  = <span class="string">'int8_t'</span>;
			fields.apmByte{n}  = mult;
			fields.gcsType{n}  = <span class="string">'byte'</span>;
			fields.gcsByte{n}  = mult;
		<span class="keyword">case</span> <span class="string">'int16'</span>
			fields.byte{n}     = 2; <span class="comment">%*mult;</span>
			fields.matType{n}  = <span class="string">'int16'</span>;
			fields.matByte{n}  = 2*mult;
			fields.javaType{n} = <span class="string">'short'</span>;
			fields.javaByte{n} = 2*mult;
			fields.apmType{n}  = <span class="string">'int16_t'</span>;
			fields.apmByte{n}  = 2*mult;
			fields.gcsType{n}  = <span class="string">'short'</span>;
			fields.gcsByte{n}  = 2*mult;
		<span class="keyword">case</span> <span class="string">'int32'</span>
			fields.byte{n}     = 4; <span class="comment">%*mult;</span>
			fields.matType{n}  = <span class="string">'int32'</span>;
			fields.matByte{n}  = 4*mult;
			fields.javaType{n} = <span class="string">'int'</span>;
			fields.javaByte{n} = 4*mult;
			fields.apmType{n}  = <span class="string">'int32_t'</span>;
			fields.apmByte{n}  = 4*mult;
			fields.gcsType{n}  = <span class="string">'int'</span>;
			fields.gcsByte{n}  = 4*mult;
		<span class="keyword">case</span> <span class="string">'uint8'</span>
			fields.byte{n}     = 1; <span class="comment">%mult;</span>
			fields.matType{n}  = <span class="string">'uint8'</span>;
			fields.matByte{n}  = mult;
			fields.javaType{n} = <span class="string">'short'</span>;
			fields.javaByte{n} = 2*mult;
			fields.apmType{n}  = <span class="string">'uint8_t'</span>;
			fields.apmByte{n}  = mult;
			fields.gcsType{n}  = <span class="string">'byte'</span>;
			fields.gcsByte{n}  = mult;
		<span class="keyword">case</span> <span class="string">'char'</span>
			fields.byte{n}     = 1; <span class="comment">%mult;</span>
			fields.matType{n}  = <span class="string">'uint8'</span>;
			fields.matByte{n}  = mult;
			fields.javaType{n} = <span class="string">'byte'</span>;
			fields.javaByte{n} = mult;
			fields.apmType{n}  = <span class="string">'char'</span>;
			fields.apmByte{n}  = mult;
			fields.gcsType{n}  = <span class="string">'byte'</span>;
			fields.gcsByte{n}  = mult;
		<span class="keyword">case</span> <span class="string">'uint16'</span>
			fields.byte{n}     = 2; <span class="comment">%*mult;</span>
			fields.matType{n}  = <span class="string">'uint16'</span>;
			fields.matByte{n}  = 2*mult;
			fields.javaType{n} = <span class="string">'int'</span>;
			fields.javaByte{n} = 4*mult;
			fields.apmType{n}  = <span class="string">'uint16_t'</span>;
			fields.apmByte{n}  = 2*mult;
			fields.gcsType{n}  = <span class="string">'ushort'</span>;
			fields.gcsByte{n}  = 2*mult;
		<span class="keyword">case</span> <span class="string">'uint32'</span>
			fields.byte{n}     = 4; <span class="comment">%*mult;</span>
			fields.matType{n}  = <span class="string">'uint32'</span>;
			fields.matByte{n}  = 4*mult;
			fields.javaType{n} = <span class="string">'long'</span>;
			fields.javaByte{n} = 8*mult;
			fields.apmType{n}  = <span class="string">'uint32_t'</span>;
			fields.apmByte{n}  = 4*mult;
			fields.gcsType{n}  = <span class="string">'uint'</span>;
			fields.gcsByte{n}  = 4*mult;
		<span class="keyword">case</span> <span class="string">'uint64'</span>
			fields.byte{n}     = 8; <span class="comment">%*mult;</span>
			fields.matType{n}  = <span class="string">'uint64'</span>;
			fields.matByte{n}  = 8*mult;
			fields.javaType{n} = <span class="string">'long'</span>;
			fields.javaByte{n} = 8*mult;
			fields.apmType{n}  = <span class="string">'uint64_t'</span>;
			fields.apmByte{n}  = 8*mult;
			fields.gcsType{n}  = <span class="string">'ulong'</span>;
			fields.gcsByte{n}  = 8*mult;
		<span class="keyword">case</span> <span class="string">'float'</span>
			fields.byte{n}     = 4; <span class="comment">%*mult;</span>
			fields.matType{n}  = <span class="string">'single'</span>;
			fields.matByte{n}  = 4*mult;
			fields.javaType{n} = <span class="string">'float'</span>;
			fields.javaByte{n} = 4*mult;
			fields.apmType{n}  = <span class="string">'float'</span>;
			fields.apmByte{n}  = 4*mult;
			fields.gcsType{n}  = <span class="string">'float'</span>;
			fields.gcsByte{n}  = 4*mult;
		<span class="keyword">case</span> <span class="string">'array'</span>
			<span class="comment">%fields.byte{n}     = 1; %mult;</span>
			fields.byte{n}     = mult;
			fields.matType{n}  = <span class="string">'uint8'</span>;
			fields.matByte{n}  = mult;
			fields.javaType{n} = <span class="string">'byte'</span>;
			fields.javaByte{n} = mult;
			fields.apmType{n}  = <span class="string">'uint8_t'</span>;
			fields.apmByte{n}  = mult;
			fields.gcsType{n}  = <span class="string">'byte'</span>;
			fields.gcsByte{n}  = mult;
        <span class="keyword">otherwise</span>
            fprintf(<span class="string">'ERROR: Unknown Variable type: %s=&gt;%s\n'</span>,fields.type{n},ttype)
    <span class="keyword">end</span>

<span class="keyword">return</span>
</pre><pre class="codeoutput">DEBUG_VECT message needs swap
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2013b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% XML File Parse
function parse_APM_XML()
    global SWAP;
    SWAP = 0;       % SWAP=0; don't swap mavlink message parameters
                    % SWAP=1; swap mavlink message parameters as
                    %         recommended by the MavLink protocol.
                    %         where the fields in a message are sorted
                    %         in descending order according to the size
                    %         (in bytes) of their type. e.g. uint32's will
                    %         be sorted before int16's or int8's. fields of
                    %         the same size will maintain their order.
                    
    global LOCAL;
    LOCAL = 1;      % LOCAL=1; Java code doesn't include the StratWay import libraries
                    % LOCAL=0; Java code does include the StratWay import libraries
                    
    global VERSION;
    VERSION = 0.9;  % VERSION=0.9; Use MavLink verion 0.9
                    % VERSION=1.0; Use MavLink versio 1.0
                    
    Mess = [parseXML('slvMessage.xml'); parseXML('common_APM_2.27.xml'); parseXML('ardupilotmega_APM_2.27.xml')];
    if (~isempty(Mess))
        % Generates MavLink 0.9 code
        VERSION = 0.9;
        genScript(Mess);   
        genJavaCode(Mess);   
        genAPMCode(Mess);   
        genGSCode(Mess);
        disp(' ');
    end
    
    %Mess = [parseXML('slvMessage.xml'); parseXML('common_MAVLINK_1.0.xml'); parseXML('ardupilotmega_MAVLINK_1.0.xml')];
    Mess = [parseXML('MavLink1.0_common.xml'); parseXML('MavLink1.0_ardupilotmega.xml')];
    if (~isempty(Mess))
        % Generates MavLink 1.0 code
        VERSION = 1.0;
        genScript(Mess);   
        genJavaCode(Mess);   
        genAPMCode(Mess);   
        genGSCode(Mess);   
        disp(' ');
    end

return

%% Generate MATLab Script based on XML data
function genScript(Mess)
    global SWAP;
    global VERSION;
    if (SWAP)
        disp('Offset SWAPPING')
    end
    switch (VERSION)
        case 0.9
            %fp = fopen('parseMavLinkPacket_APM_2_23.m','w');
            fp = fopen('parseMavLink_0_9_Packet.m','w');
            fprintf(fp,'function S = parseMavLink_0_9_Packet(S,p)\n');
        case 1.0
            fp = fopen('parseMavLink_1_0_Packet.m','w');
            fprintf(fp,'function S = parseMavLink_1_0_Packet(S,p)\n');
        otherwise
            disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
            return
    end
    fprintf(fp,'\tswitch(p.messid)\n');
    K = length(Mess);
    for i=1:K
        fprintf(fp,sprintf('\t\tcase %s\n',Mess(i).id));
        fprintf(fp,sprintf('%s',Mess(i).cdesc));
        fprintf(fp,sprintf('\t\t\tS.%s = parse_%s(S.%s,p);\n',Mess(i).name,Mess(i).name,Mess(i).name));
    end
    fprintf(fp,'\t\totherwise\n');
    fprintf(fp,'\t\t\tdisp(sprintf(''Unknown Message: id[%%d]'',p.messid))\n');
    fprintf(fp,'\tend\n');
    fprintf(fp,'return\n');
    for i=1:K
        fprintf(fp,'\n');
        fprintf(fp,sprintf('%%%%%%%%  case: %s\n',Mess(i).id));
        fprintf(fp,sprintf('%s',Mess(i).fdesc));
        fprintf(fp,sprintf('function S = parse_%s(S,p)\n',Mess(i).name));
        N = size(Mess(i).fields.name,1);

        %% name member
        fprintf(fp,'\tname = [ ...\n');
        ml = 0;
        for j=1:N
            ml = max([ml length(Mess(i).fields.name{j})]);
        end
        ml = 4*ceil(ml/4);

        for j=1:N
            padL = ceil((ml-length(Mess(i).fields.name{j}))/4);
            pad = char(9*ones(1,padL));
            fprintf(fp,sprintf('\t\t{''%s''}%s ... ',Mess(i).fields.name{j},pad));
            if ~isempty(Mess(i).fields.desc{j})
                fprintf(fp,'%%%% ');
                fprintf(fp,Mess(i).fields.desc{j});
            end
            fprintf(fp,'\n');
        end
        fprintf(fp,'\t\t];\n');

%         %% byte member
%         fprintf(fp,'\tbyte = [ ...\n');
%         for j=1:N
%             fprintf(fp,sprintf('\t\t%d ...\n',Mess(i).fields.matByte{j}));
%         end
%         fprintf(fp,'\t\t];\n');
% 
%         %% type member
%         fprintf(fp,'\ttype = [ ...\n');
%         for j=1:N
%             fprintf(fp,sprintf('\t\t{''%s''} ...\n',Mess(i).fields.matType{j}));
%         end
%         fprintf(fp,'\t\t];\n');

        %% byte member
        fprintf(fp,'\tbyte = [ ');
        for j=1:N
            fprintf(fp,sprintf('%d ',Mess(i).fields.matByte{j}));
        end
        fprintf(fp,'];\n');

        %% type member
        fprintf(fp,'\ttype = [ ');
        for j=1:N
            fprintf(fp,sprintf('{''%s''} ',Mess(i).fields.matType{j}));
        end
        fprintf(fp,'];\n');
        
        fprintf(fp,'\tif (sum(byte) == p.len)\n');
        fprintf(fp,'\t\tS = buildStruct(S,byte,name,type,p);\n');
        fprintf(fp,'\telse\n');
        fprintf(fp,'\t\tdisp(''bytes in packet did not match structure size'')\n');
        fprintf(fp,'\tend\n');

        fprintf(fp,'return\n\n');
    end
    fclose(fp);
    
    switch (VERSION)
        case 0.9
            fp = fopen('initMavLink_0_9.m','w');
            fprintf(fp,'function MavLink = initMavLink_0_9()\n');
        case 1.0
            fp = fopen('initMavLink_1_0.m','w');
            fprintf(fp,'function MavLink = initMavLink_1_0()\n');
        otherwise
            disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
            return
    end
    for i=1:K
        %fprintf(fp,sprintf('\tMavLink.%s = struct();\n',Mess(i).name));
        fprintf(fp,sprintf('\tMavLink.%s = [];\n',Mess(i).name));
    end
    fprintf(fp,'return\n');

    fclose(fp);
    switch (VERSION)
        case 0.9
            disp('Done MatLab script for MavLink 0.9')
        case 1.0
            disp('Done MatLab script for MavLink 1.0')
        otherwise
            disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
            return
    end
return

%% Generate Java Code based on XML data
function genJavaCode(Mess)
    global SWAP;
    global VERSION;
    global LOCAL;
    if (SWAP)
        disp('Offset SWAPPING')
    end
    switch (VERSION)
        case 0.9
            dDir = 'Java\\Mav09';
        case 1.0
            dDir = 'Java\\Mav10';
        otherwise
            disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
            return
    end
    if (isempty(dir(dDir)))
        mkdir(dDir);
    end

    %%% initialization
    %specialHandlingIDs = [25 32 73 111];
    
    %%% Generate function header
    K = length(Mess);
    msgWithSystem = [];
    msgWithComponent = [];
    for i=1:K   %%% For each MavLink message
        msgWithSystemBool = strcmp('target_system',Mess(i).fields.name);
        msgWithSystemIdx = find(msgWithSystemBool);
        if (any(msgWithSystemBool))
            msgWithSystem = [msgWithSystem; i];
        end
        msgWithComponentBool = strcmp('target_component',Mess(i).fields.name);
        msgWithComponentIdx = find(msgWithComponentBool);
        if (any(strcmp('target_component',Mess(i).fields.name)))
            msgWithComponent = [msgWithComponent; i];
        end
        N = size(Mess(i).fields.name,1);
        ID = sscanf(Mess(i).id,'%d');
%%%         packetSize = sum(cell2mat(Mess(i).fields.matByte));
        
%%%        specialFunction = ~isempty(intersect(ID,specialHandlingIDs));

        %%% Do MavLink to java types substitution
        JAVA.name = Mess(i).fields.name;
        JAVA.type = Mess(i).fields.javaType;
        JAVA.byte = Mess(i).fields.javaByte;
        JAVA.array = Mess(i).fields.Array;
        
        %%% Max name and type lengths
        ml = 0;
        tl = 0;
        needBB = 0;
        for j=1:N
            ml = max([ml length(JAVA.name{j})]);
            tl = max([tl length(JAVA.type{j})]);
            needBB = needBB || (JAVA.byte{j}>Mess(i).fields.byte{j});
        end
        ml = 4*ceil(ml/4);
        tl = 4*ceil(tl/4);
        tpad = JAVA.type;   %preallocates memory for tpad cell array
        mpad = JAVA.type;   %same as above
        for j=1:N
            tpad{j} = char(9*ones(1,ceil((tl-length(JAVA.type{j}))/4)));
            mpad{j} = char(9*ones(1,ceil((ml-length(Mess(i).fields.name{j}))/4)));
        end
    
%%% Function Header
        newf = sprintf('%s\\%s_class.java',dDir,Mess(i).name);
        fp = fopen(newf,'w');
        switch (VERSION)
            case 0.9
                fprintf(fp,'//MavLink 0.9\n\n');
            case 1.0
                fprintf(fp,'//MavLink 1.0\n\n');
            otherwise
                disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
                return
        end
        if (LOCAL)
            fprintf(fp,'//package gov.nasa.larc.AP;\n');
            fprintf(fp,'//import gov.nasa.larc.serial.Loggable;\n');
        else
            fprintf(fp,'package gov.nasa.larc.AP;\n');
            fprintf(fp,'import gov.nasa.larc.serial.Loggable;\n');
        end
%     if (sum(cell2mat(JAVA.byte)) ~= ...
%         sum(cell2mat(Mess(i).fields.byte)))
%         fprintf(fp,'import java.nio.ByteBuffer;\n');
%         fprintf(fp,'import java.nio.ByteOrder;\n\n');
%     end
        fprintf(fp,'\n/**\n');
        fprintf(fp,sprintf('Message ID: %s(%d)\n',Mess(i).name,ID));
        fprintf(fp,'REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH\n');
        fprintf(fp,sprintf('%s',Mess(i).fdesc));
        fprintf(fp,'REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH\n');
        fprintf(fp,'*/\n');

        %fprintf(fp,'public class %s_class extends MavCheckSum\n{\n',Mess(i).name);
        fprintf(fp,'public class %s_class',Mess(i).name);
        if (LOCAL)
            fprintf(fp,' //implements Loggable');
        else
            fprintf(fp,' implements Loggable');
        end
        fprintf(fp,'\n{\n');
        %%% Declare member variables
        %fprintf(fp,'\tHeader_class head;\n');
        fprintf(fp,'\tpublic static final int msgID = %d;\n',ID);
        for j=1:N
%             switch(JAVA.type{j})
%                 case 'byte[]'
%                     fprintf(fp,'\tpublic %s%s %s = new byte[%d];%s',JAVA.type{j}, tpad{j}, Mess(i).fields.name{j},JAVA.byte{j}, mpad{j});
%                 otherwise
%                     fprintf(fp,'\tpublic %s%s %s;%s '              ,JAVA.type{j}, tpad{j}, Mess(i).fields.name{j}, mpad{j});
%             end
            if (JAVA.array{j})
                fprintf(fp,'\tpublic %s[]%s %s = new %s[%d];%s',JAVA.type{j}, tpad{j}, Mess(i).fields.name{j},JAVA.type{j},JAVA.byte{j}, mpad{j});
            else
                fprintf(fp,'\tpublic %s%s %s;%s '              ,JAVA.type{j}, tpad{j}, Mess(i).fields.name{j}, mpad{j});
            end
            if ~isempty(Mess(i).fields.desc{j})
                fprintf(fp,'\t// ');
                fprintf(fp,Mess(i).fields.desc{j});
            end
            fprintf(fp,'\n');
        end
        fprintf(fp,'\n');
        fprintf(fp,'\tprivate packet rcvPacket;\n');
        fprintf(fp,'\tprivate packet sndPacket;\n\n');
        
%%% Constructor
        fprintf(fp,sprintf('\tpublic %s_class()\n\t{\n',Mess(i).name));
        fprintf(fp,'\t\trcvPacket = new packet(msgID);\n');
        fprintf(fp,'\t\tsndPacket = new packet(msgID);\n');
        if (intersect(i,msgWithSystem))
            fprintf(fp,'\t\ttarget_system = 1;\n');
        end
        if (intersect(i,msgWithComponent))
            fprintf(fp,'\t\ttarget_component = 1;\n');
        end
        fprintf(fp,'\t}\n\n');

%%% Copy Constructor
        fprintf(fp,sprintf('\tpublic %s_class(%s_class o)\n\t{\n',Mess(i).name,Mess(i).name));
        for j=1:N
            fprintf(fp,'\t\t%s = o.%s;\n',Mess(i).fields.name{j},Mess(i).fields.name{j});
        end
        fprintf(fp,'\t}\n\n');

%%% First Parse Function
        fprintf(fp,'\tpublic boolean parse(byte[] b)\n\t{\n');
        fprintf(fp,'\t\treturn parse(b, false);\n');
        fprintf(fp,'\t}\n\n');
%%% Second Parse Function
        fprintf(fp,'\tpublic boolean parse(byte[] b, boolean valid)\n\t{\n');
        fprintf(fp,'\t\trcvPacket.load(b);\n\n');
        %%% Begin parsing from array
        fprintf(fp,'\t\tboolean pstatus = valid || rcvPacket.isPacket();\n');
        fprintf(fp,'\t\tif (pstatus)\n');
        fprintf(fp,'\t\t{\n');

%         fprintf(fp,'\t\t\t//head.updateRcvSeq();\n\n');
        fprintf(fp,'\t\t\trcvPacket.updateSeqNum();\n\n');
%         if(needBB)
%             fprintf(fp,'\t\t\tbyte[] temp = {0,0,0,0,0,0,0,0};\n');
%             fprintf(fp,'\t\t\tByteBuffer BB = ByteBuffer.wrap(temp);\n\n');
%         end
%         fprintf(fp,'\t\t\tByteBuffer p = ByteBuffer.wrap(packet);\n');
        
        %%% define MavLink member lengths (in bytes)
        fprintf(fp,'\t\t\t// int[] mavLen = {');
        for j=1:N
            if (j==N)
                fprintf(fp,'%d',Mess(i).fields.byte{j});
            else
                fprintf(fp,'%d, ',Mess(i).fields.byte{j});
            end
        end
        fprintf(fp,'};\n');

        %%% define java variable lengths (in bytes)
        fprintf(fp,'\t\t\t// int[] javLen = {');
        for j=1:N
            if (j==N)
                fprintf(fp,'%d',JAVA.byte{j});
            else
                fprintf(fp,'%d, ',JAVA.byte{j});
            end
        end
        fprintf(fp,'};\n\n');

%         fprintf(fp,'\t\t\trcvPacket.pBuf.position(packet.DATA_OFFSET);     // Skip the packet header\n');
        for j=1:N
            mpad = char(9*ones(1,ceil((ml+1-length(Mess(i).fields.name{j}))/4)));
            vname = Mess(i).fields.name{j};
            
            if (JAVA.array{j})
                if ((JAVA.byte{j} == Mess(i).fields.byte{j}) || (JAVA.byte{j} == JAVA.array{j}*Mess(i).fields.byte{j}))
                    fprintf(fp,'\t\t\trcvPacket.getByte(%s, 0, %d);\n',vname,JAVA.byte{j});
                else
                    fprintf(fp,'//\tERROR\tParsing ''%s'' array of ''%s'' from ''%s''\n',vname,JAVA.type{j},Mess(i).fields.type{j});
                    fprintf('//\tERROR\tParsing ''%s'' array of ''%s'' from ''%s'' in MESSAGE: ''%s''\n',vname,JAVA.type{j},Mess(i).fields.type{j},Mess(i).name);
                end
            else
                if (JAVA.byte{j} == Mess(i).fields.byte{j})
                    switch(JAVA.type{j})
                        case 'byte'
                            %fprintf(fp,'\t\t\t%s%s= rcvPacket.pBuf.get();\n',vname,mpad);
                            fprintf(fp,'\t\t\t%s%s= rcvPacket.getByte();\n',vname,mpad);
                        case 'short'
                            %fprintf(fp,'\t\t\t%s%s= rcvPacket.pBuf.getShort();\n',vname,mpad);
                            fprintf(fp,'\t\t\t%s%s= rcvPacket.getShort();\n',vname,mpad);
                        case 'int'
                            %fprintf(fp,'\t\t\t%s%s= rcvPacket.pBuf.getInt();\n',vname,mpad);
                            fprintf(fp,'\t\t\t%s%s= rcvPacket.getInt();\n',vname,mpad);
                        case 'long'
                            %fprintf(fp,'\t\t\t%s%s= rcvPacket.pBuf.getLong();\n',vname,mpad);
                            fprintf(fp,'\t\t\t%s%s= rcvPacket.getLong();\n',vname,mpad);
                        case 'float'
                            %fprintf(fp,'\t\t\t%s%s= rcvPacket.pBuf.getFloat();\n',vname,mpad);
                            fprintf(fp,'\t\t\t%s%s= rcvPacket.getFloat();\n',vname,mpad);
                        otherwise
                            %fprintf(fp,'\t\t\trcvPacket.pBuf.get(%s, 0, %d);\n',vname,Mess(i).fields.byte{j});
                            %fprintf(fp,'\t\t\trcvPacket.getByte(%s, 0, %d);\n',vname,JAVA.byte{j});
                            fprintf(fp,'//\tERROR\tParsing ''%s'' a ''%s'' from a ''%s''\n',vname,JAVA.type{j},Mess(i).fields.type{j});
                            fprintf('//\tERROR\tParsing ''%s'' a ''%s'' from a ''%s'' in MESSAGE: ''%s''\n',vname,JAVA.type{j},Mess(i).fields.type{j},Mess(i).name);
                    end
                else
                    switch(JAVA.type{j})
                        case 'short'
                            %fprintf(fp,'\t\t\t%s%s= rcvPacket.BB.putLong(0,0L).put(0,rcvPacket.pBuf.get()).getShort(0);\n',vname,mpad);
                            fprintf(fp,'\t\t\t%s%s= rcvPacket.getShortB();\n',vname,mpad);
                        case 'int'
                            %fprintf(fp,'\t\t\t%s%s= rcvPacket.BB.putLong(0,0L).putShort(0,rcvPacket.pBuf.getShort()).getInt(0);\n',vname,mpad);
                            fprintf(fp,'\t\t\t%s%s= rcvPacket.getIntS();\n',vname,mpad);
                        case 'long'
                            %fprintf(fp,'\t\t\t%s%s= rcvPacket.BB.putLong(0,0L).putInt(0,rcvPacket.pBuf.getInt()).getLong(0);\n',vname,mpad);
                            fprintf(fp,'\t\t\t%s%s= rcvPacket.getLongI();\n',vname,mpad);
                        otherwise
                            %%fprintf(fp,'\t// Don''t know how to handle this case\n\t// %s = buf.get????();\n',vname);
                            fprintf(fp,'//\tERROR\tParsing ''%s'' a ''%s'' from a ''%s''\n',vname,JAVA.type{j},Mess(i).fields.type{j});
                            fprintf('//\tERROR\tParsing ''%s'' a ''%s'' from a ''%s'' in MESSAGE: ''%s''\n',vname,JAVA.type{j},Mess(i).fields.type{j},Mess(i).name);
                    end
                end
            end
        end

        %%% Close function
        fprintf(fp,'\t\t}\n');
        fprintf(fp,'\t\treturn(pstatus);\n');
        fprintf(fp,'\t}\n\n');

%%% Now begins the FIRST encode section
        fprintf(fp,'\tpublic byte[] encode()\n\t{\n');
        fprintf(fp,'\t\treturn encode(\n');
        for j=1:N
            if (j==1)
                if (j==msgWithSystemIdx)
                    fprintf(fp,'\t\t\t\t\t  (%s)1\n',JAVA.type{j});
                elseif (j==msgWithComponentIdx)
                    fprintf(fp,'\t\t\t\t\t  (%s)1\n',JAVA.type{j});
                else
                    fprintf(fp,'\t\t\t\t\t  %s\n',Mess(i).fields.name{j});
                end
            else
                if (j==msgWithSystemIdx)
                    fprintf(fp,'\t\t\t\t\t ,(%s)1\n',JAVA.type{j});
                elseif (j==msgWithComponentIdx)
                    fprintf(fp,'\t\t\t\t\t ,(%s)1\n',JAVA.type{j});
                else
                    fprintf(fp,'\t\t\t\t\t ,%s\n',Mess(i).fields.name{j});
                end
            end
        end
        fprintf(fp,sprintf( '\t\t\t\t\t );\n'));
        fprintf(fp,'\t}\n\n');

%%% Now begins the optional SECOND encode section
        if (~isempty([msgWithSystemIdx msgWithComponentIdx]) && (N>length([msgWithSystemIdx msgWithComponentIdx])))
            fprintf(fp,'\tpublic byte[] encode(\n');
            first = 1;
            for j=1:N
                if (first)
                    if (~any(intersect(j,[msgWithSystemIdx msgWithComponentIdx])))
                        if (JAVA.array{j})
                            fprintf(fp,'\t\t\t\t\t\t %s[] v_%s\n',JAVA.type{j},Mess(i).fields.name{j});
                        else
                            fprintf(fp,'\t\t\t\t\t\t %s v_%s\n',JAVA.type{j},Mess(i).fields.name{j});
                        end
                        first = 0;
                    end
                else
                    if (~any(intersect(j,[msgWithSystemIdx msgWithComponentIdx])))
                        if (JAVA.array{j})
                            fprintf(fp,'\t\t\t\t\t\t,%s[] v_%s\n',JAVA.type{j},Mess(i).fields.name{j});
                        else
                            fprintf(fp,'\t\t\t\t\t\t,%s v_%s\n',JAVA.type{j},Mess(i).fields.name{j});
                        end
                    end
                end
            end
            fprintf(fp,sprintf( '\t\t\t\t\t\t)\n\t{\n'));

            fprintf(fp,'\t\treturn encode(\n');
            for j=1:N
                if (j==1)
                    if (j==msgWithSystemIdx)
                        fprintf(fp,'\t\t\t\t\t    (%s)1\n',JAVA.type{j});
                    elseif (j==msgWithComponentIdx)
                        fprintf(fp,'\t\t\t\t\t    (%s)1\n',JAVA.type{j});
                    else
                        fprintf(fp,'\t\t\t\t\t  v_%s\n',Mess(i).fields.name{j});
                    end
                else
                    if (j==msgWithSystemIdx)
                        fprintf(fp,'\t\t\t\t\t ,  (%s)1\n',JAVA.type{j});
                    elseif (j==msgWithComponentIdx)
                        fprintf(fp,'\t\t\t\t\t ,  (%s)1\n',JAVA.type{j});
                    else
                        fprintf(fp,'\t\t\t\t\t ,v_%s\n',Mess(i).fields.name{j});
                    end
                end
            end
            fprintf(fp,sprintf( '\t\t\t\t\t );\n'));
            fprintf(fp,'\t}\n\n');
        end

%%% Now begins the THIRD encode section
        fprintf(fp,'\tpublic byte[] encode(\n');
        for j=1:N
            if (j==1)
                if (JAVA.array{j})
                    ftext = sprintf('\t\t\t\t\t\t %s[] v_%s\n',JAVA.type{j},Mess(i).fields.name{j});
                else
                    ftext = sprintf('\t\t\t\t\t\t %s v_%s\n',JAVA.type{j},Mess(i).fields.name{j});
                end
            else
                if (JAVA.array{j})
                    ftext = sprintf('\t\t\t\t\t\t,%s[] v_%s\n',JAVA.type{j},Mess(i).fields.name{j});
                else
                    ftext = sprintf('\t\t\t\t\t\t,%s v_%s\n',JAVA.type{j},Mess(i).fields.name{j});
                end
            end
            fprintf(fp,'%s',ftext);
        end
        fprintf(fp,sprintf( '\t\t\t\t\t\t)\n\t{\n'));
        
        %%% Body of encode function
        %fprintf(fp,'\t\tpacket pkt = new packet(msgID);\n');
%         if(needBB)
%             fprintf(fp,'\t\tbyte[] temp = {0,0,0,0,0,0,0,0};\n');
%             fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.wrap(temp);\n\n');
%         end
%         fprintf(fp,'\t\tbyte[] msg = new byte[%d];\t// includes header and checksum\n',packetSize+8);
%         fprintf(fp,'\t\tByteBuffer p = ByteBuffer.wrap(msg);\n\n');

        %%% define MavLink member lengths (in bytes)
        fprintf(fp,'\t\t// int[] mavLen = {');
        for j=1:N
            if (j==N)
                fprintf(fp,'%d',Mess(i).fields.byte{j});
            else
                fprintf(fp,'%d, ',Mess(i).fields.byte{j});
            end
        end
        fprintf(fp,'};\n');

        %%% define java variable lengths (in bytes)
        fprintf(fp,'\t\t// int[] javLen = {');
        for j=1:N
            if (j==N)
                fprintf(fp,'%d',JAVA.byte{j});
            else
                fprintf(fp,'%d, ',JAVA.byte{j});
            end
        end
        fprintf(fp,'};\n\n');
%         fprintf(fp,'\t\t// encode the header for Message ID: %d\n',ID);
%         fprintf(fp,'\t\tMavHeader head = new MavHeader((byte)%d);\n',ID);
%         fprintf(fp,'\t\tp.put(head.getHeader(),0,MavHeader.HEADER_SIZE);\n\n');

%         fprintf(fp,'\t\tsndPacket.pBuf.position(packet.DATA_OFFSET);\n');
        fprintf(fp,'\t\tsndPacket.setSndSeq();\n\n');
        fprintf(fp,'\t\tsndPacket.resetDataIdx();\n');
        for j=1:N
            vname = Mess(i).fields.name{j};
            if (JAVA.array{j})
                if ((JAVA.byte{j} == Mess(i).fields.byte{j}) || (JAVA.byte{j} == JAVA.array{j}*Mess(i).fields.byte{j}))
                    fprintf(fp,'\t\tsndPacket.putByte(v_%s,0,%d);',JAVA.name{j},JAVA.byte{j});
                else
                    fprintf(fp,'//\tERROR\tEncoding ''%s'' array of ''%s'' from ''%s''\n',vname,JAVA.type{j},Mess(i).fields.type{j});
                    fprintf('//\tERROR\tEncoding ''%s'' array of ''%s'' from ''%s'' in MESSAGE: ''%s''\n',vname,JAVA.type{j},Mess(i).fields.type{j},Mess(i).name);
                end
            else
                if (JAVA.byte{j} == Mess(i).fields.byte{j})
                    switch(JAVA.type{j})
                        case 'byte'
                            %fprintf(fp,'\t\tsndPacket.pBuf.put(v_%s);',Mess(i).fields.name{j});
                            fprintf(fp,'\t\tsndPacket.putByte(v_%s);',Mess(i).fields.name{j});
                        case 'short'
                            %fprintf(fp,'\t\tsndPacket.pBuf.putShort(v_%s);',Mess(i).fields.name{j});
                            fprintf(fp,'\t\tsndPacket.putShort(v_%s);',Mess(i).fields.name{j});
                        case 'int'
                            %fprintf(fp,'\t\tsndPacket.pBuf.putInt(v_%s);',Mess(i).fields.name{j});
                            fprintf(fp,'\t\tsndPacket.putInt(v_%s);',Mess(i).fields.name{j});
                        case 'long'
                            %fprintf(fp,'\t\tsndPacket.pBuf.putLong(v_%s);',Mess(i).fields.name{j});
                            fprintf(fp,'\t\tsndPacket.putLong(v_%s);',Mess(i).fields.name{j});
                        case 'float'
                            %fprintf(fp,'\t\tsndPacket.pBuf.putFloat(v_%s);',Mess(i).fields.name{j});
                            fprintf(fp,'\t\tsndPacket.putFloat(v_%s);',Mess(i).fields.name{j});
                        otherwise
                            %fprintf(fp,'\t\tsndPacket.pBuf.put(v_%s,0,%d);',Mess(i).fields.name{j},Mess(i).fields.byte{j});
                            %fprintf(fp,'\t\tsndPacket.putByte(v_%s,0,%d);',Mess(i).fields.name{j},Mess(i).fields.byte{j});
                            fprintf(fp,'//\tERROR\tEncoding ''%s'' a ''%s'' from a ''%s''\n',vname,JAVA.type{j},Mess(i).fields.type{j});
                            fprintf('//\tERROR\tEncoding ''%s'' a ''%s'' from a ''%s'' in MESSAGE: ''%s''\n',vname,JAVA.type{j},Mess(i).fields.type{j},Mess(i).name);
                    end
                else
                    switch(JAVA.type{j})
                        case 'short'
                            %fprintf(fp,'\t\tsndPacket.pBuf.put(sndPacket.BB.putShort(0,v_%s).get(0));',Mess(i).fields.name{j});
                            fprintf(fp,'\t\tsndPacket.putByteS(v_%s);',Mess(i).fields.name{j});
                        case 'int'
                            %fprintf(fp,'\t\tsndPacket.pBuf.putShort(sndPacket.BB.putInt(0,v_%s).getShort(0));',Mess(i).fields.name{j});
                            fprintf(fp,'\t\tsndPacket.putShortI(v_%s);',Mess(i).fields.name{j});
                        case 'long'
                            %fprintf(fp,'\t\tsndPacket.pBuf.putInt(sndPacket.BB.putLong(0,v_%s).getInt(0));',Mess(i).fields.name{j});
                            fprintf(fp,'\t\tsndPacket.putIntL(v_%s);',Mess(i).fields.name{j});
                        otherwise
                            %%fprintf(fp,'\t// Don''t know how to handle this case\n\t// %s = buf.get????();\n',vname);
                            fprintf(fp,'//\tERROR\tEncoding ''%s'' a ''%s'' from a ''%s''\n',vname,Mess(i).fields.type{j},JAVA.type{j});
                            fprintf('//\tERROR\tEncoding ''%s'' a ''%s'' from a ''%s'' in MESSAGE: ''%s''\n',vname,Mess(i).fields.type{j},JAVA.type{j},Mess(i).name);
                    end
                end
            end
            fprintf(fp,'\t// Add "%s" parameter\n',Mess(i).fields.name{j});
        end

        fprintf(fp,'\n\t\t// encode the checksum\n');
        fprintf(fp,'\n\t\tsndPacket.putChkSum();\n');
%         fprintf(fp,'\t\tp.order(java.nio.ByteOrder.LITTLE_ENDIAN);\n');
%         fprintf(fp,'\t\tp.putShort(MavCheckSum.getChecksum(msg));\n');
        
        fprintf(fp,'\n\t\treturn sndPacket.getPacket();\n');
%         fprintf(fp,'\n\t\treturn sndPacket.sndPacket;\n');
%         fprintf(fp,'\n\t\treturn msg;\n');
        fprintf(fp,'\t}\n\n');

        
%%% Loggable
    fprintf(fp,'\tpublic String getLogHeader()\n');
    fprintf(fp,'	{\n');
    fprintf(fp,'		String param = (\n');
    fprintf(fp,'				  "  time"\n');
% 				+ ", insert var name"
    for j=1:N
        fprintf(fp,' 				+ ", %s_%s"\n',Mess(i).name,Mess(i).fields.name{j});
    end
    fprintf(fp,'				);\n');
    fprintf(fp,'		return param;\n');
    fprintf(fp,'	}\n\n');

    fprintf(fp,'    public String getLogData()\n');
    fprintf(fp,'	{\n');
    fprintf(fp,'		String param = (\n');
    fprintf(fp,'				System.currentTimeMillis()\n');
% 				+ ", " + var ...
    for j=1:N
        fprintf(fp,' 				+ ", " + %s\n',Mess(i).fields.name{j});
    end
    fprintf(fp,'				);\n');
    fprintf(fp,'		return param;\n');
    fprintf(fp,'	}\n');
        
        
%%%        
        fprintf(fp,'}\n'); %% End of MavLink Class
        fclose(fp); fp = [];
    end   % For each MavLink message
    

%%% Generate the MavLink Class
    fp = fopen(sprintf('%s\\APData.java',dDir),'w');
    if (~LOCAL)
        fprintf(fp,'package gov.nasa.larc.AP;\n\n');
    end
    %fprintf(fp,'import java.nio.ByteBuffer;\n\n');
    fprintf(fp,'/**\n * @author svazquez\n *\n */\n');
    fprintf(fp,'public class APData\n{\n');

    %%% Max name and type lengths
    ml = 0;
    for i=1:K
        ml = max([ml length(Mess(i).name)]);
    end
    ml = 4*ceil((ml+17)/4);

    for i=1:K   % For each MavLink message
        %mpad = char(20*ones(1,ml+1-length(Mess(i).name)));
        ntabs = ceil((ml-(length(Mess(i).name)+24))/4);
        mpad = char(9*ones(1,ntabs));
        %%disp(sprintf('%s %d',Mess(i).name,length(mpad)));
        fprintf(fp,'\tpublic static %s_class%s\t%s%s\t= new %s_class();%s\t// (%s)\n',Mess(i).name,mpad,Mess(i).name,mpad,Mess(i).name,mpad,Mess(i).id);
    end
    
%%%
    fprintf(fp,'\n\tpublic static boolean processPacket(byte[] pkt, boolean valid)\n');
    fprintf(fp,'\t{\n');
    fprintf(fp,'\t\tswitch(pkt[5])\n');
    fprintf(fp,'\t\t{\n');
    for i=1:K
        fprintf(fp,'\t\t\tcase (byte)%s:',Mess(i).id);
        %fprintf(fp,'\t\t\t\t%s = new %s_class();\n',Mess(i).name,Mess(i).name);
        fprintf(fp,'\treturn(%s.parse(pkt, valid));\n',Mess(i).name);
    end
    fprintf(fp,'\t\t\tdefault:\n\t\t\t\treturn(false);\n');
    fprintf(fp,'\t\t}\n');
    fprintf(fp,'\t}\n');
    
%%% Init function
    fprintf(fp,'\n\tpublic static void initMessages()\n');
    fprintf(fp,'\t{\n');
    for i=1:K
        if (intersect(i,msgWithSystem))
            fprintf(fp,'\t\t%s.target_system = 1;\n',Mess(i).name);
        end
        if (intersect(i,msgWithComponent))
            fprintf(fp,'\t\t%s.target_component = 1;\n',Mess(i).name);
        end
    end
    fprintf(fp,'\t}\n');
    
%%% List All Messages, All parameters
%     fprintf(fp,'/*\n');
%     for i=1:K
%         N = size(Mess(i).fields.name,1);
%         ml = 0;
%         for j=1:N
%             ml = max(ml,8+length(Mess(i).fields.name{j}));
%         end
%         ml = 4*(ceil(ml/4));
%         fprintf(fp,'\t%s\t%s\n',Mess(i).name,Mess(i).fdesc);
%         N = size(Mess(i).fields.name,1);
%         for j=1:N
%             padL = ceil((ml-length(Mess(i).fields.name{j}))/4);
%             pad = char(9*ones(1,padL));
%             fprintf(fp,'\t\t%s%s%s\n',Mess(i).fields.name{j},pad,Mess(i).fields.desc{j});
%         end
%     end
%     fprintf(fp,'*/\n');
    
%%% 
    fprintf(fp,'}\n');
    fclose(fp);
    
%%% Header Object
    fp = fopen(sprintf('%s\\MavHeader.java',dDir),'w');
    if (~LOCAL)
        fprintf(fp,'package gov.nasa.larc.AP;\n\n');
    end
    %fprintf(fp,'import java.nio.ByteBuffer;\n\n');
    fprintf(fp,'public class MavHeader\n');
    fprintf(fp,'{\n');

    %%% Generate Message Length Array
    jSize = zeros(1,256);
    K = length(Mess);
    for i=1:K   % For each MavLink message
        idx = 1+sscanf(Mess(i).id,'%d');
        jSize(idx) = sum(cell2mat(Mess(i).fields.byte));
    end
    fprintf(fp,'\t//                                          {');
    for i=1:256
        if (mod(i-1,10)==0)
            fprintf(fp,'%3d,',i-1);
        else
            if (i==256)
                fprintf(fp,'   ');
            else
                fprintf(fp,'   ,');
            end
        end
    end
    fprintf(fp,'};\n');
    fprintf(fp,'\tpublic static final byte[] MsgLengthArray = {');
    for i=1:256
        if (i==256)
            fprintf(fp,'%3d',jSize(i));
        else
            fprintf(fp,'%3d,',jSize(i));
        end
    end
    fprintf(fp,'};\n\n');
    
    %%%
%     fprintf(fp,'\tstatic final short HEADER_SIZE = 6;\n');
%     fprintf(fp,'\tstatic final short CHKSUM_SIZE = 2;\n');
%     fprintf(fp,'\tstatic final byte  MAV_MARKER  = (byte) 85;\n');
%     fprintf(fp,'\tstatic final byte  BEAGLE_ID   = (byte)103;\n');
%     fprintf(fp,'\tstatic final byte  AP_ID       = (byte)  1;\n');
%     fprintf(fp,'\tstatic final byte  XBEE_ID     = (byte)255;\n');
%     fprintf(fp,'\tstatic final byte  COMP_ID     = (byte)  1;\n');
    
    %%%
%     fprintf(fp,'\n\tboolean vHeader;\n');
%     fprintf(fp,'\tbyte msgHead;\n');
%     fprintf(fp,'\tbyte msgLen;\n');
%     fprintf(fp,'\tbyte msgSeq;\n');
%     fprintf(fp,'\tbyte msgSid;\n');
%     fprintf(fp,'\tbyte msgCid;\n');
%     fprintf(fp,'\tbyte msgGid;\n\n');
%     fprintf(fp,'\tstatic byte RcvSeq;\n');
%     fprintf(fp,'\tstatic byte PreRcvSeq;\n');
%     fprintf(fp,'\tstatic byte SndSeq = 0;\n\n');

    %%% Contruct Header from byte[]. 
    %%% Usually implies that a packet is being RECEIVED!
%     fprintf(fp,'\tpublic MavHeader(byte[] hdr)\n\t{\n');
%     fprintf(fp,'\t\tvHeader = isValid(hdr);\n');
%     fprintf(fp,'\t\tif (!vHeader)\treturn;\n\n');
%     fprintf(fp,'\t\tmsgHead = hdr[0];\n');
%     fprintf(fp,'\t\tmsgLen  = hdr[1];\n');
%     fprintf(fp,'\t\tmsgSeq  = hdr[2];\n');
%     fprintf(fp,'\t\tmsgSid  = hdr[3];\n');
%     fprintf(fp,'\t\tmsgCid  = hdr[4];\n');
%     fprintf(fp,'\t\tmsgGid  = hdr[5];\n');
%     fprintf(fp,'\t\tPreRcvSeq = RcvSeq;\n');
%     fprintf(fp,'\t\tRcvSeq    = msgSeq;\n');
%     fprintf(fp,'\t}\n\n');
    
    %%% Contruct a Header for a Message with ID "mid"
    %%% Usually implies constructing a packet to be SENT!
%     fprintf(fp,'\tpublic MavHeader(byte mid)\n\t{\n');
%     fprintf(fp,'\t\tvHeader = true;\n');
%     fprintf(fp,'\t\tmsgHead = MAV_MARKER;\n');
%     fprintf(fp,'\t\tmsgLen  = MsgLengthArray[getMsgID(mid)];\n');
%     fprintf(fp,'\t\tmsgSeq  = SndSeq++;\n');
%     fprintf(fp,'\t\tmsgSid  = BEAGLE_ID;\n');
%     fprintf(fp,'\t\tmsgCid  = COMP_ID;\n');
%     fprintf(fp,'\t\tmsgGid  = mid;\n');
%     fprintf(fp,'\t}\n\n');
    
    %%% Identifies a valid RECEIVED header
%     fprintf(fp,'\tpublic boolean isValid(byte[] hdr)\n\t{\n');
%     fprintf(fp,'\t\tif (hdr.length<HEADER_SIZE)\treturn(false);\n');
%     fprintf(fp,'\t\treturn ((hdr[0]==MAV_MARKER)\n');
%     fprintf(fp,'\t\t      &&(hdr[1]==MsgLengthArray[getMsgID(hdr)])\n');
%     fprintf(fp,'\t\t      &&(hdr[3]==AP_ID)||(hdr[3]==XBEE_ID)||(hdr[3]==BEAGLE_ID)\n');
%     fprintf(fp,'\t\t      &&(hdr[4]==COMP_ID));\n');
%     fprintf(fp,'\t}\n\n');
    %%%
%     fprintf(fp,'\tpublic boolean isValid()\n\t{\n');
%     fprintf(fp,'\t\treturn(vHeader);\n');
%     fprintf(fp,'\t}\n\n');
    
    %%% Returns the header as a byte array
%     fprintf(fp,'\tpublic byte[] getHeader()\n\t{\n');
%     fprintf(fp,'\t\tbyte[] hdr = {msgHead,msgLen,msgSeq,msgSid,msgCid,msgGid};\n');
%     fprintf(fp,'\t\treturn(hdr);\n');
%     fprintf(fp,'\t}\n\n');
    
    %%%
%     fprintf(fp,'\tpublic short getMsgHead(byte[] hdr)\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr[0]).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgHead()\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,msgHead).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgLength(byte[] hdr)\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr[1]).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgLength()\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,msgLen).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgLength(short idx)\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,MsgLengthArray[idx]).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getFullLength()\n\t{\n');
%     fprintf(fp,'\t\treturn (short)(getMsgLength()+HEADER_SIZE+CHKSUM_SIZE);\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getFullLength(short idx)\n\t{\n');
%     fprintf(fp,'\t\treturn (short)(getMsgLength(idx)+HEADER_SIZE+CHKSUM_SIZE);\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgSeq(byte[] hdr)\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr[2]).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgSeq()\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,msgSeq).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgSysID(byte[] hdr)\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr[3]).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgSysID()\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,msgSid).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgCompID(byte[] hdr)\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr[4]).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgCompID()\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,msgCid).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgID(byte[] hdr)\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr[5]).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgID()\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,msgGid).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getMsgID(byte hdr)\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,hdr).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     
%     fprintf(fp,'\tpublic short getRcvSeq()\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,RcvSeq).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
%     fprintf(fp,'\tpublic short getPreRcvSeq()\n\t{\n');
%     fprintf(fp,'\t\tByteBuffer BB = ByteBuffer.allocate(2);\n');
%     fprintf(fp,'\t\treturn (BB.putShort(0,(short)0).put(0,PreRcvSeq).getShort(0));\n');
%     fprintf(fp,'\t}\n\n');
    
    fprintf(fp,'}\n');
    fclose(fp); fp = [];

%%% MavLink CheckSum Class
%     fp = fopen(sprintf('%s\\src\\MavCheckSum.java',dDir),'w');
%     if (~LOCAL)
%         fprintf(fp,'package gov.nasa.larc.MavLink_0_9;\n\n');
%     end
%     fprintf(fp,'import java.nio.ByteBuffer;\n\n');
%     fprintf(fp,'public class MavCheckSum\n');
%     fprintf(fp,'{\n');
% %     fprintf(fp,'\tprotected byte[] temp = {0,0,0,0,0,0,0,0};\n');
% %     fprintf(fp,'\tprotected ByteBuffer t = ByteBuffer.wrap(temp);\n\n');
% 
%     %%
%     fprintf(fp,'\tpublic static boolean isValid(byte[] pkt)\n');
%     fprintf(fp,'\t{\n');
%     fprintf(fp,'\t\tshort crc;\n');
%     fprintf(fp,'\t\tshort pktCRC;\n');
%     fprintf(fp,'\t\tByteBuffer pktb = ByteBuffer.wrap(pkt);\n\n');
%     fprintf(fp,'\t\tbyte N = (byte)pkt.length;\n');
%     fprintf(fp,'\t\tpktCRC = pktb.getShort(N-2);\n');
%     fprintf(fp,'\t\tcrc = getChecksum(pkt);\n');
%     fprintf(fp,'\t\treturn (boolean)(pktCRC==crc);\n');
%     fprintf(fp,'\t}\n\n');
%     
%     %%  Generate getChecksum function
%     fprintf(fp,'\t//=====================================================================================//\n');
%     fprintf(fp,'\t/**\n');
%     fprintf(fp,'\t * compute the checksum for a given message.  Use the indicated number of bytes starting\n');
%     fprintf(fp,'\t * at the second byte.\n');
%     fprintf(fp,'\t * @param msg\n');
%     fprintf(fp,'\t * @return checksum: 2 byte checksum\n');
%     fprintf(fp,'\t */\n');
%     fprintf(fp,'\t//=====================================================================================//\n');
%     fprintf(fp,'\tpublic static short getChecksum(byte[] data) \n');
%     fprintf(fp,'\t{\n');
%     fprintf(fp,'\t    int N   = data.length;\n');
%     fprintf(fp,'\t    byte b  = 0x00;\n');
%     fprintf(fp,'\t    byte ch = 0x00;\n');
%     fprintf(fp,'\t    short crc  = (short) 0xffff;\n');
% %     fprintf(fp,'\t    short ooff = (short) 0x00ff;    //255;\n');
%     fprintf(fp,'\t    short tempcrc = 0x0000;\n');
%     fprintf(fp,'\t    for (int i=1; i<N-2; i++)\n');
%     fprintf(fp,'\t    {\n');
%     fprintf(fp,'\t        b = data[i];\n');
%     fprintf(fp,'\t        ch = (byte) (b  ^  ((byte)(crc & 0x00ff) ))  ;\n');
%     fprintf(fp,'\t        ch = (byte) ((ch ^ (ch << 4) ));\n');
%     fprintf(fp,'\t        tempcrc = (short) (crc >> 8);\n');
%     fprintf(fp,'\t        tempcrc = (short) (tempcrc & 0x00ff);\n');
%     fprintf(fp,'\t        short a1 = (short) ((short)ch << 8);\n');
%     fprintf(fp,'\t        short a2 = (short) (tempcrc ^ a1);\n');
%     fprintf(fp,'\t        short a3 = (short) ((short)ch << 3);\n');
%     fprintf(fp,'\t        short a3a = (short) (a3 & 0x07ff);\n');
%     fprintf(fp,'\t        short a4 = (short) (a2 ^ a3a);\n');
%     fprintf(fp,'\t        short a5 = (short) ((short)ch >> 4);\n');
%     fprintf(fp,'\t        short a6 = (short) ((short) a5 & 0x000f);\n');
%     fprintf(fp,'\t        crc = (short) (a4 ^ a6);\n');
%     fprintf(fp,'\t    }\n\n');
% %     fprintf(fp,'\t    t.putShort(0,crc);\n');
% %     fprintf(fp,'\t    data[N++] = t.get(1);\n');
% %     fprintf(fp,'\t    data[N++] = t.get(0);\n');
% %     fprintf(fp,'\t    t.putLong(0,zero); // sets ByteBuffer t back to zero\n\n');
%     fprintf(fp,'\t    return crc;\n');
%     fprintf(fp,'\t}\n');
%     fprintf(fp,'}\n\n');
%     fclose(fp); fp = [];
% 
% % function crc = checksum_v0_9(data)
% %     MAVLINK_MESSAGE_LENGTHS = uint8([3, 4, 8, 14, 8, 28, 3, 32, 0, 2, 3, 2, 2, 0, 0, 0, 0, 0, 0, 0, 19, 2, 23, 21, 0, 37, 26, 101, 26, 16, 32, 32, 37, 32, 11, 17, 17, 16, 18, 36, 4, 4, 2, 2, 4, 2, 2, 3, 14, 12, 18, 16, 8, 27, 25, 18, 18, 24, 24, 0, 0, 0, 26, 16, 36, 5, 6, 56, 26, 21, 18, 0, 0, 18, 20, 20, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 36, 0, 0, 0, 0, 0, 0, 0, 0, 0, 42, 8, 4, 12, 15, 13, 6, 15, 14, 0, 12, 3, 8, 28, 36, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 30, 14, 14, 51, 5]');
% %     MAVLINK_MESSAGE_CRCS = uint8([72, 39, 190, 92, 191, 217, 104, 119, 0, 219, 60, 186, 10, 0, 0, 0, 0, 0, 0, 0, 89, 159, 162, 121, 0, 149, 222, 110, 179, 136, 66, 126, 185, 147, 112, 252, 162, 215, 229, 128, 9, 106, 101, 213, 4, 229, 21, 214, 215, 14, 206, 50, 157, 126, 108, 213, 95, 5, 127, 0, 0, 0, 57, 126, 130, 119, 193, 191, 236, 158, 143, 0, 0, 104, 123, 131, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 174, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 155, 0, 0, 0, 0, 0, 0, 0, 0, 0, 143, 29, 208, 188, 118, 242, 19, 97, 233, 0, 18, 68, 136, 205, 42, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 178, 224, 60, 106, 7]');
% %     N = length(data);
% %     b = uint8(0);
% %     ch = uint8(0);
% %     crc = uint16(65535);
% %     ooff = uint16(255);
% %     for i=1:N
% %         b = data(i);
% %         ch = bitxor(b,uint8(bitand(crc,ooff)));
% %         ch = uint8(bitxor(ch,bitshift(ch,4)));
% %         crc = uint16(bitxor(bitxor(bitxor(bitshift(crc,-8),bitshift(uint16(ch),8)),bitshift(uint16(ch),3)),bitshift(uint16(ch),-4)));
% %     end
% % return
    
    switch (VERSION)
        case 0.9
            disp('Done JAVA code for MavLink 0.9')
        case 1.0
            disp('Done JAVA code for MavLink 1.0')
        otherwise
            disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
            return
    end
return

%% Generate APM Code based on XML data
function genAPMCode(Mess)
    global SWAP;
    global VERSION;
    if (SWAP)
        disp('Offset SWAPPING')
    end
    switch (VERSION)
        case 0.9
            %dDir = 'G:\\ArduRepo\\libraries\\GCS_MAVLink\\include\\common';
            dDir = 'AP\\include\\common';
        case 1.0
            %dDir = 'G:\\ArduRepo\\libraries\\GCS_MAVLink\\include_v1.0\\common';
            dDir = 'AP\\include_v1.0\\common';
        otherwise
            disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
            return
    end
    if (isempty(dir(dDir)))
        mkdir(dDir);
    end
    %dDir = 'APM\\ap';
    if (isempty(dir(dDir)))
        mkdir(dDir);
    end

    %% initialization
    %% Generate function header
    K = length(Mess);
    MAVLINK_MESSAGE_LENGTHS = zeros(1,256);
    MAVLINK_MESSAGE_INFO = cell(1,256);
    for i=1:256
        MAVLINK_MESSAGE_INFO{i} = '{NULL}';
    end
    
    for i=1:K   % For each MavLink message
        N = size(Mess(i).fields.name,1);
        ID = sscanf(Mess(i).id,'%d');
        IDX=Mess(i).fields.idx;
        
        packetSize = sum(cell2mat(Mess(i).fields.apmByte));
        
        %% Message Length Array
        MAVLINK_MESSAGE_LENGTHS(ID+1) = packetSize;
        MAVLINK_MESSAGE_INFO{ID+1} = sprintf('MAVLINK_MESSAGE_INFO_%s',Mess(i).name);
        
        %% Do MavLink to APM types substitution
        APM.name = Mess(i).fields.name;
        APM.type = Mess(i).fields.apmType;
        APM.byte = Mess(i).fields.apmByte;
        APM.desc = Mess(i).fields.desc;
        APM.array = Mess(i).fields.Array;
        APM.uoffset = Mess(i).fields.uoffset;
        APM.soffset = Mess(i).fields.soffset;
        
%         %% Include file Array
%         fprintf(mif,sprintf('#include "./mavlink_msg_%s.h"\n',lower(Mess(i).name)));
% 
        %% Function Header
        newf = sprintf('%s\\mavlink_msg_%s.h',dDir,lower(Mess(i).name));
        fp = fopen(newf,'w');
        fprintf(fp,sprintf('// MESSAGE %s PACKING\n',Mess(i).name));
        fprintf(fp,'// Generated from parse_APM_XML.m on 24-Feb-2014 13:50:53\n\n');
        %fprintf(fp,sprintf('// Generated from parse_APM_XML.m on %s\n\n',datestr(clock)));
        
        fprintf(fp,sprintf('#define MAVLINK_MSG_ID_%s %d \n\n',Mess(i).name,ID));
        
        %% define structure for message
        fprintf(fp,sprintf('typedef struct __mavlink_%s_t \n',lower(Mess(i).name)));
        fprintf(fp,'{ \n');
        for j=1:N
            if (APM.array{j})
                if (SWAP)
                    fprintf(fp,'  %s %s[%d];  ///< %s\n',APM.type{IDX(j)}, APM.name{IDX(j)}, APM.array{IDX(j)}, APM.desc{IDX(j)});
                else
                    fprintf(fp,'  %s %s[%d];  ///< %s\n',APM.type{j}     , APM.name{j}     , APM.array{j}     , APM.desc{j});
                end
            else
                if (SWAP)
                    fprintf(fp,'  %s %s;  ///< %s\n',APM.type{IDX(j)}, APM.name{IDX(j)}, APM.desc{IDX(j)});
                else
                    fprintf(fp,'  %s %s;  ///< %s\n',APM.type{j}     , APM.name{j}     , APM.desc{j});
                end
            end
        end
        fprintf(fp,sprintf('} mavlink_%s_t;\n\n',lower(Mess(i).name)));
        
        %% define Message Length
        fprintf(fp,sprintf('#define MAVLINK_MSG_ID_%s_LEN %d\n',Mess(i).name,packetSize));
        fprintf(fp,sprintf('#define MAVLINK_MSG_ID_%d_LEN %d\n\n',ID,packetSize));
        
        %% define CRC Message Length
        if (VERSION == 1.0)
            crcSize = 0;    %% dummy CRC size, needs to be determined
            fprintf(fp,sprintf('#define MAVLINK_MSG_ID_%s_CRC %d\n',Mess(i).name,crcSize));
            fprintf(fp,sprintf('#define MAVLINK_MSG_ID_%d_CRC %d\n\n',ID,crcSize));
        end
        
        %% define Message INFO structure
        fprintf(fp,sprintf('#define MAVLINK_MESSAGE_INFO_%s \\\\\n{ \\\\\n',Mess(i).name));
        fprintf(fp,sprintf('  "%s", \\\\\n',Mess(i).name));
        fprintf(fp,sprintf('  %d, \\\\\n',N));
        fprintf(fp,sprintf('  { \\\\\n'));
%         voff = 0;
        for j=1:N
            if (SWAP)
                fprintf(fp,sprintf('    { "%s", NULL, MAVLINK_TYPE_%s, %d, %d, offsetof(mavlink_%s_t, %s) }, \\\\\n', APM.name{IDX(j)}, upper(APM.type{IDX(j)}), APM.array{IDX(j)}, APM.soffset(IDX(j)), lower(Mess(i).name), APM.name{IDX(j)}));
            else
                fprintf(fp,sprintf('    { "%s", NULL, MAVLINK_TYPE_%s, %d, %d, offsetof(mavlink_%s_t, %s) }, \\\\\n', APM.name{j}     , upper(APM.type{j})     , APM.array{j}     , APM.uoffset(j)     , lower(Mess(i).name), APM.name{j}));
            end
%             if (SWAP)
%                 voff = voff + APM.byte{IDX(j)};
%             else
%                 voff = voff + APM.byte{j};
%             end
        end
        fprintf(fp,sprintf('  } \\\\\n'));
        fprintf(fp,sprintf('}\n\n'));
        
        %% Function Header - mavlink_msg_xxx_pack
        fprintf(fp,'/**\n');
        fprintf(fp,sprintf(' * @brief Pack a %s message\n',lower(Mess(i).name)));
        fprintf(fp,' * @param system_id ID of this system\n');
        fprintf(fp,' * @param component_id ID of this component (e.g. 200 for IMU)\n');
        fprintf(fp,' * @param msg The MAVLink message to compress the data into\n');
        fprintf(fp,' *\n');
        for j=1:N
            fprintf(fp,sprintf(' * @param %s %s\n', APM.name{j}, APM.desc{j}));
        end
        fprintf(fp,' * @return length of the message in bytes (excluding serial stream start sign)\n');
        fprintf(fp,' */\n');
        %% Function Declaration
        fprintf(fp,sprintf('static inline uint16_t mavlink_msg_%s_pack(\n',lower(Mess(i).name)));
        fprintf(fp,'\t uint8_t system_id\n\t,uint8_t component_id\n\t,mavlink_message_t* msg\n');
        for j=1:N
            %if ((ID~=0) || ((ID==0)&&(j<N))) %% Heartbeat Message special processing
                if (APM.array{j} > 0)
                    fprintf(fp,sprintf('\t,const %s* %s\n', APM.type{j}, APM.name{j}));
                else
                    fprintf(fp,sprintf('\t,%s %s\n', APM.type{j}, APM.name{j}));
                end
            %end
        end
        fprintf(fp,'\t)\n{\n');
        %% Function Body
        fprintf(fp,'#if MAVLINK_NEED_BYTE_SWAP || !MAVLINK_ALIGNED_FIELDS\n');
        fprintf(fp,sprintf('\tchar buf[MAVLINK_MSG_ID_%s_LEN];\n',Mess(i).name));
%         voff = 0;
        for j=1:N
            %if ((ID==0) && (j==N)) %% Heartbeat Message special processing
            %    fprintf(fp,sprintf('\t_mav_put_%s(buf, %d, 2);\n',APM.type{j},voff));
            %else
            if (APM.array{j} > 0)
                if (SWAP)
                    fprintf(fp,sprintf('\t_mav_put_%s_array(buf, %d, %s, %d);\n',APM.type{IDX(j)},APM.soffset(IDX(j)),APM.name{IDX(j)},APM.array{IDX(j)}));
                else
                    fprintf(fp,sprintf('\t_mav_put_%s_array(buf, %d, %s, %d);\n',APM.type{j}     ,APM.uoffset(j)     ,APM.name{j}     ,APM.array{j}));
                end
            else
                if (SWAP)
                    fprintf(fp,sprintf('\t_mav_put_%s(buf, %d, %s);\n',APM.type{IDX(j)},APM.soffset(IDX(j)),APM.name{IDX(j)}));
                else
                    fprintf(fp,sprintf('\t_mav_put_%s(buf, %d, %s);\n',APM.type{j}     ,APM.uoffset(j)     ,APM.name{j}));
                end
            end
            %end
%             if (SWAP)
%                 voff = voff + APM.byte{IDX(j)};
%             else
%                 voff = voff + APM.byte{j};
%             end
        end

        switch (VERSION)
            case 0.9
                fprintf(fp,sprintf('\n\tmemcpy(_MAV_PAYLOAD(msg), buf, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name));
            case 1.0
                fprintf(fp,sprintf('\n\tmemcpy(_MAV_PAYLOAD_NON_CONST(msg), buf, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name));
            otherwise
                disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
                return
        end
        fprintf(fp,'#else\n');
        fprintf(fp,sprintf('\tmavlink_%s_t packet;\n',lower(Mess(i).name)));
        for j=1:N
            %if ((ID==0) && (j==N)) %% Heartbeat Message special processing
            %    fprintf(fp,sprintf('\tpacket.%s = 2;\n',APM.name{j}));
            %else
            if (APM.array{j} > 0)
                if (SWAP)
                    fprintf(fp,sprintf('\tmav_array_memcpy(packet.%s, %s, sizeof(%s)*%d);\n',APM.name{IDX(j)},APM.name{IDX(j)},APM.type{IDX(j)},APM.array{IDX(j)}));
                else
                    fprintf(fp,sprintf('\tmav_array_memcpy(packet.%s, %s, sizeof(%s)*%d);\n',APM.name{j},APM.name{j},APM.type{j},APM.array{j}));
                end
            else
                if (SWAP)
                    fprintf(fp,sprintf('\tpacket.%s = %s;\n',APM.name{IDX(j)},APM.name{IDX(j)}));
                else
                    fprintf(fp,sprintf('\tpacket.%s = %s;\n',APM.name{j},APM.name{j}));
                end
            end
            %end
        end

        switch (VERSION)
            case 0.9
                fprintf(fp,sprintf('\n\tmemcpy(_MAV_PAYLOAD(msg), &packet, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name));
            case 1.0
                fprintf(fp,sprintf('\n\tmemcpy(_MAV_PAYLOAD_NON_CONST(msg), &packet, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name));
            otherwise
                disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
                return
        end
        fprintf(fp,'#endif\n');

        fprintf(fp,sprintf('\n\tmsg->msgid = MAVLINK_MSG_ID_%s;\n',Mess(i).name));
        switch (VERSION)
            case 0.9
                fprintf(fp,sprintf('\treturn mavlink_finalize_message(msg, system_id, component_id, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name));
            case 1.0
                fprintf(fp,'#if MAVLINK_CRC_EXTRA\n');
                fprintf(fp,sprintf('\treturn mavlink_finalize_message(msg, system_id, component_id, MAVLINK_MSG_ID_%s_LEN, MAVLINK_MSG_ID_%s_CRC);\n',Mess(i).name,Mess(i).name));
                fprintf(fp,'#else\n');
                fprintf(fp,sprintf('\treturn mavlink_finalize_message(msg, system_id, component_id, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name));
                fprintf(fp,'#endif\n');
            otherwise
                disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
                return
        end
        fprintf(fp,'}\n\n');
        
        %% Function Header - mavlink_msg_xxx_pack_chan
        fprintf(fp,'/**\n');
        fprintf(fp,sprintf(' * @brief Pack a %s message on a channel\n',lower(Mess(i).name)));
        fprintf(fp,' * @param system_id ID of this system\n');
        fprintf(fp,' * @param component_id ID of this component (e.g. 200 for IMU)\n');
        fprintf(fp,' * @param chan The MAVLink channel this message was sent over\n');
        fprintf(fp,' * @param msg The MAVLink message to compress the data into\n');
        fprintf(fp,' *\n');
        for j=1:N
            fprintf(fp,sprintf(' * @param %s %s\n', APM.name{j}, APM.desc{j}));
        end
        fprintf(fp,' * @return length of the message in bytes (excluding serial stream start sign)\n');
        fprintf(fp,' */\n');
        %% Function Declaration
        fprintf(fp,sprintf('static inline uint16_t mavlink_msg_%s_pack_chan(\n',lower(Mess(i).name)));
        fprintf(fp,'\t uint8_t system_id\n\t,uint8_t component_id\n\t,uint8_t chan\n\t,mavlink_message_t* msg\n');
        for j=1:N
            %if ((ID~=0) || ((ID==0)&&(j<N))) %% Heartbeat Message special processing
                if (APM.array{j} > 0)
                    fprintf(fp,sprintf('\t,const %s* %s\n', APM.type{j}, APM.name{j}));
                else
                    fprintf(fp,sprintf('\t,%s %s\n', APM.type{j}, APM.name{j}));
                end
            %end
        end
        fprintf(fp,'\t)\n{\n');
        %% Function Body
        fprintf(fp,'#if MAVLINK_NEED_BYTE_SWAP || !MAVLINK_ALIGNED_FIELDS\n');
        fprintf(fp,sprintf('\tchar buf[MAVLINK_MSG_ID_%s_LEN];\n',Mess(i).name));
%         voff = 0;
        for j=1:N
            %if ((ID==0) && (j==N)) %% Heartbeat Message special processing
            %    fprintf(fp,sprintf('\t_mav_put_%s(buf, %d, 2);\n',APM.type{j},voff));
            %else
                if (APM.array{j} > 0)
                    if (SWAP)
                        fprintf(fp,sprintf('\t_mav_put_%s_array(buf, %d, %s, %d);\n',APM.type{IDX(j)},APM.soffset(IDX(j)),APM.name{IDX(j)},APM.array{IDX(j)}));
                    else
                        fprintf(fp,sprintf('\t_mav_put_%s_array(buf, %d, %s, %d);\n',APM.type{j}     ,APM.uoffset(j)     ,APM.name{j}     ,APM.array{j}));
                    end
                else
                    if (SWAP)
                        fprintf(fp,sprintf('\t_mav_put_%s(buf, %d, %s);\n',APM.type{IDX(j)},APM.soffset(IDX(j)),APM.name{IDX(j)}));
                    else
                        fprintf(fp,sprintf('\t_mav_put_%s(buf, %d, %s);\n',APM.type{j}     ,APM.uoffset(j)     ,APM.name{j}));
                    end
                end
            %end
%             if (SWAP)
%                 voff = voff + APM.byte{IDX(j)};
%             else
%                 voff = voff + APM.byte{j};
%             end
        end

        switch (VERSION)
            case 0.9
                fprintf(fp,sprintf('\n\tmemcpy(_MAV_PAYLOAD(msg), buf, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name));
            case 1.0
                fprintf(fp,sprintf('\n\tmemcpy(_MAV_PAYLOAD_NON_CONST(msg), buf, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name));
            otherwise
                disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
                return
        end
        fprintf(fp,'#else\n');
        fprintf(fp,sprintf('\tmavlink_%s_t packet;\n',lower(Mess(i).name)));
        for j=1:N
            %if ((ID==0) && (j==N)) %% Heartbeat Message special processing
            %    fprintf(fp,sprintf('\tpacket.%s = 2;\n',APM.name{j}));
            %else
                if (APM.array{j} > 0)
                    fprintf(fp,sprintf('\tmav_array_memcpy(packet.%s, %s, sizeof(%s)*%d);\n',APM.name{j},APM.name{j},APM.type{j},APM.array{j}));
                else
                    fprintf(fp,sprintf('\tpacket.%s = %s;\n',APM.name{j},APM.name{j}));
                end
            %end
        end

        switch (VERSION)
            case 0.9
                fprintf(fp,sprintf('\n\tmemcpy(_MAV_PAYLOAD(msg), &packet, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name));
            case 1.0
                fprintf(fp,sprintf('\n\tmemcpy(_MAV_PAYLOAD_NON_CONST(msg), &packet, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name));
            otherwise
                disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
                return
        end
        fprintf(fp,'#endif\n');

        fprintf(fp,sprintf('\n\tmsg->msgid = MAVLINK_MSG_ID_%s;\n',Mess(i).name));
        switch (VERSION)
            case 0.9
                fprintf(fp,sprintf('\treturn mavlink_finalize_message_chan(msg, system_id, component_id, chan, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name));
            case 1.0
                fprintf(fp,'#if MAVLINK_CRC_EXTRA\n');
                fprintf(fp,sprintf('\treturn mavlink_finalize_message_chan(msg, system_id, component_id, chan, MAVLINK_MSG_ID_%s_LEN, MAVLINK_MSG_ID_%s_CRC);\n',Mess(i).name,Mess(i).name));
                fprintf(fp,'#else\n');
                fprintf(fp,sprintf('\treturn mavlink_finalize_message_chan(msg, system_id, component_id, chan, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name));
                fprintf(fp,'#endif\n');
            otherwise
                disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
                return
        end
        fprintf(fp,'}\n\n');
        
        %% Function Header - mavlink_msg_xxx_encode
        fprintf(fp,'/**\n');
        fprintf(fp,sprintf(' * @brief Encode a %s struct into a message\n',lower(Mess(i).name)));
        fprintf(fp,' *\n');
        fprintf(fp,' * @param system_id ID of this system\n');
        fprintf(fp,' * @param component_id ID of this component (e.g. 200 for IMU)\n');
        fprintf(fp,' * @param msg The MAVLink message to compress the data into\n');
        fprintf(fp,' * @param %s C-struct to read the message contents from\n',lower(Mess(i).name));
        fprintf(fp,' */\n');
        %% Function Declaration
        fprintf(fp,sprintf('static inline uint16_t mavlink_msg_%s_encode(\n',lower(Mess(i).name)));
        fprintf(fp,'\t uint8_t system_id\n\t,uint8_t component_id\n\t,mavlink_message_t* msg\n');
        fprintf(fp,sprintf('\t,const mavlink_%s_t* %s\n',lower(Mess(i).name),lower(Mess(i).name)));
        fprintf(fp,'\t)\n{\n');
        %% Function Body
        fprintf(fp,sprintf('\treturn mavlink_msg_%s_pack(\n',lower(Mess(i).name)));
        fprintf(fp,'\t system_id\n\t,component_id\n\t,msg\n');
        for j=1:N
            %if ((ID~=0) || ((ID==0)&&(j<N))) %% Heartbeat Message special processing
                fprintf(fp,sprintf('\t,%s->%s\n',lower(Mess(i).name),APM.name{j}));
            %end
        end
        fprintf(fp,'\t);\n}\n\n');

        %% Function Header - mavlink_msg_xxx_encode_chan
        if (VERSION == 1.0)
            fprintf(fp,'/**\n');
            fprintf(fp,sprintf(' * @brief Encode a %s struct on a channel\n',lower(Mess(i).name)));
            fprintf(fp,' *\n');
            fprintf(fp,' * @param system_id ID of this system\n');
            fprintf(fp,' * @param component_id ID of this component (e.g. 200 for IMU)\n');
            fprintf(fp,' * @param chan The MAVLink channel this message will be sent over\n');
            fprintf(fp,' * @param msg The MAVLink message to compress the data into\n');
            fprintf(fp,' * @param %s C-struct to read the message contents from\n',lower(Mess(i).name));
            fprintf(fp,' */\n');
            %% Function Declaration
            fprintf(fp,sprintf('static inline uint16_t mavlink_msg_%s_encode_chan(\n',lower(Mess(i).name)));
            fprintf(fp,'\t uint8_t system_id\n\t,uint8_t component_id\n\t,uint8_t chan\n\t,mavlink_message_t* msg\n');
            fprintf(fp,sprintf('\t,const mavlink_%s_t* %s\n',lower(Mess(i).name),lower(Mess(i).name)));
            fprintf(fp,'\t)\n{\n');
            %% Function Body
            fprintf(fp,sprintf('\treturn mavlink_msg_%s_pack_chan(\n',lower(Mess(i).name)));
            fprintf(fp,'\t system_id\n\t,component_id\n\t,chan\n\t,msg\n');
            for j=1:N
                %if ((ID~=0) || ((ID==0)&&(j<N))) %% Heartbeat Message special processing
                    fprintf(fp,sprintf('\t,%s->%s\n',lower(Mess(i).name),APM.name{j}));
                %end
            end
            fprintf(fp,'\t);\n}\n\n');
        end
        
        %% Function Header - mavlink_msg_xxx_send
        fprintf(fp,'/**\n');
        fprintf(fp,sprintf(' * @brief Send a %s message\n',lower(Mess(i).name)));
        fprintf(fp,' * @param chan The MAVLink channel to send this message\n');
        fprintf(fp,' *\n');
        for j=1:N
            fprintf(fp,sprintf(' * @param %s %s\n', APM.name{j}, APM.desc{j}));
        end
        fprintf(fp,' */\n');
        %% Function Declaration
        fprintf(fp,'#ifdef MAVLINK_USE_CONVENIENCE_FUNCTIONS\n\n');
        fprintf(fp,sprintf('static inline void mavlink_msg_%s_send(\n',lower(Mess(i).name)));
        fprintf(fp,'\t mavlink_channel_t chan\n');
        for j=1:N
            %if ((ID~=0) || ((ID==0)&&(j<N))) %% Heartbeat Message special processing
                if (APM.array{j} > 0)
                    fprintf(fp,sprintf('\t,const %s* %s\n', APM.type{j}, APM.name{j}));
                else
                    fprintf(fp,sprintf('\t,%s %s\n', APM.type{j}, APM.name{j}));
                end
            %end
        end
        fprintf(fp,'\t)\n{\n');
        %% Function Body
        fprintf(fp,'#if MAVLINK_NEED_BYTE_SWAP || !MAVLINK_ALIGNED_FIELDS\n');
        fprintf(fp,sprintf('\tchar buf[MAVLINK_MSG_ID_%s_LEN];\n',Mess(i).name));
%         voff = 0;
        for j=1:N
            %if ((ID==0) && (j==N)) %% Heartbeat Message special processing
            %    fprintf(fp,sprintf('\t_mav_put_%s(buf, %d, 2);\n',APM.type{j},voff));
            %else
                if (APM.array{j} > 0)
                    if (SWAP)
                        fprintf(fp,sprintf('\t_mav_put_%s_array(buf, %d, %s, %d);\n',APM.type{IDX(j)},APM.soffset(IDX(j)),APM.name{IDX(j)},APM.array{IDX(j)}));
                    else
                        fprintf(fp,sprintf('\t_mav_put_%s_array(buf, %d, %s, %d);\n',APM.type{j}     ,APM.uoffset(j)     ,APM.name{j}     ,APM.array{j}));
                    end
                else
                    if (SWAP)
                        fprintf(fp,sprintf('\t_mav_put_%s(buf, %d, %s);\n',APM.type{IDX(j)},APM.soffset(IDX(j)),APM.name{IDX(j)}));
                    else
                        fprintf(fp,sprintf('\t_mav_put_%s(buf, %d, %s);\n',APM.type{j}     ,APM.uoffset(j)     ,APM.name{j}));
                    end
                end
            %end
%             if (SWAP)
%                 voff = voff + APM.byte{IDX(j)};
%             else
%                 voff = voff + APM.byte{j};
%             end
        end

        switch (VERSION)
            case 0.9
                fprintf(fp,sprintf('\n\t_mav_finalize_message_chan_send(chan, MAVLINK_MSG_ID_%s, buf, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name,Mess(i).name));
            case 1.0
                fprintf(fp,'#if MAVLINK_CRC_EXTRA\n');
                fprintf(fp,sprintf('\n\t_mav_finalize_message_chan_send(chan, MAVLINK_MSG_ID_%s, buf, MAVLINK_MSG_ID_%s_LEN, MAVLINK_MSG_ID_%s_CRC);\n',Mess(i).name,Mess(i).name,Mess(i).name));
                fprintf(fp,'#else\n');
                fprintf(fp,sprintf('\n\t_mav_finalize_message_chan_send(chan, MAVLINK_MSG_ID_%s, buf, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name,Mess(i).name));
                fprintf(fp,'#endif\n');
            otherwise
                disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
                return
        end
        fprintf(fp,'#else\n');
        fprintf(fp,sprintf('\tmavlink_%s_t packet;\n',lower(Mess(i).name)));
        for j=1:N
            %if ((ID==0) && (j==N)) %% Heartbeat Message special processing
            %    fprintf(fp,sprintf('\tpacket.%s = 2;\n',APM.name{j}));
            %else
                if (APM.array{j} > 0)
                    fprintf(fp,sprintf('\tmav_array_memcpy(packet.%s, %s, sizeof(%s)*%d);\n',APM.name{j},APM.name{j},APM.type{j},APM.array{j}));
                else
                    fprintf(fp,sprintf('\tpacket.%s = %s;\n',APM.name{j},APM.name{j}));
                end
            %end
        end

        switch (VERSION)
            case 0.9
                fprintf(fp,sprintf('\n\t_mav_finalize_message_chan_send(chan, MAVLINK_MSG_ID_%s, (const char*)&packet, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name,Mess(i).name));
            case 1.0
                fprintf(fp,'#if MAVLINK_CRC_EXTRA\n');
                fprintf(fp,sprintf('\n\t_mav_finalize_message_chan_send(chan, MAVLINK_MSG_ID_%s, (const char*)&packet, MAVLINK_MSG_ID_%s_LEN, MAVLINK_MSG_ID_%s_CRC);\n',Mess(i).name,Mess(i).name,Mess(i).name));
                fprintf(fp,'#else\n');
                fprintf(fp,sprintf('\n\t_mav_finalize_message_chan_send(chan, MAVLINK_MSG_ID_%s, (const char*)&packet, MAVLINK_MSG_ID_%s_LEN);\n',Mess(i).name,Mess(i).name));
                fprintf(fp,'#endif\n');
            otherwise
                disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
                return
        end
        fprintf(fp,'#endif\n');
        fprintf(fp,'}\n\n');
        fprintf(fp,'#endif // MAVLINK_USE_CONVENIENCE_FUNCTIONS\n\n');
        
        %% Function Header - MESSAGE xxx UNPACKING
        fprintf(fp,sprintf('// MESSAGE %s UNPACKING\n\n',Mess(i).name));
%         voff = 0;
        for j=1:N
            fprintf(fp,'/**\n');
            fprintf(fp,sprintf(' * @brief Get field %s from %s message\n',APM.name{j},lower(Mess(i).name)));
            fprintf(fp,' *\n');
            fprintf(fp,sprintf(' * @return %s\n',APM.desc{j}));
            fprintf(fp,' */\n');
            if (APM.array{j} > 0)
                fprintf(fp,sprintf('static inline %s mavlink_msg_%s_get_%s(const mavlink_message_t* msg, %s* %s)\n',APM.type{j},lower(Mess(i).name),APM.name{j},APM.type{j},APM.name{j}));
                fprintf(fp,'{\n');
                fprintf(fp,sprintf('	return _MAV_RETURN_%s_array(msg,%s,%d,%d);\n',APM.type{j},APM.name{j},APM.array{j},APM.uoffset(j)));
                fprintf(fp,'}\n\n');
            else
                fprintf(fp,sprintf('static inline %s mavlink_msg_%s_get_%s(const mavlink_message_t* msg)\n',APM.type{j},lower(Mess(i).name),APM.name{j}));
                fprintf(fp,'{\n');
                fprintf(fp,sprintf('	return _MAV_RETURN_%s(msg,%d);\n',APM.type{j},APM.uoffset(j)));
                fprintf(fp,'}\n\n');
            end
%             if (SWAP)
%                 voff = voff + APM.byte{IDX(j)};
%             else
%                 voff = voff + APM.byte{j};
%             end
        end

        %% Function Header - mavlink_msg_xxx_decode
        fprintf(fp,'/**\n');
        fprintf(fp,sprintf(' * @brief Decode a %s message into a struct\n',lower(Mess(i).name)));
        fprintf(fp,' *\n');
        fprintf(fp,' * @param msg The message to decode\n');
        fprintf(fp,sprintf(' * @param %s C-struct to decode the message contents into\n',lower(Mess(i).name)));
        fprintf(fp,' */\n');
        fprintf(fp,sprintf('static inline void mavlink_msg_%s_decode(const mavlink_message_t* msg, mavlink_%s_t* %s)\n',lower(Mess(i).name),lower(Mess(i).name),lower(Mess(i).name)));
        fprintf(fp,'{\n');
        fprintf(fp,'#if MAVLINK_NEED_BYTE_SWAP\n');
        for j=1:N
            if (APM.array{j} > 0)
                fprintf(fp,sprintf('	mavlink_msg_%s_get_%s(msg, %s->%s);\n',lower(Mess(i).name),APM.name{j},lower(Mess(i).name),APM.name{j}));
            else
                fprintf(fp,sprintf('	%s->%s = mavlink_msg_%s_get_%s(msg);\n',lower(Mess(i).name),APM.name{j},lower(Mess(i).name),APM.name{j}));
            end
        end
        fprintf(fp,'#else\n');
        fprintf(fp,sprintf('	memcpy(%s, _MAV_PAYLOAD(msg), MAVLINK_MSG_ID_%s_LEN);\n',lower(Mess(i).name),Mess(i).name));
        fprintf(fp,'#endif\n');
        fprintf(fp,'}\n');

        %% Function End
        %%        
        fclose(fp); fp = [];
    end   % For each MavLink message
       
    %% End Messages
    
    %% Create supporting files
    newf = sprintf('%s\\common_MsgLength.h',dDir);
    mif = fopen(newf,'w');
    fprintf(mif,'/*\n');
    fprintf(mif,'                                {');
    for i=1:256
        if (i==1)
            fprintf(mif,sprintf('%3d',i-1));
        else
            fprintf(mif,sprintf(',%3d',i-1));
        end
    end
    fprintf(mif,'}\n');
	fprintf(mif,'#define MAVLINK_MESSAGE_LENGTHS {  3,  4,  8, 14,  8, 28,  3, 32,  0,  2,  3,  2,  2,  0,  0,  0,  0,  0,  0,  0, 19,  2, 23, 21,  0, 37, 26,101, 26, 16, 32, 32, 37, 32, 11, 17, 17, 16, 18, 36,  4,  4,  2,  2,  4,  2,  2,  3, 14, 12, 18, 16,  8, 27, 25, 18, 18, 24, 24,  0,  0,  0, 26, 16, 36,  5,  6, 56, 26, 21, 18,  0,  0, 18, 20, 20,  8,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 18,  0,  0,  0,  0,  0,  0,  0,  0,  0, 40, 72,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 36,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 30, 14, 14, 51,  5}\n');
	fprintf(mif,'*/\n');
    fprintf(mif,'#define MAVLINK_MESSAGE_LENGTHS {');
    for i=1:256
        if (i==1)
            fprintf(mif,sprintf('%3d',MAVLINK_MESSAGE_LENGTHS(i)));
        else
            fprintf(mif,sprintf(',%3d',MAVLINK_MESSAGE_LENGTHS(i)));
        end
    end
    fprintf(mif,'}\n');
    
    fprintf(mif,'#define MAVLINK_MESSAGE_INFO {');
    for i=1:256
        if (i==1)
            fprintf(mif,sprintf('%s',MAVLINK_MESSAGE_INFO{i}));
        else
            fprintf(mif,sprintf(',%s',MAVLINK_MESSAGE_INFO{i}));
        end
    end
    fprintf(mif,'}\n');
    fclose(mif); mif = [];
    
    %% Include file Array
    %% File to contain list mavlink message include files
%     Mess = [parseXML('slvMessage.xml'); parseXML('common_APM_2.27.xml')];
    N = length(Mess);
    newf = sprintf('%s\\common_include.h',dDir);
    mif = fopen(newf,'w');
    for i=1:N
        fprintf(mif,sprintf('#include "./mavlink_msg_%s.h"\n',lower(Mess(i).name)));
    end
    fclose(mif); mif = [];
    
    switch (VERSION)
        case 0.9
            disp('Done AP code for MavLink 0.9')
        case 1.0
            disp('Done AP code for MavLink 1.0')
        otherwise
            disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
            return
    end
return

%% Generate GroundStation Code based on XML data
function genGSCode(Mess)
    global SWAP;
    global VERSION;
    if (SWAP)
        disp('Offset SWAPPING')
    end
    %dDir = 'G:\\ArduRepo\\ArdupilotMegaPlanner';
    dDir = 'ArdupilotMegaPlanner';
    if (isempty(dir(dDir)))
        mkdir(dDir);
    end
    switch (VERSION)
        case 0.9
            newf = sprintf('%s\\MAVLinkTypes0.9_patch.cs',dDir);
        case 1.0
            newf = sprintf('%s\\MAVLinkTypes1.0_patch.cs',dDir);
        otherwise
            disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
            return
    end
    fp = fopen(newf,'w');

    %% Generate Message Length Array
    K = length(Mess);
    MAVLINK_MESSAGE_LENGTHS = zeros(1,256);
    MAVLINK_MESSAGE_CRC = zeros(1,256);
    MAVLINK_MESSAGE_INFO = cell(1,256);
    for i=1:256
        MAVLINK_MESSAGE_INFO{i} = sprintf('\t\t\tnull,\t\t\t //message %d\n',i-1);
    end
    
    for i=1:K
        ID = sscanf(Mess(i).id,'%d');
        packetSize = sum(cell2mat(Mess(i).fields.byte));
        MAVLINK_MESSAGE_LENGTHS(ID+1) = packetSize;
    end
    fprintf(fp,'    //                                                 {');
    for i=1:256
        if (i==1)
            fprintf(fp,sprintf('%3d',i-1));
        else
            fprintf(fp,sprintf(',%3d',i-1));
        end
    end
    fprintf(fp,'}\n');
    switch (VERSION)
        case 0.9
            fprintf(fp,'    public byte[] MAVLINK_MESSAGE_LENGTHS = new byte[] {');
        case 1.0
            fprintf(fp,'    public static readonly byte[] MAVLINK_MESSAGE_LENGTHS = new byte[] {');
        otherwise
            disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
            return
    end
    for i=1:256
        if (i==1)
            fprintf(fp,sprintf('%3d',MAVLINK_MESSAGE_LENGTHS(i)));
        else
            fprintf(fp,sprintf(',%3d',MAVLINK_MESSAGE_LENGTHS(i)));
        end
    end
    fprintf(fp,'};\n');
    
    %%
    for i=1:K   % For each MavLink message
        N = size(Mess(i).fields.name,1);
        ID = sscanf(Mess(i).id,'%d');
        packetSize = sum(cell2mat(Mess(i).fields.byte));
        
        %% Message Length Array
        MAVLINK_MESSAGE_LENGTHS(ID+1) = packetSize;
        switch (VERSION)
            case 0.9
                MAVLINK_MESSAGE_INFO{ID+1} = sprintf('\t\t\ttypeof( __mavlink_%s_t),\t\t\t// message %d\n',lower(Mess(i).name),ID);
            case 1.0
                MAVLINK_MESSAGE_INFO{ID+1} = sprintf('\t\t\ttypeof( mavlink_%s_t),\t\t\t// message %d\n',lower(Mess(i).name),ID);
            otherwise
                disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
                return
        end
        
        %% Do MavLink to APM types substitution
        GCS.name = Mess(i).fields.name;
        GCS.type = Mess(i).fields.gcsType;
        GCS.byte = Mess(i).fields.gcsByte;
        GCS.desc = Mess(i).fields.desc;
        GCS.array = Mess(i).fields.Array;
        
        %% Function Header
        switch (VERSION)
            case 0.9
                fprintf(fp,sprintf('\tpublic const byte MAVLINK_MSG_ID_%s = %d;\n',Mess(i).name,ID));
                fprintf(fp,sprintf('\tpublic const byte MAVLINK_MSG_ID_%s_LEN = %d;\n',Mess(i).name,packetSize));
                fprintf(fp,sprintf('\t[StructLayout(LayoutKind.Sequential,Pack=1)]\n'));
                fprintf(fp,sprintf('\tpublic struct __mavlink_%s_t\n',lower(Mess(i).name)));
                fprintf(fp,sprintf('\t{\n'));
                for j=1:N
                    if (GCS.array{j} > 0)
                        fprintf(fp,'\t\t[MarshalAs(\n\t\t\tUnmanagedType.ByValArray,\n\t\t\tSizeConst=%d)]\n',GCS.array{j});
                        fprintf(fp,'\t\tpublic %s[] %s; /// %s\n',GCS.type{j}, GCS.name{j}, GCS.desc{j});
                    else
                        fprintf(fp,'\t\tpublic %s %s; /// %s\n',GCS.type{j}, GCS.name{j}, GCS.desc{j});
                    end
                end
                fprintf(fp,sprintf('\t};\n\n'));
            case 1.0
                fprintf(fp,sprintf('\t[StructLayout(LayoutKind.Sequential,Pack=1, Size=%d)]\n',packetSize));
                fprintf(fp,sprintf('\tpublic struct mavlink_%s_t\n',lower(Mess(i).name)));
                fprintf(fp,sprintf('\t{\n'));
                for j=1:N
                    if (GCS.array{j})
                        fprintf(fp,'\t\t[MarshalAs(\n\t\t\tUnmanagedType.ByValArray,\n\t\t\tSizeConst=%d)]\n',GCS.array{j});
                        fprintf(fp,'\t\tpublic %s[] %s; /// %s\n',GCS.type{j}, GCS.name{j}, GCS.desc{j});
                    else
                        fprintf(fp,'\t\tpublic %s %s; /// %s\n',GCS.type{j}, GCS.name{j}, GCS.desc{j});
                    end
                end
                fprintf(fp,sprintf('\t};\n\n'));
            otherwise
                disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
                return
        end
    end

    switch (VERSION)
        case 0.9
            fprintf(fp,'\tType[] mavstructs = new Type[] {\n');
        case 1.0
            fprintf(fp,'\tpublic static readonly Type[] MAVLINK_MESSAGE_INFO = new Type[] {\n');
        otherwise
            disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
            return
    end
    for i=1:256
        fprintf(fp,MAVLINK_MESSAGE_INFO{i});
    end
    fprintf(fp,'\t};\n');

    fclose(fp); fp = [];
    
    switch (VERSION)
        case 0.9
            disp('Done GCS code for MavLink 0.9')
        case 1.0
            disp('Done GCS code for MavLink 1.0')
        otherwise
            disp('Invalid MavLink version: valid cases are 0.9 and 1.0');
            return
    end
return
%%
function Mess = parseXML(file)
    xDoc = xmlread(file);
    allEnums = xDoc.getElementsByTagName('enum');
    allMessages = xDoc.getElementsByTagName('message');
    K = allMessages.getLength;
    for k = 0:K-1       % Note that the item list index is zero-based.
        dMess = allMessages.item(k);
        dAtt = dMess.getAttributes;
        attrib = dAtt.item(1);
        Mess(k+1).name = char(attrib.getValue);
        attrib = dAtt.item(0);
        Mess(k+1).id   = char(attrib.getValue);
        dList = dMess.getElementsByTagName('description');
        if (dList.getLength > 0)
            Mess(k+1).fdesc = cleanupDesc(char(dList.item(0).getFirstChild.getData),0);
            Mess(k+1).cdesc = cleanupDesc(char(dList.item(0).getFirstChild.getData),1);
        else
            Mess(k+1).fdesc = '% No Description provided\n';
            Mess(k+1).cdesc = '% No Description provided\n';
        end

        fList = allMessages.item(k).getElementsByTagName('field');
        N = fList.getLength;
        allocCell = cell(N, 1);
        Mess(k+1).fields.name = allocCell;
        Mess(k+1).fields.type = allocCell;
        Mess(k+1).fields.desc = allocCell;
        Mess(k+1).fields.byte = allocCell;

        for n=0:N-1
            dField = fList.item(n);
            dAtt = dField.getAttributes;
            s = 0;
            while (~isempty(dAtt.item(s)))
                attrib = dAtt.item(s);
                Mess(k+1).fields.(char(attrib.getName)){n+1} = char(attrib.getValue);
                s = s+1;
            end
            Mess(k+1).fields.desc{n+1} = cleanupField(char(dField.getFirstChild.getData));
            Mess(k+1).fields = parseType(Mess(k+1).fields,n+1);
        end
        Mess(k+1).fields = MavLinkSort(Mess(k+1).fields);
        if (Mess(k+1).fields.needSwap)
            fprintf('%s message needs swap\n',Mess(k+1).name);
        end
    end   
    Mess = Mess(:);
return

%%
function Mess = MavLinkSort(Mess)
    %[~, Mess.idx] = sort(cell2mat(Mess.byte),'descend');
    [junk, Mess.idx] = sort(cell2mat(Mess.byte),'descend');
    N = length(Mess.idx);
%     Mess.soffset = [0; cumsum(cell2mat(Mess.byte(Mess.idx(1:N-1))))];
%     Mess.offset  = [0; cumsum(cell2mat(Mess.byte(1:N-1)))];
%     Mess.poffset(Mess.idx) = Mess.soffset;
%     Mess.poffset = Mess.poffset(:);
%     disp([Mess.soffset Mess.offset Mess.poffset])
    Mess.soffset = [0; cumsum(cell2mat(Mess.byte(Mess.idx(1:N-1))))];
    Mess.soffset(Mess.idx) = Mess.soffset;
    Mess.uoffset  = [0; cumsum(cell2mat(Mess.byte(1:N-1)))];
    Mess.needSwap = ~all(Mess.soffset==Mess.uoffset);
%     disp([Mess.soffset Mess.uoffset])
return

%%
function str = cleanupDesc(dstr,indentFlag)
    if (indentFlag), indent = '\t\t\t'; c=' '; else indent = ''; c='~ '; end
 
    tf = isstrprop(dstr, 'cntrl');
    dstr(tf) = ' ';
    idx = strfind(dstr,'%');
    if ~isempty(idx)
        N = length(idx);
        nstr = dstr;
        for i=1:N
            nstr = [nstr(1:idx(i)) '%' nstr(idx(i)+1:end)];
            idx = idx+1;
        end
        dstr = nstr;
    end
    idx = find(isstrprop(dstr, 'wspace'));
    ldx = find(diff(mod(idx,80))<0)+1;
    list = reshape(sort([1 idx(ldx) idx(ldx)+1 length(dstr)]),2,[])';
    N = size(list,1);
    nstr = ['%%' c dstr(list(1,1):list(1,2)) '\n'];
    for i=2:N
        nstr = [nstr indent '%%%%' c dstr(list(i,1):list(i,2)) '\n'];
    end
    str = [indent '%%' nstr];
return

%%
function str = cleanupField(dstr)
    tf = isstrprop(dstr, 'cntrl');
    dstr(tf) = ' ';
    idx = strfind(dstr,'%');
    if ~isempty(idx)
        N = length(idx);
        nstr = dstr;
        for i=1:N
            nstr = [nstr(1:idx(i)) '%' nstr(idx(i)+1:end)];
            idx = idx+1;
        end
        dstr = nstr;
    end
    str = dstr;
return

%%
function fields = parseType(fields,n)
    if (isempty(fields.type{n}))
        fields.type{n} = 'NONE';
        fields.byte{n} = 0;
        return
    end

    mult = 1;
    udx = strfind(fields.type{n},'_');
    odx = strfind(fields.type{n},'[');
    cdx = strfind(fields.type{n},']');
    if ~isempty(udx)
        ttype = fields.type{n}(1:udx(1)-1);
    else
        if ~isempty(odx)
            ttype = fields.type{n}(1:odx-1);
        else
            ttype = fields.type{n};
        end
    end
    if (~isempty(odx) && ~isempty(cdx))
        mult = sscanf(fields.type{n}(odx+1:cdx-1),'%d');
        fields.Array{n} = mult;
        %% debug statement to show declaration of arrays
        %disp([fields.name{n} ' is of type: ' fields.type{n}])
    else
        fields.Array{n} = 0;
    end
    
%     if (isempty(ttype))
%         fields.type{n} = fields.type{n};
%     end
    
    switch(ttype)
		case 'int8'
			fields.byte{n}     = 1; %mult;
			fields.matType{n}  = 'int8';
			fields.matByte{n}  = mult;
			fields.javaType{n} = 'byte';
			fields.javaByte{n} = mult;
			fields.apmType{n}  = 'int8_t';
			fields.apmByte{n}  = mult;
			fields.gcsType{n}  = 'byte';
			fields.gcsByte{n}  = mult;
		case 'int16'
			fields.byte{n}     = 2; %*mult;
			fields.matType{n}  = 'int16';
			fields.matByte{n}  = 2*mult;
			fields.javaType{n} = 'short';
			fields.javaByte{n} = 2*mult;
			fields.apmType{n}  = 'int16_t';
			fields.apmByte{n}  = 2*mult;
			fields.gcsType{n}  = 'short';
			fields.gcsByte{n}  = 2*mult;
		case 'int32'
			fields.byte{n}     = 4; %*mult;
			fields.matType{n}  = 'int32';
			fields.matByte{n}  = 4*mult;
			fields.javaType{n} = 'int';
			fields.javaByte{n} = 4*mult;
			fields.apmType{n}  = 'int32_t';
			fields.apmByte{n}  = 4*mult;
			fields.gcsType{n}  = 'int';
			fields.gcsByte{n}  = 4*mult;
		case 'uint8'
			fields.byte{n}     = 1; %mult;
			fields.matType{n}  = 'uint8';
			fields.matByte{n}  = mult;
			fields.javaType{n} = 'short';
			fields.javaByte{n} = 2*mult;
			fields.apmType{n}  = 'uint8_t';
			fields.apmByte{n}  = mult;
			fields.gcsType{n}  = 'byte';
			fields.gcsByte{n}  = mult;
		case 'char'
			fields.byte{n}     = 1; %mult;
			fields.matType{n}  = 'uint8';
			fields.matByte{n}  = mult;
			fields.javaType{n} = 'byte';
			fields.javaByte{n} = mult;
			fields.apmType{n}  = 'char';
			fields.apmByte{n}  = mult;
			fields.gcsType{n}  = 'byte';
			fields.gcsByte{n}  = mult;
		case 'uint16'
			fields.byte{n}     = 2; %*mult;
			fields.matType{n}  = 'uint16';
			fields.matByte{n}  = 2*mult;
			fields.javaType{n} = 'int';
			fields.javaByte{n} = 4*mult;
			fields.apmType{n}  = 'uint16_t';
			fields.apmByte{n}  = 2*mult;
			fields.gcsType{n}  = 'ushort';
			fields.gcsByte{n}  = 2*mult;
		case 'uint32'
			fields.byte{n}     = 4; %*mult;
			fields.matType{n}  = 'uint32';
			fields.matByte{n}  = 4*mult;
			fields.javaType{n} = 'long';
			fields.javaByte{n} = 8*mult;
			fields.apmType{n}  = 'uint32_t';
			fields.apmByte{n}  = 4*mult;
			fields.gcsType{n}  = 'uint';
			fields.gcsByte{n}  = 4*mult;
		case 'uint64'
			fields.byte{n}     = 8; %*mult;
			fields.matType{n}  = 'uint64';
			fields.matByte{n}  = 8*mult;
			fields.javaType{n} = 'long';
			fields.javaByte{n} = 8*mult;
			fields.apmType{n}  = 'uint64_t';
			fields.apmByte{n}  = 8*mult;
			fields.gcsType{n}  = 'ulong';
			fields.gcsByte{n}  = 8*mult;
		case 'float'
			fields.byte{n}     = 4; %*mult;
			fields.matType{n}  = 'single';
			fields.matByte{n}  = 4*mult;
			fields.javaType{n} = 'float';
			fields.javaByte{n} = 4*mult;
			fields.apmType{n}  = 'float';
			fields.apmByte{n}  = 4*mult;
			fields.gcsType{n}  = 'float';
			fields.gcsByte{n}  = 4*mult;
		case 'array'
			%fields.byte{n}     = 1; %mult;
			fields.byte{n}     = mult;
			fields.matType{n}  = 'uint8';
			fields.matByte{n}  = mult;
			fields.javaType{n} = 'byte';
			fields.javaByte{n} = mult;
			fields.apmType{n}  = 'uint8_t';
			fields.apmByte{n}  = mult;
			fields.gcsType{n}  = 'byte';
			fields.gcsByte{n}  = mult;
        otherwise
            fprintf('ERROR: Unknown Variable type: %s=>%s\n',fields.type{n},ttype)
    end
    
return

##### SOURCE END #####
--></body></html>